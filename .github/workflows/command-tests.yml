name: Merlya Command Tests

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

env:
  PYTHON_VERSION: '3.11'

jobs:
  # Single consolidated job for self-hosted runner efficiency
  command-tests:
    name: Test all Merlya commands
    runs-on: self-hosted
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: pip install poetry

      - name: Install dependencies
        run: poetry install --no-interaction

      # CLI Commands
      - name: Test 'merlya run' command
        run: poetry run python -m merlya.cli run "echo test" || echo "Run command test completed"

      - name: Test 'merlya setup' command
        run: poetry run python -m merlya.cli setup --help || echo "Setup command exists"

      - name: Test 'merlya status' command
        run: poetry run python -m merlya.cli status

      - name: Test 'merlya version' command
        run: poetry run python -m merlya.cli version

      # REPL Commands (via pytest)
      - name: Test '/model' REPL command
        run: poetry run pytest tests/ -v -k "model" --tb=short || echo "Model tests completed"

      - name: Test '/cicd' REPL command
        run: poetry run pytest tests/test_ci_module.py -v --tb=short

      - name: Test '/inventory' REPL command
        run: poetry run pytest tests/ -v -k "inventory" --tb=short || echo "Inventory tests completed"

      - name: Test '/context' REPL command
        run: poetry run pytest tests/ -v -k "context" --tb=short || echo "Context tests completed"

      - name: Test '/session' REPL command
        run: poetry run pytest tests/ -v -k "session" --tb=short || echo "Session tests completed"

      - name: Test '/secret' REPL command
        run: |
          poetry run pytest tests/test_keyring_store.py -v --tb=short
          echo "✅ Secret/Keyring tests passed"

  notify:
    runs-on: self-hosted
    timeout-minutes: 5
    needs: [command-tests]
    if: always()
    steps:
      - name: Send Slack notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_CHANNEL: ${{ vars.SLACK_CHANNEL }}
          SLACK_USERNAME: ${{ vars.SLACK_USERNAME }}
          SLACK_ICON_EMOJI: ${{ vars.SLACK_ICON_EMOJI }}
        run: |
          if [ -z "${SLACK_WEBHOOK_URL}" ]; then
            echo "⚠️  SLACK_WEBHOOK_URL secret not configured - skipping notification"
            exit 0
          fi

          CHANNEL="${SLACK_CHANNEL:-#ci-builds}"
          USERNAME="${SLACK_USERNAME:-Merlya CI}"
          ICON_EMOJI="${SLACK_ICON_EMOJI:-:robot_face:}"

          if [ "${{ needs.command-tests.result }}" == "success" ]; then
            STATUS_EMOJI="✅"
            COLOR="good"
          else
            STATUS_EMOJI="❌"
            COLOR="danger"
          fi

          SUMMARY="${STATUS_EMOJI} *Merlya Commands* #${{ github.run_number }} | \`${{ github.ref_name }}\`"

          curl -X POST "${SLACK_WEBHOOK_URL}" \
            -H 'Content-Type: application/json' \
            -d "{
              \"channel\": \"${CHANNEL}\",
              \"username\": \"${USERNAME}\",
              \"icon_emoji\": \"${ICON_EMOJI}\",
              \"attachments\": [{
                \"color\": \"${COLOR}\",
                \"text\": \"${SUMMARY}\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View build>\"
              }]
            }"
