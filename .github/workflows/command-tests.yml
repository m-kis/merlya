name: Merlya Command Tests

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

env:
  PYTHON_VERSION: '3.11'

jobs:
  # Job 1: CLI Commands
  cli-commands:
    name: Test CLI Commands
    runs-on: self-hosted
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: pip install poetry

      - name: Install dependencies
        run: poetry install --no-interaction

      # CLI Commands (use --help to avoid interactive prompts)
      - name: Test 'merlya run' command exists
        run: poetry run python -m merlya.cli run --help

      - name: Test 'merlya setup' command exists
        run: poetry run python -m merlya.cli setup --help

      - name: Test 'merlya status' command
        run: poetry run python -m merlya.cli status || echo "Status check completed"

      - name: Test 'merlya version' command
        run: poetry run python -m merlya.cli version

  # Job 2: REPL Commands (via pytest)
  repl-commands:
    name: Test REPL Commands
    runs-on: self-hosted
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: pip install poetry

      - name: Install dependencies
        run: poetry install --no-interaction

      - name: Test '/model' REPL command
        run: poetry run pytest tests/ -v -k "model" --tb=short

      - name: Test '/cicd' REPL command
        run: poetry run pytest tests/test_ci_module.py -v --tb=short

      - name: Test '/inventory' REPL command
        run: poetry run pytest tests/ -v -k "inventory" --tb=short

      - name: Test '/context' REPL command
        run: poetry run pytest tests/ -v -k "context" --tb=short

      - name: Test '/session' REPL command
        run: poetry run pytest tests/ -v -k "session" --tb=short

      - name: Test '/secret' REPL command
        run: poetry run pytest tests/test_keyring_store.py -v --tb=short

  notify:
    runs-on: self-hosted
    timeout-minutes: 5
    needs: [cli-commands, repl-commands]
    if: always()
    steps:
      - name: Send Slack notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_CHANNEL: ${{ vars.SLACK_CHANNEL }}
          SLACK_USERNAME: ${{ vars.SLACK_USERNAME }}
          SLACK_ICON_EMOJI: ${{ vars.SLACK_ICON_EMOJI }}
        run: |
          if [ -z "${SLACK_WEBHOOK_URL}" ]; then
            echo "⚠️  SLACK_WEBHOOK_URL secret not configured - skipping notification"
            exit 0
          fi

          CHANNEL="${SLACK_CHANNEL:-#ci-builds}"
          USERNAME="${SLACK_USERNAME:-Merlya CI}"
          ICON_EMOJI="${SLACK_ICON_EMOJI:-:robot_face:}"

          CLI_RESULT="${{ needs.cli-commands.result }}"
          REPL_RESULT="${{ needs.repl-commands.result }}"

          if [ "$CLI_RESULT" == "success" ] && [ "$REPL_RESULT" == "success" ]; then
            STATUS_EMOJI="✅"
            COLOR="good"
          else
            STATUS_EMOJI="❌"
            COLOR="danger"
          fi

          SUMMARY="${STATUS_EMOJI} *Merlya Commands* #${{ github.run_number }} | \`${{ github.ref_name }}\`"
          DETAILS="CLI: ${CLI_RESULT} | REPL: ${REPL_RESULT}"

          curl -X POST "${SLACK_WEBHOOK_URL}" \
            -H 'Content-Type: application/json' \
            -d "{
              \"channel\": \"${CHANNEL}\",
              \"username\": \"${USERNAME}\",
              \"icon_emoji\": \"${ICON_EMOJI}\",
              \"attachments\": [{
                \"color\": \"${COLOR}\",
                \"text\": \"${SUMMARY}\n${DETAILS}\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View build>\"
              }]
            }"
