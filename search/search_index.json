{"config":{"lang":["en","fr"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Home","text":""},{"location":"#merlya","title":"Merlya","text":"<p>AI-powered infrastructure assistant for DevOps and SRE teams.</p> <p>Merlya is a command-line tool that combines the power of LLMs with practical infrastructure management capabilities: SSH inventory, safe remote execution, diagnostics, and automation.</p>"},{"location":"#key-features","title":"Key Features","text":"<ul> <li> <p> Natural Language Interface</p> <p>Ask questions like \u201ccheck disk usage on @web-01\u201d or \u201ctriage this incident log\u201d.</p> </li> <li> <p> SSH Management</p> <p>Async SSH pool, jump hosts, connection testing, and inventory import/export.</p> </li> <li> <p> Local-First Routing + LLM Fallback</p> <p>Intent routing prefers local classifiers when available, with safe fallbacks.</p> </li> <li> <p> Secure by Design</p> <p>Secrets stored in the system keyring; inputs validated; consistent logging.</p> </li> </ul>"},{"location":"#quick-example","title":"Quick Example","text":"<pre><code>pip install merlya\n\n# Option A: let the first-run wizard guide you (recommended)\nmerlya\n\n# Option B: for CI/CD, provide API keys via env vars\nexport OPENAI_API_KEY=\"...\"\nmerlya run \"Check disk usage on @web-01\"\n</code></pre>"},{"location":"#documentation","title":"Documentation","text":"<ul> <li> <p> Getting Started</p> <ul> <li>Installation</li> <li>Quick Start</li> <li>Configuration</li> </ul> </li> <li> <p> Guides</p> <ul> <li>REPL Mode</li> <li>SSH Management</li> <li>LLM Providers</li> <li>Automation</li> </ul> </li> <li> <p> Reference</p> <ul> <li>CLI Reference</li> <li>Slash Commands</li> <li>Tools</li> <li>Configuration</li> </ul> </li> <li> <p> Architecture</p> <ul> <li>Overview</li> <li>Decisions (ADR)</li> </ul> </li> </ul> <p>Get Started  View on GitHub </p>"},{"location":"architecture/","title":"Architecture","text":""},{"location":"architecture/#project-structure","title":"Project Structure","text":"<pre><code>merlya/\n\u251c\u2500\u2500 agent/          # PydanticAI agent and tools\n\u251c\u2500\u2500 cli/            # CLI entry point\n\u251c\u2500\u2500 commands/       # Slash command system\n\u251c\u2500\u2500 config/         # Configuration management + policies\n\u2502   \u251c\u2500\u2500 loader.py   # Config loading\n\u2502   \u251c\u2500\u2500 models.py   # Pydantic config models\n\u2502   \u251c\u2500\u2500 tiers.py    # Tier configuration (model selection)\n\u2502   \u2514\u2500\u2500 policies.py # Policy management (guardrails)\n\u251c\u2500\u2500 core/           # Shared context and logging\n\u251c\u2500\u2500 health/         # Startup health checks\n\u251c\u2500\u2500 hosts/          # Host resolution\n\u251c\u2500\u2500 i18n/           # Internationalization (EN, FR)\n\u251c\u2500\u2500 mcp/            # MCP (Model Context Protocol) integration\n\u2502   \u2514\u2500\u2500 manager.py  # MCPManager (async-safe singleton)\n\u251c\u2500\u2500 parser/         # Input/output parsing service\n\u2502   \u251c\u2500\u2500 service.py  # ParserService (tier-based backend selection)\n\u2502   \u251c\u2500\u2500 models.py   # Pydantic models (IncidentInput, ParsedLog)\n\u2502   \u2514\u2500\u2500 backends/   # Heuristic and ONNX backends\n\u251c\u2500\u2500 persistence/    # SQLite database layer\n\u2502   \u251c\u2500\u2500 database.py # Async DB with migration locking\n\u2502   \u2514\u2500\u2500 repositories.py # Typed repositories\n\u251c\u2500\u2500 repl/           # Interactive console\n\u251c\u2500\u2500 router/         # Intent classification\n\u2502   \u251c\u2500\u2500 classifier.py # IntentRouter with fast/heavy path\n\u2502   \u2514\u2500\u2500 handler.py  # Request handler (fast path, skills, agent)\n\u251c\u2500\u2500 secrets/        # Keyring integration\n\u251c\u2500\u2500 security/       # Permission management + audit\n\u2502   \u251c\u2500\u2500 permissions.py # PermissionManager (password TTL, locking)\n\u2502   \u2514\u2500\u2500 audit.py    # AuditLogger\n\u251c\u2500\u2500 session/        # Session and context management\n\u2502   \u251c\u2500\u2500 manager.py  # SessionManager\n\u2502   \u251c\u2500\u2500 context_tier.py # ContextTierPredictor (auto tier detection)\n\u2502   \u2514\u2500\u2500 summarizer.py # Hybrid summarization (ONNX + LLM)\n\u251c\u2500\u2500 setup/          # First-run wizard\n\u251c\u2500\u2500 skills/         # Reusable workflow system\n\u2502   \u251c\u2500\u2500 registry.py # SkillRegistry singleton\n\u2502   \u251c\u2500\u2500 loader.py   # YAML skill loader\n\u2502   \u251c\u2500\u2500 executor.py # SkillExecutor\n\u2502   \u2514\u2500\u2500 builtin/    # Default skills (YAML)\n\u251c\u2500\u2500 ssh/            # SSH connection pool\n\u251c\u2500\u2500 subagents/      # Parallel execution system\n\u2502   \u251c\u2500\u2500 factory.py  # SubagentFactory\n\u2502   \u2514\u2500\u2500 orchestrator.py # asyncio.gather orchestration\n\u251c\u2500\u2500 tools/          # Tool implementations\n\u2502   \u251c\u2500\u2500 core/       # Core tools (ssh_execute, list_hosts)\n\u2502   \u251c\u2500\u2500 files/      # File operations\n\u2502   \u251c\u2500\u2500 system/     # System monitoring\n\u2502   \u251c\u2500\u2500 security/   # Security auditing\n\u2502   \u251c\u2500\u2500 web/        # Web search\n\u2502   \u251c\u2500\u2500 logs/       # Log store (raw log persistence)\n\u2502   \u2514\u2500\u2500 context/    # Context tools (host summaries)\n\u2514\u2500\u2500 ui/             # Console UI (Rich)\n</code></pre>"},{"location":"architecture/#core-components","title":"Core Components","text":""},{"location":"architecture/#1-agent-system-merlyaagent","title":"1. Agent System (<code>merlya/agent/</code>)","text":"<p>The agent is built on PydanticAI with a ReAct loop for reasoning and action.</p> <p>Key Classes: - <code>MerlyaAgent</code> - Main agent wrapper with conversation management - <code>AgentDependencies</code> - Dependency injection for tools - <code>AgentResponse</code> - Structured response (message, actions, suggestions)</p> <p>Features: - 120s timeout to prevent LLM hangs - Conversation persistence to SQLite - Tool registration via decorators</p>"},{"location":"architecture/#2-intent-router-merlyarouter","title":"2. Intent Router (<code>merlya/router/</code>)","text":"<p>Classifies user intent to determine mode and required tools.</p> <p>Classification Methods: 1. ONNX Embeddings - Local semantic classification (if available) 2. LLM Fallback - When confidence &lt; 0.7 3. Pattern Matching - Keyword-based fallback</p> <p>Agent Modes: - <code>DIAGNOSTIC</code> - Information gathering (check, monitor, analyze) - <code>REMEDIATION</code> - Actions (restart, deploy, fix) - <code>QUERY</code> - Questions (what, how, explain) - <code>CHAT</code> - General conversation</p> <p>RouterResult: <pre><code>@dataclass\nclass RouterResult:\n    mode: AgentMode\n    tools: list[str]           # [\"system\", \"files\"]\n    entities: dict             # {\"hosts\": [\"web01\"]}\n    confidence: float\n    jump_host: str | None      # Detected bastion\n    credentials_required: bool\n    elevation_required: bool\n</code></pre></p>"},{"location":"architecture/#3-ssh-pool-merlyassh","title":"3. SSH Pool (<code>merlya/ssh/</code>)","text":"<p>Manages SSH connections with pooling and authentication.</p> <p>Features: - Connection reuse (LRU eviction at 50 connections) - Jump host/bastion support via <code>via</code> parameter - SSH agent integration - Passphrase callback for encrypted keys - MFA/keyboard-interactive support</p> <p>Key Classes: - <code>SSHPool</code> - Singleton connection pool - <code>SSHAuthManager</code> - Authentication handling - <code>SSHResult</code> - Command result (stdout, stderr, exit_code)</p>"},{"location":"architecture/#4-shared-context-merlyacorecontextpy","title":"4. Shared Context (<code>merlya/core/context.py</code>)","text":"<p>Central dependency container passed to all components.</p> <pre><code>SharedContext\n\u251c\u2500\u2500 config          # Configuration\n\u251c\u2500\u2500 i18n            # Translations\n\u251c\u2500\u2500 secrets         # Keyring store\n\u251c\u2500\u2500 ui              # Console output\n\u251c\u2500\u2500 db              # SQLite connection\n\u251c\u2500\u2500 hosts           # HostRepository\n\u251c\u2500\u2500 variables       # VariableRepository\n\u251c\u2500\u2500 conversations   # ConversationRepository\n\u251c\u2500\u2500 router          # IntentRouter\n\u2514\u2500\u2500 ssh_pool        # SSHPool (lazy)\n</code></pre>"},{"location":"architecture/#5-persistence-merlyapersistence","title":"5. Persistence (<code>merlya/persistence/</code>)","text":"<p>SQLite database with async access via aiosqlite.</p> <p>Tables: - <code>hosts</code> - Inventory with metadata - <code>variables</code> - User-defined variables - <code>conversations</code> - Chat history with messages - <code>command_history</code> - Executed commands log - <code>raw_logs</code> - Stored command outputs with TTL - <code>sessions</code> - Session context and summaries</p> <p>Migration Safety: - Single atomic transaction for all migrations - Migration lock prevents concurrent updates - Stale lock detection (30s timeout)</p>"},{"location":"architecture/#6-session-manager-merlyasession","title":"6. Session Manager (<code>merlya/session/</code>)","text":"<p>Manages context tiers and automatic summarization.</p> <p>Context Tiers: <pre><code>class ContextTier(Enum):\n    MINIMAL = \"minimal\"    # ~10 messages, 2000 tokens\n    STANDARD = \"standard\"  # ~30 messages, 4000 tokens\n    EXTENDED = \"extended\"  # ~100 messages, 8000 tokens\n</code></pre></p> <p>Auto-detection: Based on available RAM: - \u22658GB \u2192 EXTENDED - \u22654GB \u2192 STANDARD - &lt;4GB \u2192 MINIMAL</p> <p>Summarization Chain: 1. ONNX extractive (key sentences) 2. Mini-LLM fallback 3. Main LLM fallback 4. Smart truncation</p>"},{"location":"architecture/#7-skills-system-merlyaskills","title":"7. Skills System (<code>merlya/skills/</code>)","text":"<p>Reusable workflows for well-defined intents.</p> <p>Skill Configuration (YAML): <pre><code>name: incident_triage\nversion: \"1.0\"\ndescription: \"Triage et diagnostic d'incidents\"\nintent_patterns:\n  - \"incident.*\"\n  - \"probl\u00e8me.*\"\ntools_allowed:\n  - ssh_execute\n  - read_file\nmax_hosts: 5\ntimeout_seconds: 120\nrequire_confirmation_for: [\"restart\", \"kill\"]\n</code></pre></p> <p>Execution Flow: 1. Router matches skill pattern 2. SkillExecutor validates input 3. Subagents parallelize per-host 4. Results aggregated</p>"},{"location":"architecture/#8-parser-service-merlyaparser","title":"8. Parser Service (<code>merlya/parser/</code>)","text":"<p>Structures all input/output before LLM processing.</p> <p>Backend Selection (tier-based): - <code>performance</code> \u2192 ONNX NER model - <code>balanced</code> \u2192 ONNX DistilBERT - <code>lightweight</code> \u2192 Heuristic (regex + patterns)</p> <p>Output Models: <pre><code>class ParsingResult(BaseModel):\n    confidence: float       # 0.0-1.0\n    coverage_ratio: float   # % of text parsed\n    has_unparsed_blocks: bool\n    truncated: bool\n</code></pre></p>"},{"location":"architecture/#9-mcp-manager-merlyamcp","title":"9. MCP Manager (<code>merlya/mcp/</code>)","text":"<p>Integrates external MCP servers (GitHub, Slack, etc.).</p> <p>Async-safe Singleton: <pre><code>manager = await MCPManager.create(config, secrets)\n</code></pre></p> <p>Tool Namespacing: Tools prefixed as <code>server.tool_name</code></p> <p>Environment Resolution: - <code>${VAR}</code> - Required (raises if missing) - <code>${VAR:-default}</code> - Optional with fallback</p>"},{"location":"architecture/#10-policy-system-merlyaconfigpoliciespy","title":"10. Policy System (<code>merlya/config/policies.py</code>)","text":"<p>Guardrails and safety controls.</p> <p>PolicyConfig: <pre><code>policy:\n  context_tier: \"auto\"           # auto-detect or manual\n  max_tokens_per_call: 8000\n  max_hosts_per_skill: 10\n  max_parallel_subagents: 5\n  require_confirmation_for_write: true\n  audit_logging: true\n</code></pre></p> <p>Guardrails: - No destructive commands without confirmation - Per-host async locking for capability detection - Audit logging of all executed commands</p>"},{"location":"architecture/#11-security-layer-merlyasecurity-merlyaagenthistorypy","title":"11. Security Layer (<code>merlya/security/</code>, <code>merlya/agent/history.py</code>)","text":"<p>Comprehensive security controls for credential handling and agent behavior.</p>"},{"location":"architecture/#privilege-elevation-merlyasecuritypermissionspy","title":"Privilege Elevation (<code>merlya/security/permissions.py</code>)","text":"<p>Method Priority: <pre><code>ELEVATION_PRIORITY = {\n    \"sudo\": 1,       # NOPASSWD sudo - best option\n    \"doas\": 2,       # Often NOPASSWD on BSD systems\n    \"sudo_with_password\": 3,  # Requires password prompt\n    \"su\": 4,         # Last resort - requires root password\n}\n</code></pre></p> <p>Detection Flow: 1. Test <code>sudo -n true</code> (non-interactive) 2. If success \u2192 <code>sudo</code> (NOPASSWD) 3. If fail \u2192 check for <code>doas</code>, <code>su</code> 4. Cache capability in host metadata</p> <p>Password Security: - Passwords stored in system keyring (macOS Keychain, Linux Secret Service) - Commands receive <code>@elevation:hostname:password</code> references, not raw values - <code>resolve_secrets()</code> expands references at execution time - Logs show <code>@secret</code> references, never actual values</p>"},{"location":"architecture/#secret-references-merlyatoolscoretoolspy","title":"Secret References (<code>merlya/tools/core/tools.py</code>)","text":"<p>Pattern: <code>@service:host:field</code> (e.g., <code>@elevation:web01:password</code>, <code>@db:prod:token</code>)</p> <pre><code>SECRET_PATTERN = re.compile(r\"(?:^|(?&lt;=[\\s;|&amp;='\\\"]))\\@([a-zA-Z][a-zA-Z0-9_:.-]*)\")\n\ndef resolve_secrets(command: str, secrets: SecretStore) -&gt; tuple[str, str]:\n    \"\"\"Returns (resolved_command, safe_command_for_logging)\"\"\"\n</code></pre> <p>Unsafe Password Detection: <pre><code># Forbidden patterns (leaks password in logs):\n# - echo 'pass' | sudo -S\n# - -p'password'\n# - --password=pass\ndetect_unsafe_password(command) -&gt; str | None  # Returns warning if unsafe\n</code></pre></p>"},{"location":"architecture/#loop-detection-merlyaagenthistorypy","title":"Loop Detection (<code>merlya/agent/history.py</code>)","text":"<p>Prevents agent from spinning on unproductive patterns.</p> <p>Detection Modes: 1. Same call repeated - Same tool+args called 3+ times in window 2. Consecutive identical - Last N calls are ALL identical 3. Alternating pattern - A\u2192B\u2192A\u2192B oscillation</p> <p>Configuration: <pre><code>LOOP_DETECTION_WINDOW = 10    # Messages to examine\nLOOP_THRESHOLD_SAME_CALL = 3  # Max identical calls\n</code></pre></p> <p>Response: Injects system message to redirect agent approach.</p>"},{"location":"architecture/#session-message-persistence","title":"Session Message Persistence","text":"<p>Messages persisted to SQLite for session resumption: - <code>session_messages</code> table with sequence numbers - PydanticAI <code>ModelMessagesTypeAdapter</code> for serialization - Automatic trimming to <code>MAX_MESSAGES_IN_MEMORY</code> on load</p>"},{"location":"architecture/#request-flow","title":"Request Flow","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 User: \"Check disk usage on @web01 via @bastion\"       \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                       \u2502\n                       \u25bc\n         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n         \u2502 REPL receives input     \u2502\n         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                     \u2502\n                     \u25bc\n         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n         \u2502 IntentRouter.route()            \u2502\n         \u2502 \u2022 Mode: DIAGNOSTIC              \u2502\n         \u2502 \u2022 Tools: [system]               \u2502\n         \u2502 \u2022 Entities: {hosts: [\"web01\"]}  \u2502\n         \u2502 \u2022 Jump host: \"bastion\"          \u2502\n         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                     \u2502\n                     \u25bc\n         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n         \u2502 Expand @mentions                \u2502\n         \u2502 @web01 \u2192 resolve from inventory \u2502\n         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                     \u2502\n                     \u25bc\n         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n         \u2502 MerlyaAgent.run()               \u2502\n         \u2502 \u2022 Inject router_result          \u2502\n         \u2502 \u2022 Execute ReAct loop            \u2502\n         \u2502   \u2192 get_host(\"web01\")           \u2502\n         \u2502   \u2192 ssh_execute(                \u2502\n         \u2502       host=\"web01\",             \u2502\n         \u2502       command=\"df -h\",          \u2502\n         \u2502       via=\"bastion\"             \u2502\n         \u2502     )                           \u2502\n         \u2502 \u2022 Persist conversation          \u2502\n         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                     \u2502\n                     \u25bc\n         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n         \u2502 Display Response                \u2502\n         \u2502 \u2022 Markdown render               \u2502\n         \u2502 \u2022 Actions taken                 \u2502\n         \u2502 \u2022 Suggestions                   \u2502\n         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"architecture/#startup-flow","title":"Startup Flow","text":"<pre><code>merlya\n  \u2502\n  \u251c\u2500 Configure logging\n  \u2502\n  \u251c\u2500 First run? \u2192 Setup wizard\n  \u2502   \u251c\u2500 Language selection\n  \u2502   \u251c\u2500 LLM provider config\n  \u2502   \u2514\u2500 Inventory import\n  \u2502\n  \u251c\u2500 Health checks\n  \u2502   \u251c\u2500 Disk space\n  \u2502   \u251c\u2500 RAM availability\n  \u2502   \u251c\u2500 SSH available\n  \u2502   \u251c\u2500 LLM provider reachable\n  \u2502   \u251c\u2500 ONNX router available\n  \u2502   \u2514\u2500 Keyring accessible\n  \u2502\n  \u251c\u2500 Create SharedContext\n  \u2502   \u251c\u2500 Load config\n  \u2502   \u251c\u2500 Initialize database\n  \u2502   \u2514\u2500 Create repositories\n  \u2502\n  \u251c\u2500 Initialize router\n  \u2502   \u2514\u2500 Load ONNX model (if available)\n  \u2502\n  \u251c\u2500 Create agent\n  \u2502   \u2514\u2500 Register all tools\n  \u2502\n  \u2514\u2500 Start REPL loop\n</code></pre>"},{"location":"architecture/#tool-execution","title":"Tool Execution","text":"<p>Tools are Python functions decorated with <code>@agent.tool</code>:</p> <pre><code>@agent.tool\nasync def ssh_execute(\n    ctx: RunContext[AgentDependencies],\n    host: str,\n    command: str,\n    timeout: int = 60,\n    elevation: str | None = None,\n    via: str | None = None,\n) -&gt; dict[str, Any]:\n    \"\"\"Execute command on remote host.\"\"\"\n    result = await _ssh_execute(\n        ctx.deps.context, host, command,\n        timeout=timeout, elevation=elevation, via=via\n    )\n    if result.success:\n        return result.data\n    raise ModelRetry(f\"SSH failed: {result.error}\")\n</code></pre> <p>The agent decides which tools to call based on: 1. Router-suggested tools 2. System prompt guidance 3. LLM reasoning</p>"},{"location":"commands/","title":"Slash Commands","text":"<p>Merlya supports slash commands for quick actions.</p>"},{"location":"commands/#general-commands","title":"General Commands","text":""},{"location":"commands/#help-command","title":"<code>/help [command]</code>","text":"<p>Show help for all commands or a specific command.</p> <pre><code>/help           # List all commands\n/help hosts     # Help for /hosts command\n</code></pre>"},{"location":"commands/#exit","title":"<code>/exit</code>","text":"<p>Exit Merlya.</p>"},{"location":"commands/#new-title","title":"<code>/new [title]</code>","text":"<p>Start a new conversation.</p> <pre><code>/new\n/new \"Server maintenance\"\n</code></pre>"},{"location":"commands/#language-enfr","title":"<code>/language &lt;en|fr&gt;</code>","text":"<p>Change interface language.</p> <pre><code>/language fr    # Switch to French\n/language en    # Switch to English\n</code></pre>"},{"location":"commands/#host-management","title":"Host Management","text":""},{"location":"commands/#hosts-list-tagtag","title":"<code>/hosts list [--tag=&lt;tag&gt;]</code>","text":"<p>List all hosts in inventory.</p> <pre><code>/hosts list\n/hosts list --tag=production\n</code></pre>"},{"location":"commands/#hosts-show-name","title":"<code>/hosts show &lt;name&gt;</code>","text":"<p>Show details for a specific host.</p> <pre><code>/hosts show web01\n</code></pre>"},{"location":"commands/#hosts-add-name-test","title":"<code>/hosts add &lt;name&gt; [--test]</code>","text":"<p>Add a new host to inventory (interactive prompts for hostname, port, username).</p> <pre><code>/hosts add web01\n/hosts add web01 --test\n</code></pre>"},{"location":"commands/#hosts-delete-name","title":"<code>/hosts delete &lt;name&gt;</code>","text":"<p>Remove a host from inventory.</p> <pre><code>/hosts delete web01\n</code></pre>"},{"location":"commands/#hosts-tag-name-tag","title":"<code>/hosts tag &lt;name&gt; &lt;tag&gt;</code>","text":"<p>Add a tag to a host.</p> <pre><code>/hosts tag web01 production\n</code></pre>"},{"location":"commands/#hosts-untag-name-tag","title":"<code>/hosts untag &lt;name&gt; &lt;tag&gt;</code>","text":"<p>Remove a tag from a host.</p> <pre><code>/hosts untag web01 staging\n</code></pre>"},{"location":"commands/#hosts-edit-name","title":"<code>/hosts edit &lt;name&gt;</code>","text":"<p>Edit a host interactively (hostname/port/user/tags).</p> <pre><code>/hosts edit web01\n</code></pre>"},{"location":"commands/#hosts-check-name-tagtag-all","title":"<code>/hosts check [&lt;name&gt;|--tag=&lt;tag&gt;|--all]</code>","text":"<p>Check SSH connectivity to hosts (supports <code>--parallel</code>).</p> <pre><code>/hosts check\n/hosts check web01\n/hosts check --tag=production --parallel\n</code></pre>"},{"location":"commands/#hosts-import-file","title":"<code>/hosts import &lt;file&gt;</code>","text":"<p>Import hosts from a file.</p> <p>Supported formats:</p> <ul> <li>JSON - Array of host objects</li> <li>YAML - List of hosts</li> <li>TOML - Host definitions with <code>[hosts.name]</code> sections</li> <li>CSV - Columns: name, hostname, port, username, tags</li> <li>SSH config - <code>~/.ssh/config</code> format</li> <li>/etc/hosts - <code>/etc/hosts</code> format</li> </ul> <pre><code>/hosts import hosts.toml\n/hosts import ~/.ssh/config --format=ssh\n/hosts import inventory.yaml\n/hosts import /etc/hosts --format=etc_hosts\n</code></pre> <p>TOML Example:</p> <pre><code>[hosts.internal-db]\nhostname = \"10.0.1.50\"\nuser = \"dbadmin\"\njump_host = \"bastion.example.com\"\nport = 22\ntags = [\"database\", \"production\"]\n\n[hosts.bastion]\nhostname = \"bastion.example.com\"\nuser = \"admin\"\n</code></pre>"},{"location":"commands/#hosts-export-file","title":"<code>/hosts export &lt;file&gt;</code>","text":"<p>Export hosts to a file.</p> <pre><code>/hosts export hosts.json\n/hosts export backup.yaml\n</code></pre>"},{"location":"commands/#scanning","title":"Scanning","text":""},{"location":"commands/#scan-host-options","title":"<code>/scan &lt;host&gt; [options]</code>","text":"<p>Scan a host for system information and security issues.</p> <p>Scan Types:</p> <pre><code>/scan web01               # Full scan (default)\n/scan web01 --full        # Complete system + security scan\n/scan web01 --quick       # Fast check: CPU, memory, disk, ports\n/scan web01 --security    # Security checks only\n/scan web01 --system      # System info only\n</code></pre> <p>Output Options:</p> <pre><code>/scan web01 --json        # Output as JSON\n/scan web01 --show-all    # Show all ports/users/services (no truncation)\n</code></pre> <p>Skip Options:</p> <pre><code>/scan web01 --no-docker   # Skip Docker checks\n/scan web01 --no-updates  # Skip pending updates check\n/scan web01 --no-network  # Skip network diagnostics\n/scan web01 --no-services # Skip services list\n/scan web01 --no-cron     # Skip cron jobs list\n</code></pre> <p>Multi-Host Scanning:</p> <pre><code>/scan @web01 @db01 --quick           # Scan multiple hosts\n/scan --tag=production --parallel    # Scan all hosts with tag in parallel\n/scan --all --quick                  # Scan entire inventory\n</code></pre> <p>System Checks: CPU, memory, disk, Docker, services, network, cron, processes, logs</p> <p>Security Checks: Open ports, SSH config, users, SSH keys, sudo config, critical services, failed logins, pending updates</p>"},{"location":"commands/#variables","title":"Variables","text":""},{"location":"commands/#variable-list","title":"<code>/variable list</code>","text":"<p>List all variables.</p>"},{"location":"commands/#variable-set-name-value","title":"<code>/variable set &lt;name&gt; &lt;value&gt;</code>","text":"<p>Set a variable.</p> <pre><code>/variable set deploy_env production\n/variable set api_url https://api.example.com\n</code></pre>"},{"location":"commands/#variable-get-name","title":"<code>/variable get &lt;name&gt;</code>","text":"<p>Get a variable value.</p>"},{"location":"commands/#variable-delete-name","title":"<code>/variable delete &lt;name&gt;</code>","text":"<p>Delete a variable.</p>"},{"location":"commands/#variable-import-file-merge-replace-dry-run","title":"<code>/variable import &lt;file&gt; [--merge|--replace] [--dry-run]</code>","text":"<p>Import variables (and optionally hosts) from YAML/JSON/<code>.env</code> style files.</p> <pre><code>/variable import vars.yml\n/variable import vars.env --dry-run\n</code></pre>"},{"location":"commands/#variable-export-file-include-secrets","title":"<code>/variable export &lt;file&gt; [--include-secrets]</code>","text":"<p>Export variables to a file (YAML/JSON/<code>.env</code>), optionally prompting for secrets.</p> <pre><code>/variable export vars.yml\n</code></pre>"},{"location":"commands/#variable-template-file","title":"<code>/variable template &lt;file&gt;</code>","text":"<p>Generate a template file for variable import.</p> <pre><code>/variable template vars-template.yml\n</code></pre>"},{"location":"commands/#secrets","title":"Secrets","text":"<p>Secrets are stored securely in the system keyring.</p>"},{"location":"commands/#secret-list","title":"<code>/secret list</code>","text":"<p>List all secrets (values hidden).</p>"},{"location":"commands/#secret-set-name","title":"<code>/secret set &lt;name&gt;</code>","text":"<p>Set a secret (prompts for value).</p> <pre><code>/secret set DB_PASSWORD\n# Prompts: Enter value for DB_PASSWORD: ****\n</code></pre>"},{"location":"commands/#secret-delete-name","title":"<code>/secret delete &lt;name&gt;</code>","text":"<p>Delete a secret.</p>"},{"location":"commands/#secret-clear-elevation-host-all","title":"<code>/secret clear-elevation [&lt;host&gt;|--all]</code>","text":"<p>Clear stored elevation (sudo/su) passwords.</p> <pre><code>/secret clear-elevation           # List stored elevation passwords\n/secret clear-elevation web01     # Clear for specific host\n/secret clear-elevation --all     # Clear all elevation passwords\n</code></pre>"},{"location":"commands/#conversations","title":"Conversations","text":"<p>Merlya stores conversation history and lets you resume or export it.</p>"},{"location":"commands/#conv-list-limitn","title":"<code>/conv list [--limit=&lt;n&gt;]</code>","text":"<p>List saved conversations.</p> <pre><code>/conv list\n/conv list --limit=10\n</code></pre>"},{"location":"commands/#conv-show-id","title":"<code>/conv show &lt;id&gt;</code>","text":"<p>Show conversation details.</p> <pre><code>/conv show abc123\n</code></pre>"},{"location":"commands/#conv-load-id","title":"<code>/conv load &lt;id&gt;</code>","text":"<p>Load a previous conversation.</p> <pre><code>/conv load abc123\n</code></pre>"},{"location":"commands/#conv-delete-id","title":"<code>/conv delete &lt;id&gt;</code>","text":"<p>Delete a conversation.</p> <pre><code>/conv delete abc123\n</code></pre>"},{"location":"commands/#conv-rename-id-title","title":"<code>/conv rename &lt;id&gt; &lt;title&gt;</code>","text":"<p>Rename a conversation.</p> <pre><code>/conv rename abc123 \"Server maintenance\"\n</code></pre>"},{"location":"commands/#conv-search-query","title":"<code>/conv search &lt;query&gt;</code>","text":"<p>Search conversations.</p> <pre><code>/conv search \"disk usage\"\n</code></pre>"},{"location":"commands/#conv-export-id-file","title":"<code>/conv export &lt;id&gt; &lt;file&gt;</code>","text":"<p>Export a conversation to a file.</p> <pre><code>/conv export abc123 ./incident.md\n</code></pre>"},{"location":"commands/#model-management","title":"Model Management","text":""},{"location":"commands/#model-show","title":"<code>/model show</code>","text":"<p>Show current provider/model/router status.</p>"},{"location":"commands/#model-provider-name","title":"<code>/model provider &lt;name&gt;</code>","text":"<p>Change LLM provider (prompts for API key if missing).</p>"},{"location":"commands/#model-model-name","title":"<code>/model model &lt;name&gt;</code>","text":"<p>Change the LLM model.</p>"},{"location":"commands/#model-test","title":"<code>/model test</code>","text":"<p>Test LLM connectivity.</p>"},{"location":"commands/#model-router-showlocalllm","title":"<code>/model router &lt;show|local|llm&gt;</code>","text":"<p>Configure intent router.</p>"},{"location":"commands/#mcp-model-context-protocol","title":"MCP (Model Context Protocol)","text":"<p>Extend Merlya with external MCP servers (e.g., Context7, GitHub, Slack, custom).</p>"},{"location":"commands/#mcp-list","title":"<code>/mcp list</code>","text":"<p>List configured MCP servers.</p> <pre><code>/mcp list\n</code></pre>"},{"location":"commands/#mcp-add-name-command-args-envkeyvalue-cwdpath-no-test","title":"<code>/mcp add &lt;name&gt; &lt;command&gt; [args...] [--env=KEY=VALUE] [--cwd=/path] [--no-test]</code>","text":"<p>Add a server and automatically test the connection.</p> <p>Environment Variable Syntax: - <code>${secret-name}</code> - Required variable (from env or <code>/secret set</code>) - <code>${VAR:-default}</code> - Variable with default value</p> <p>Flags: - <code>--env=KEY=VALUE</code> - Set environment variable (can use multiple times) - <code>--cwd=/path</code> - Set working directory for the server - <code>--no-test</code> - Skip automatic connection test</p> <p>Examples:</p> <pre><code># Context7 - Code documentation context\n/secret set context7-token &lt;your-api-key&gt;\n/mcp add context7 npx -y @upstash/context7-mcp --env=CONTEXT7_API_KEY=${context7-token}\n\n# GitHub - Repository management\n/secret set github-token ghp_xxxxx\n/mcp add github npx -y @modelcontextprotocol/server-github --env=GITHUB_TOKEN=${github-token}\n\n# Slack - Team communication\n/secret set slack-bot-token xoxb-your-bot-token\n/mcp add slack npx -y @modelcontextprotocol/server-slack --env=SLACK_BOT_TOKEN=${slack-bot-token}\n\n# Filesystem - Local file access\n/mcp add fs npx -y @modelcontextprotocol/server-filesystem /home/user/projects\n\n# With optional env default\n/mcp add custom python server.py --env=PORT=${MCP_PORT:-8080}\n\n# Skip auto-test (useful for offline setup)\n/mcp add slow-server npx -y @slow/mcp --no-test\n</code></pre> <p>Important: - After adding, Merlya automatically tests the connection - If the test fails, the config is saved but you'll see a warning - Use <code>/mcp test &lt;name&gt;</code> to retry the connection test</p>"},{"location":"commands/#mcp-remove-name","title":"<code>/mcp remove &lt;name&gt;</code>","text":"<p>Remove a server from configuration.</p> <pre><code>/mcp remove github\n</code></pre>"},{"location":"commands/#mcp-show-name","title":"<code>/mcp show &lt;name&gt;</code>","text":"<p>Show server configuration.</p> <pre><code>/mcp show github\n</code></pre>"},{"location":"commands/#mcp-test-name","title":"<code>/mcp test &lt;name&gt;</code>","text":"<p>Start/connect and list exposed tools.</p> <pre><code>/mcp test github\n</code></pre>"},{"location":"commands/#mcp-tools-name","title":"<code>/mcp tools [name]</code>","text":"<p>List available MCP tools (optionally filter by server).</p> <pre><code>/mcp tools\n/mcp tools github\n</code></pre>"},{"location":"commands/#mcp-examples","title":"<code>/mcp examples</code>","text":"<p>Show sample configuration snippets with common MCP servers.</p> <pre><code>/mcp examples\n</code></pre>"},{"location":"commands/#ssh-management","title":"SSH Management","text":""},{"location":"commands/#ssh-connect-host","title":"<code>/ssh connect &lt;host&gt;</code>","text":"<p>Test SSH connection to a host.</p> <pre><code>/ssh connect web01\n</code></pre>"},{"location":"commands/#ssh-exec-host-command","title":"<code>/ssh exec &lt;host&gt; &lt;command&gt;</code>","text":"<p>Execute a command over SSH.</p> <pre><code>/ssh exec web01 \"uptime\"\n</code></pre>"},{"location":"commands/#ssh-disconnect-host","title":"<code>/ssh disconnect &lt;host&gt;</code>","text":"<p>Disconnect from a host.</p> <pre><code>/ssh disconnect web01\n</code></pre>"},{"location":"commands/#ssh-config-host","title":"<code>/ssh config &lt;host&gt;</code>","text":"<p>Interactive SSH configuration for a host.</p>"},{"location":"commands/#ssh-test-host","title":"<code>/ssh test &lt;host&gt;</code>","text":"<p>Test SSH connectivity (diagnostics).</p>"},{"location":"commands/#system","title":"System","text":""},{"location":"commands/#health","title":"<code>/health</code>","text":"<p>Show system health status.</p> <pre><code>/health\n# Shows: RAM, Disk, LLM, SSH, Keyring, Web Search status\n</code></pre>"},{"location":"commands/#log-level-level","title":"<code>/log level &lt;level&gt;</code>","text":"<p>Set log level.</p> <pre><code>/log level debug\n/log level info\n</code></pre>"},{"location":"commands/#log-show","title":"<code>/log show</code>","text":"<p>Show recent log entries.</p>"},{"location":"commands/#skills","title":"Skills","text":""},{"location":"commands/#skill-list","title":"<code>/skill list</code>","text":"<p>List all available skills (builtin and user-defined).</p> <pre><code>/skill list\n</code></pre>"},{"location":"commands/#skill-show-name","title":"<code>/skill show &lt;name&gt;</code>","text":"<p>Show details of a specific skill.</p> <pre><code>/skill show incident_triage\n</code></pre>"},{"location":"commands/#skill-reload","title":"<code>/skill reload</code>","text":"<p>Reload skills from disk.</p> <pre><code>/skill reload\n</code></pre>"},{"location":"commands/#skill-create","title":"<code>/skill create</code>","text":"<p>Interactive wizard to create a new skill.</p> <pre><code>/skill create\n# Prompts for:\n# - Skill name\n# - Description\n# - Intent patterns\n# - Tools allowed\n# - Max hosts, timeout\n# - System prompt\n</code></pre>"},{"location":"commands/#skill-template-name-description","title":"<code>/skill template &lt;name&gt; [description]</code>","text":"<p>Generate a skill template YAML file.</p> <pre><code>/skill template disk_audit \"Audit disk usage across hosts\"\n# Creates ~/.merlya/skills/disk_audit.yaml\n</code></pre>"},{"location":"commands/#skill-run-name-hosts","title":"<code>/skill run &lt;name&gt; [hosts]</code>","text":"<p>Run a skill manually.</p> <pre><code>/skill run disk_audit\n/skill run security_check @web01 @db01\n</code></pre>"},{"location":"commands/#audit","title":"Audit","text":""},{"location":"commands/#audit-recent-limit","title":"<code>/audit recent [limit]</code>","text":"<p>Show recent audit events.</p> <pre><code>/audit recent\n/audit recent 50\n</code></pre>"},{"location":"commands/#audit-export-file-since-hours-limit-n","title":"<code>/audit export [file] [--since &lt;hours&gt;] [--limit &lt;n&gt;]</code>","text":"<p>Export audit logs to JSON (SIEM-compatible format).</p> <pre><code>/audit export                           # Export to default file\n/audit export ./audit.json              # Export to specific file\n/audit export --since 24                # Last 24 hours only\n/audit export --limit 1000              # Limit to 1000 events\n/audit export audit.json --since 48 --limit 500\n</code></pre>"},{"location":"commands/#audit-filter-type","title":"<code>/audit filter &lt;type&gt;</code>","text":"<p>Filter audit events by type.</p> <pre><code>/audit filter ssh\n</code></pre>"},{"location":"commands/#audit-stats","title":"<code>/audit stats</code>","text":"<p>Show audit statistics.</p> <pre><code>/audit stats\n</code></pre>"},{"location":"commands/#using-mentions","title":"Using @ Mentions","text":""},{"location":"commands/#host-mentions","title":"Host Mentions","text":"<p>Reference hosts from inventory with <code>@</code>:</p> <pre><code>Check disk on @web01\nConnect to @database-primary via @bastion\n</code></pre>"},{"location":"commands/#variable-mentions","title":"Variable Mentions","text":"<p>Reference variables with <code>@</code>:</p> <pre><code>Deploy to @deploy_env environment\n</code></pre> <p>Variables are expanded before processing.</p>"},{"location":"commands/#command-aliases","title":"Command Aliases","text":"<p>Some commands have shorter aliases:</p> Command Alias <code>/help</code> <code>/h</code> <code>/exit</code> <code>/quit</code>, <code>/q</code> <code>/language</code> <code>/lang</code> <code>/variable</code> <code>/var</code> <code>/conv</code> <code>/conversation</code>"},{"location":"configuration/","title":"Configuration","text":"<p>Merlya stores configuration in <code>~/.merlya/config.yaml</code>.</p>"},{"location":"configuration/#full-configuration-reference","title":"Full Configuration Reference","text":"<pre><code>general:\n  language: en              # en, fr\n  data_dir: ~/.merlya       # Base data directory\n\nmodel:\n  provider: openrouter      # LLM provider\n  model: amazon/nova-2-lite-v1:free\n  api_key_env: null         # Environment variable name for API key\n\nrouter:\n  type: local               # local (ONNX), llm\n  model: null               # Embedding model ID\n  tier: null                # performance, balanced, lightweight\n  llm_fallback: openrouter:google/gemini-2.0-flash-lite-001\n\nssh:\n  pool_timeout: 600         # Connection reuse timeout (seconds)\n  connect_timeout: 30       # Initial connection timeout\n  command_timeout: 60       # Command execution timeout\n  default_user: null        # Default SSH username\n  default_key: null         # Default private key path\n\nui:\n  theme: auto               # auto, light, dark\n  markdown: true            # Enable markdown rendering\n  syntax_highlight: true    # Enable syntax highlighting\n\nlogging:\n  console_level: info       # Console log level (debug, info, warning, error)\n  file_level: debug         # File log level\n  max_size_mb: 10           # Max log file size\n  max_files: 5              # Number of log files to keep\n  retention_days: 7         # Log retention period\n\npolicy:\n  context_tier: \"auto\"      # auto, minimal, standard, extended\n  max_tokens_per_call: 8000\n  max_hosts_per_skill: 10\n  max_parallel_subagents: 5\n  require_confirmation_for_write: true\n  audit_logging: true\n  auto_summarize: true\n\nmcp: {}                     # See \"MCP Configuration\" section below\n</code></pre>"},{"location":"configuration/#llm-providers","title":"LLM Providers","text":""},{"location":"configuration/#openrouter-recommended","title":"OpenRouter (Recommended)","text":"<pre><code>model:\n  provider: openrouter\n  model: amazon/nova-2-lite-v1:free\n  api_key_env: OPENROUTER_API_KEY\n</code></pre> <p>Set your API key: <pre><code>export OPENROUTER_API_KEY=sk-or-...\n</code></pre></p> <p>Or store in keyring: <pre><code>merlya\n# First run wizard will prompt for API key\n</code></pre></p>"},{"location":"configuration/#anthropic","title":"Anthropic","text":"<pre><code>model:\n  provider: anthropic\n  model: claude-3-5-sonnet-latest\n  api_key_env: ANTHROPIC_API_KEY\n</code></pre>"},{"location":"configuration/#openai","title":"OpenAI","text":"<pre><code>model:\n  provider: openai\n  model: gpt-4o\n  api_key_env: OPENAI_API_KEY\n</code></pre>"},{"location":"configuration/#mistral","title":"Mistral","text":"<pre><code>model:\n  provider: mistral\n  model: mistral-large-latest\n  api_key_env: MISTRAL_API_KEY\n</code></pre> <p>Available models: <code>mistral-large-latest</code>, <code>mistral-small-latest</code>, <code>codestral-latest</code>, <code>open-mistral-nemo</code></p>"},{"location":"configuration/#groq","title":"Groq","text":"<pre><code>model:\n  provider: groq\n  model: llama-3.1-70b-versatile\n  api_key_env: GROQ_API_KEY\n</code></pre> <p>Groq offers fast inference on open models. Available models: <code>llama-3.1-70b-versatile</code>, <code>llama-3.1-8b-instant</code>, <code>mixtral-8x7b-32768</code></p>"},{"location":"configuration/#ollama-local","title":"Ollama (Local)","text":"<pre><code>model:\n  provider: ollama\n  model: llama3.2\n</code></pre> <p>No API key required for local Ollama.</p>"},{"location":"configuration/#router-configuration","title":"Router Configuration","text":"<p>The router classifies user intent before sending to the LLM.</p>"},{"location":"configuration/#local-router-onnx","title":"Local Router (ONNX)","text":"<p>Uses local embeddings for fast, private classification:</p> <pre><code>router:\n  type: local\n  tier: balanced  # performance, balanced, lightweight\n</code></pre> <p>Tiers: - <code>performance</code> - Best accuracy, more RAM - <code>balanced</code> - Good tradeoff (default) - <code>lightweight</code> - Low RAM usage</p>"},{"location":"configuration/#llm-router","title":"LLM Router","text":"<p>Falls back to LLM when local confidence is low:</p> <pre><code>router:\n  llm_fallback: openrouter:google/gemini-2.0-flash-lite-001\n</code></pre>"},{"location":"configuration/#ssh-configuration","title":"SSH Configuration","text":"<pre><code>ssh:\n  pool_timeout: 600      # Keep connections alive for 10 min\n  connect_timeout: 30    # 30s to establish connection\n  command_timeout: 60    # 60s max per command\n  default_user: admin    # Default username if not specified\n  default_key: ~/.ssh/id_ed25519  # Default private key\n</code></pre>"},{"location":"configuration/#environment-variables","title":"Environment Variables","text":"Variable Description <code>OPENROUTER_API_KEY</code> OpenRouter API key <code>ANTHROPIC_API_KEY</code> Anthropic API key <code>OPENAI_API_KEY</code> OpenAI API key <code>MISTRAL_API_KEY</code> Mistral API key <code>GROQ_API_KEY</code> Groq API key <code>MERLYA_ROUTER_MODEL</code> Override router model <code>MERLYA_ROUTER_FALLBACK</code> Override LLM fallback <code>SSH_AUTH_SOCK</code> SSH agent socket <code>GITHUB_TOKEN</code> Token used by the GitHub MCP server example <code>SLACK_BOT_TOKEN</code> Token used by the Slack MCP server example"},{"location":"configuration/#data-directory","title":"Data Directory","text":"<p>Default: <code>~/.merlya/</code></p> <p>Contents: <pre><code>~/.merlya/\n\u251c\u2500\u2500 config.yaml      # Configuration\n\u251c\u2500\u2500 merlya.db        # SQLite database\n\u251c\u2500\u2500 history          # Command history\n\u2514\u2500\u2500 logs/            # Log files\n</code></pre></p>"},{"location":"configuration/#keyring-integration","title":"Keyring Integration","text":"<p>API keys are stored securely in the system keyring: - macOS: Keychain - Linux: Secret Service (GNOME Keyring, KWallet) - Windows: Windows Credential Manager</p> <p>If keyring is unavailable, falls back to in-memory storage (not persisted).</p>"},{"location":"configuration/#mcp-configuration","title":"MCP Configuration","text":"<p>The <code>mcp</code> block belongs at the root level of <code>~/.merlya/config.yaml</code> (sibling to <code>general</code>, <code>model</code>, etc.). Configure MCP servers as follows:</p> <pre><code>mcp:\n  servers:\n    github:\n      command: \"npx\"\n      args: [\"-y\", \"@modelcontextprotocol/server-github\"]\n      env:\n        GITHUB_TOKEN: \"${GITHUB_TOKEN}\"\n    slack:\n      command: \"npx\"\n      args: [\"-y\", \"@modelcontextprotocol/server-slack\"]\n      env:\n        SLACK_BOT_TOKEN: \"${SLACK_BOT_TOKEN}\"\n</code></pre> <p>Environment variable resolution: - <code>${VAR}</code> - Required variable from OS env or Merlya keyring (warning if missing) - <code>${VAR:-default}</code> - Optional variable with default fallback</p> <p>Use <code>/mcp test &lt;name&gt;</code> to validate connectivity and list available tools.</p>"},{"location":"configuration/#first-run-wizard","title":"First Run Wizard","text":"<p>On first run, Merlya guides you through:</p> <ol> <li>Language Selection</li> <li> <p>English or French</p> </li> <li> <p>LLM Provider</p> </li> <li>Select provider</li> <li>Enter API key (stored in keyring)</li> <li> <p>Choose model</p> </li> <li> <p>Inventory Import</p> </li> <li>Scans for existing inventories:<ul> <li><code>~/.ssh/config</code></li> <li><code>~/.ssh/known_hosts</code></li> <li><code>/etc/hosts</code></li> <li>Ansible inventory files</li> </ul> </li> <li>Select which to import</li> </ol>"},{"location":"configuration/#updating-configuration","title":"Updating Configuration","text":"<p>Edit the config file directly: <pre><code>$EDITOR ~/.merlya/config.yaml\n</code></pre></p> <p>Or use commands: <pre><code># Change language\n/language fr\n\n# Change model\n/model set openrouter:anthropic/claude-3.5-sonnet\n</code></pre></p> <p>Changes take effect immediately for most settings.</p>"},{"location":"configuration/#policy-configuration","title":"Policy Configuration","text":"<p>Policies control context management, guardrails, and safety features.</p>"},{"location":"configuration/#context-tiers","title":"Context Tiers","text":"<pre><code>policy:\n  context_tier: \"auto\"  # auto, minimal, standard, extended\n</code></pre> <p>Tier Behavior: - <code>auto</code> - Auto-detect based on available RAM (\u22658GB=extended, \u22654GB=standard, &lt;4GB=minimal) - <code>minimal</code> - 10 messages, 2000 tokens, lightweight parser - <code>standard</code> - 30 messages, 4000 tokens, balanced parser - <code>extended</code> - 100 messages, 8000 tokens, performance parser</p>"},{"location":"configuration/#token-limits","title":"Token Limits","text":"<pre><code>policy:\n  max_tokens_per_call: 8000   # Maximum tokens per LLM call\n  auto_summarize: true         # Auto-summarize when threshold reached\n</code></pre>"},{"location":"configuration/#parallel-execution-limits","title":"Parallel Execution Limits","text":"<pre><code>policy:\n  max_hosts_per_skill: 10      # Max hosts per skill execution\n  max_parallel_subagents: 5    # Max concurrent subagents\n</code></pre>"},{"location":"configuration/#safety-guardrails","title":"Safety Guardrails","text":"<pre><code>policy:\n  require_confirmation_for_write: true  # Confirm destructive commands\n  audit_logging: true                    # Log all command executions\n</code></pre> <p>Audit Logging: When enabled, all executed commands are logged to the <code>command_history</code> table with: - Host, command, timestamp - Exit code, stdout/stderr (truncated) - User who initiated the command</p>"},{"location":"configuration/#skills-configuration","title":"Skills Configuration","text":"<p>Skills are stored in <code>~/.merlya/skills/</code> as YAML files:</p> <pre><code># ~/.merlya/skills/disk_audit.yaml\nname: disk_audit\nversion: \"1.0\"\ndescription: \"Audit disk usage across hosts\"\nintent_patterns:\n  - \"disk.*audit\"\n  - \"storage.*check\"\ntools_allowed:\n  - ssh_execute\n  - list_hosts\nmax_hosts: 10\ntimeout_seconds: 120\nrequire_confirmation_for: []\nsystem_prompt: |\n  You are a disk usage auditor. Check disk space and identify\n  hosts with low available space.\n</code></pre>"},{"location":"extending/","title":"Extending Merlya","text":"<p>This guide explains how to add custom tools, commands, and functionality.</p>"},{"location":"extending/#adding-new-tools","title":"Adding New Tools","text":"<p>Tools are functions the agent can call during execution.</p>"},{"location":"extending/#step-1-create-tool-function","title":"Step 1: Create Tool Function","text":"<p>Create your tool in <code>merlya/tools/&lt;category&gt;/</code>:</p> <pre><code># merlya/tools/mytools/backup.py\n\nfrom merlya.tools.core.base import ToolResult\n\nasync def create_backup(\n    ctx: \"SharedContext\",\n    host: str,\n    path: str,\n    destination: str,\n) -&gt; ToolResult:\n    \"\"\"\n    Create a backup of a file or directory.\n\n    Args:\n        ctx: Shared context.\n        host: Target host.\n        path: Path to backup.\n        destination: Backup destination.\n\n    Returns:\n        ToolResult with backup info.\n    \"\"\"\n    try:\n        # Use existing SSH tool\n        from merlya.tools.core import ssh_execute\n\n        command = f\"tar -czf {destination} {path}\"\n        result = await ssh_execute(ctx, host, command)\n\n        if result.success:\n            return ToolResult(\n                success=True,\n                data={\"backup_path\": destination, \"source\": path}\n            )\n        return ToolResult(success=False, error=result.error)\n\n    except Exception as e:\n        return ToolResult(success=False, error=str(e))\n</code></pre>"},{"location":"extending/#step-2-register-with-agent","title":"Step 2: Register with Agent","text":"<p>Add the tool to <code>merlya/agent/tools.py</code>:</p> <pre><code>def _register_backup_tools(agent: Agent) -&gt; None:\n    \"\"\"Register backup tools.\"\"\"\n\n    @agent.tool\n    async def create_backup(\n        ctx: RunContext[AgentDependencies],\n        host: str,\n        path: str,\n        destination: str,\n    ) -&gt; dict[str, Any]:\n        \"\"\"\n        Create a backup of a file or directory.\n\n        Args:\n            ctx: Run context.\n            host: Target host name.\n            path: Path to backup.\n            destination: Backup destination path.\n\n        Returns:\n            Backup information.\n        \"\"\"\n        from merlya.tools.mytools.backup import create_backup as _create_backup\n\n        result = await _create_backup(\n            ctx.deps.context, host, path, destination\n        )\n\n        if result.success:\n            return result.data\n        raise ModelRetry(f\"Backup failed: {result.error}\")\n\n# Add to register_all_tools()\ndef register_all_tools(agent: Agent) -&gt; None:\n    _register_core_tools(agent)\n    _register_system_tools(agent)\n    _register_file_tools(agent)\n    _register_backup_tools(agent)  # Add this\n    # ...\n</code></pre>"},{"location":"extending/#step-3-update-router-optional","title":"Step 3: Update Router (Optional)","text":"<p>Add keywords to activate your tool in <code>merlya/router/intent_classifier.py</code>:</p> <pre><code>TOOL_KEYWORDS = {\n    # ...\n    \"backup\": [\"backup\", \"archive\", \"snapshot\", \"tar\", \"zip\"],\n}\n</code></pre>"},{"location":"extending/#adding-new-commands","title":"Adding New Commands","text":"<p>Commands are slash commands like <code>/help</code>, <code>/hosts</code>.</p>"},{"location":"extending/#step-1-create-command-handler","title":"Step 1: Create Command Handler","text":"<p>Create handler in <code>merlya/commands/handlers/</code>:</p> <pre><code># merlya/commands/handlers/backup.py\n\nfrom merlya.commands.registry import CommandResult\n\nasync def handle_backup(ctx: \"SharedContext\", args: list[str]) -&gt; CommandResult:\n    \"\"\"\n    Handle /backup command.\n\n    Usage: /backup &lt;host&gt; &lt;path&gt; [destination]\n    \"\"\"\n    if len(args) &lt; 2:\n        return CommandResult(\n            success=False,\n            message=\"Usage: /backup &lt;host&gt; &lt;path&gt; [destination]\"\n        )\n\n    host = args[0].lstrip(\"@\")\n    path = args[1]\n    destination = args[2] if len(args) &gt; 2 else f\"{path}.backup.tar.gz\"\n\n    try:\n        from merlya.tools.mytools.backup import create_backup\n\n        result = await create_backup(ctx, host, path, destination)\n\n        if result.success:\n            return CommandResult(\n                success=True,\n                message=f\"Backup created: {result.data['backup_path']}\"\n            )\n        return CommandResult(success=False, message=result.error)\n\n    except Exception as e:\n        return CommandResult(success=False, message=str(e))\n</code></pre>"},{"location":"extending/#step-2-register-command","title":"Step 2: Register Command","text":"<p>Add to <code>merlya/commands/handlers/__init__.py</code>:</p> <pre><code>from merlya.commands.handlers.backup import handle_backup\n\ndef init_commands() -&gt; None:\n    registry = get_registry()\n\n    # ... existing commands ...\n\n    registry.register(\n        name=\"backup\",\n        description=\"Create a backup of a remote file or directory\",\n        usage=\"/backup &lt;host&gt; &lt;path&gt; [destination]\",\n        handler=handle_backup,\n        aliases=[\"bak\"],\n    )\n</code></pre>"},{"location":"extending/#adding-translations","title":"Adding Translations","text":""},{"location":"extending/#step-1-add-translation-keys","title":"Step 1: Add Translation Keys","text":"<p>Add to <code>merlya/i18n/locales/en.json</code>:</p> <pre><code>{\n  \"commands\": {\n    \"backup\": {\n      \"created\": \"Backup created: {path}\",\n      \"failed\": \"Backup failed: {error}\"\n    }\n  },\n  \"commands_meta\": {\n    \"backup\": {\n      \"description\": \"Create a backup of a remote file\",\n      \"usage\": \"/backup &lt;host&gt; &lt;path&gt; [destination]\"\n    }\n  }\n}\n</code></pre> <p>Add to <code>merlya/i18n/locales/fr.json</code>:</p> <pre><code>{\n  \"commands\": {\n    \"backup\": {\n      \"created\": \"Sauvegarde cr\u00e9\u00e9e : {path}\",\n      \"failed\": \"\u00c9chec de la sauvegarde : {error}\"\n    }\n  },\n  \"commands_meta\": {\n    \"backup\": {\n      \"description\": \"Cr\u00e9er une sauvegarde d'un fichier distant\",\n      \"usage\": \"/backup &lt;h\u00f4te&gt; &lt;chemin&gt; [destination]\"\n    }\n  }\n}\n</code></pre>"},{"location":"extending/#step-2-use-translations","title":"Step 2: Use Translations","text":"<pre><code>from merlya.i18n import get_i18n\n\ni18n = get_i18n()\nmessage = i18n.t(\"commands.backup.created\", path=destination)\n</code></pre>"},{"location":"extending/#adding-database-tables","title":"Adding Database Tables","text":""},{"location":"extending/#step-1-define-model","title":"Step 1: Define Model","text":"<p>Add to <code>merlya/persistence/models.py</code>:</p> <pre><code>@dataclass\nclass Backup:\n    \"\"\"Backup record.\"\"\"\n    id: str\n    host: str\n    source_path: str\n    backup_path: str\n    created_at: datetime\n    size_bytes: int | None = None\n</code></pre>"},{"location":"extending/#step-2-create-repository","title":"Step 2: Create Repository","text":"<p>Add to <code>merlya/persistence/repositories.py</code>:</p> <pre><code>class BackupRepository:\n    \"\"\"Repository for backup records.\"\"\"\n\n    def __init__(self, db: Database) -&gt; None:\n        self.db = db\n\n    async def create(self, backup: Backup) -&gt; Backup:\n        await self.db.execute(\n            \"\"\"\n            INSERT INTO backups (id, host, source_path, backup_path, created_at, size_bytes)\n            VALUES (?, ?, ?, ?, ?, ?)\n            \"\"\",\n            (backup.id, backup.host, backup.source_path,\n             backup.backup_path, backup.created_at, backup.size_bytes)\n        )\n        return backup\n\n    async def get_by_host(self, host: str) -&gt; list[Backup]:\n        rows = await self.db.fetchall(\n            \"SELECT * FROM backups WHERE host = ? ORDER BY created_at DESC\",\n            (host,)\n        )\n        return [Backup(**row) for row in rows]\n</code></pre>"},{"location":"extending/#step-3-add-schema","title":"Step 3: Add Schema","text":"<p>Add to <code>merlya/persistence/database.py</code>:</p> <pre><code>SCHEMA = \"\"\"\n-- ... existing tables ...\n\nCREATE TABLE IF NOT EXISTS backups (\n    id TEXT PRIMARY KEY,\n    host TEXT NOT NULL,\n    source_path TEXT NOT NULL,\n    backup_path TEXT NOT NULL,\n    created_at TIMESTAMP NOT NULL,\n    size_bytes INTEGER,\n    FOREIGN KEY (host) REFERENCES hosts(name)\n);\n\"\"\"\n</code></pre>"},{"location":"extending/#testing-extensions","title":"Testing Extensions","text":""},{"location":"extending/#unit-tests","title":"Unit Tests","text":"<pre><code># tests/test_backup.py\n\nimport pytest\nfrom merlya.tools.mytools.backup import create_backup\n\n@pytest.mark.asyncio\nasync def test_create_backup(mock_context):\n    result = await create_backup(\n        mock_context,\n        host=\"testhost\",\n        path=\"/var/log/app.log\",\n        destination=\"/backups/app.log.tar.gz\"\n    )\n\n    assert result.success\n    assert result.data[\"backup_path\"] == \"/backups/app.log.tar.gz\"\n</code></pre>"},{"location":"extending/#integration-tests","title":"Integration Tests","text":"<pre><code>@pytest.mark.asyncio\nasync def test_backup_command(ctx):\n    from merlya.commands import get_registry\n\n    registry = get_registry()\n    result = await registry.execute(ctx, \"/backup web01 /var/log\")\n\n    assert result.success\n</code></pre>"},{"location":"extending/#using-mcp-servers","title":"Using MCP Servers","text":"<p>MCP (Model Context Protocol) lets Merlya bridge external services like GitHub, Slack, or custom APIs. Unlike custom commands which are built into the codebase, MCP servers are external processes that expose tools dynamically.</p>"},{"location":"extending/#step-1-add-server-to-configuration","title":"Step 1: Add Server to Configuration","text":"<p>Define the MCP server in <code>config.yaml</code>:</p> <pre><code>mcp:\n  servers:\n    github:\n      command: \"npx\"\n      args: [\"-y\", \"@modelcontextprotocol/server-github\"]\n      env:\n        GITHUB_TOKEN: \"${GITHUB_TOKEN}\"\n    slack:\n      command: \"npx\"\n      args: [\"-y\", \"@modelcontextprotocol/server-slack\"]\n      env:\n        SLACK_BOT_TOKEN: \"${SLACK_BOT_TOKEN}\"\n</code></pre>"},{"location":"extending/#step-2-test-the-connection","title":"Step 2: Test the Connection","text":"<p>Use the <code>/mcp</code> command to verify the server is working:</p> <pre><code>/mcp list              # List configured servers\n/mcp test github       # Test connection to GitHub server\n/mcp tools github      # List available tools from server\n</code></pre>"},{"location":"extending/#step-3-use-mcp-tools-in-agent","title":"Step 3: Use MCP Tools in Agent","text":"<p>MCP tools are automatically exposed to the agent as <code>server.tool</code> (e.g., <code>github.create_issue</code>). The agent can call them via the <code>call_mcp_tool</code> function:</p> <pre><code># Agent can call MCP tools directly\nresult = await call_mcp_tool(\n    ctx,\n    server=\"github\",\n    tool=\"create_issue\",\n    arguments={\"repo\": \"org/repo\", \"title\": \"Bug report\"}\n)\n</code></pre> <p>For programmatic access in custom code:</p> <pre><code>from merlya.mcp.manager import MCPManager\n\n# Get or create the singleton (async-safe)\nmanager = await MCPManager.create(config, secrets)\n\n# Or get existing instance (may be None)\nmanager = MCPManager.get_instance()\n\n# Call a tool (must include server prefix)\nresult = await manager.call_tool(\"github.create_issue\", {\n    \"repo\": \"org/repo\",\n    \"title\": \"Bug report\",\n    \"body\": \"Description here\"\n})\n</code></pre> <p>Important: Tool names must include the server prefix (e.g., <code>github.create_issue</code>, not just <code>create_issue</code>).</p>"},{"location":"extending/#environment-variable-handling","title":"Environment Variable Handling","text":"<p>MCP servers can reference environment variables:</p> <pre><code>mcp:\n  servers:\n    github:\n      env:\n        GITHUB_TOKEN: \"${GITHUB_TOKEN}\"        # Required - raises error if missing\n        CACHE_DIR: \"${CACHE_DIR:-/tmp/cache}\"  # Optional with default\n</code></pre> <p>Missing required variables will raise a clear error message listing all missing variables.</p>"},{"location":"extending/#best-practices","title":"Best Practices","text":""},{"location":"extending/#tool-design","title":"Tool Design","text":"<ol> <li>Single responsibility - One tool, one purpose</li> <li>Return ToolResult - Consistent success/error handling</li> <li>Document parameters - Clear docstrings for LLM</li> <li>Handle errors - Catch exceptions, return meaningful errors</li> <li>Use existing tools - Compose with <code>ssh_execute</code>, etc.</li> </ol>"},{"location":"extending/#command-design","title":"Command Design","text":"<ol> <li>Clear usage - Show syntax in help</li> <li>Validate args - Check required parameters</li> <li>Use translations - Support i18n</li> <li>Return CommandResult - Consistent responses</li> </ol>"},{"location":"extending/#security","title":"Security","text":"<ol> <li>Validate inputs - Sanitize paths, hostnames</li> <li>Check permissions - Use elevation when needed</li> <li>Audit actions - Log sensitive operations</li> <li>No secrets in code - Use keyring/environment</li> </ol>"},{"location":"ssh/","title":"SSH &amp; Jump Hosts","text":"<p>Merlya manages SSH connections with pooling, authentication, and jump host support.</p>"},{"location":"ssh/#connection-pool","title":"Connection Pool","text":"<p>Connections are reused to improve performance:</p> <ul> <li>Pool size: 50 connections max (LRU eviction)</li> <li>Pool timeout: 600 seconds (configurable)</li> <li>Connect timeout: 30 seconds</li> <li>Command timeout: 60 seconds</li> </ul>"},{"location":"ssh/#authentication","title":"Authentication","text":"<p>Merlya tries authentication methods in order:</p> <ol> <li>SSH Agent - Keys loaded in ssh-agent</li> <li>Key file - Private key from inventory or default</li> <li>Passphrase prompt - For encrypted keys</li> <li>Password - If configured</li> <li>Keyboard-interactive - For MFA</li> </ol>"},{"location":"ssh/#ssh-agent","title":"SSH Agent","text":"<p>If <code>ssh-agent</code> is running, Merlya uses it automatically:</p> <pre><code># Start agent and add key\neval $(ssh-agent)\nssh-add ~/.ssh/id_ed25519\n</code></pre>"},{"location":"ssh/#encrypted-keys","title":"Encrypted Keys","text":"<p>For encrypted private keys, Merlya prompts for the passphrase:</p> <pre><code>Enter passphrase for key /home/user/.ssh/id_ed25519: ****\n</code></pre> <p>Passphrases can be cached in keyring for the session.</p>"},{"location":"ssh/#mfa2fa","title":"MFA/2FA","text":"<p>Keyboard-interactive authentication is supported for MFA:</p> <pre><code>Enter MFA code: 123456\n</code></pre>"},{"location":"ssh/#jump-hosts-bastions","title":"Jump Hosts / Bastions","text":"<p>Access servers through a bastion host using the <code>via</code> parameter.</p>"},{"location":"ssh/#natural-language","title":"Natural Language","text":"<pre><code>Check disk on db-server via bastion\nExecute 'uptime' on web-01 through @jump-host\nAnalyse 192.168.1.100 via @ansible\n</code></pre>"},{"location":"ssh/#patterns-detected","title":"Patterns Detected","text":"<p>Merlya recognizes these patterns:</p> <p>English: - <code>via @hostname</code> - <code>through @hostname</code> - <code>using bastion @hostname</code></p> <p>French: - <code>via @hostname</code> - <code>via la machine @hostname</code> - <code>en passant par @hostname</code> - <code>\u00e0 travers @hostname</code></p>"},{"location":"ssh/#how-it-works","title":"How It Works","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Merlya  \u2502 \u2500\u2500\u2500\u2500 \u2502  Bastion \u2502 \u2500\u2500\u2500\u2500 \u2502  Target  \u2502\n\u2502          \u2502 SSH  \u2502 (jump)   \u2502 SSH  \u2502 (db-01)  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518      \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518      \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <ol> <li>Merlya connects to bastion via SSH</li> <li>Creates tunnel through bastion to target</li> <li>Executes commands on target through tunnel</li> <li>Returns results</li> </ol>"},{"location":"ssh/#inventory-configuration","title":"Inventory Configuration","text":"<p>Set a default jump host for a host in inventory:</p> <pre><code>/hosts add db-internal 10.0.0.50 --jump bastion\n</code></pre> <p>The <code>via</code> parameter in commands overrides inventory settings.</p>"},{"location":"ssh/#multiple-hops","title":"Multiple Hops","text":"<p>For multiple jump hosts, configure the chain in inventory:</p> <pre><code>/hosts add jump1 1.2.3.4\n/hosts add jump2 10.0.0.1 --jump jump1\n/hosts add target 192.168.1.100 --jump jump2\n</code></pre>"},{"location":"ssh/#host-resolution","title":"Host Resolution","text":"<p>When you reference a host, Merlya resolves it in order:</p> <ol> <li>Inventory - Hosts added via <code>/hosts add</code></li> <li>SSH Config - <code>~/.ssh/config</code> entries</li> <li>Known hosts - <code>~/.ssh/known_hosts</code></li> <li>/etc/hosts - System hosts file</li> <li>DNS - Standard DNS resolution</li> </ol>"},{"location":"ssh/#using-mentions","title":"Using @ Mentions","text":"<p>Reference hosts with <code>@</code>:</p> <pre><code>Check memory on @web01\n</code></pre> <p>This resolves <code>web01</code> from inventory and uses its configuration.</p>"},{"location":"ssh/#ssh-configuration","title":"SSH Configuration","text":""},{"location":"ssh/#in-merlyaconfigyaml","title":"In <code>~/.merlya/config.yaml</code>:","text":"<pre><code>ssh:\n  pool_timeout: 600      # Connection reuse time\n  connect_timeout: 30    # Connection timeout\n  command_timeout: 60    # Command timeout\n  default_user: admin    # Default SSH user\n  default_key: ~/.ssh/id_ed25519  # Default key\n</code></pre>"},{"location":"ssh/#per-host-configuration","title":"Per-Host Configuration","text":"<p>When adding hosts:</p> <pre><code>/hosts add web01 10.0.1.5 \\\n  --user deploy \\\n  --port 2222 \\\n  --key ~/.ssh/deploy_key \\\n  --jump bastion\n</code></pre>"},{"location":"ssh/#troubleshooting","title":"Troubleshooting","text":""},{"location":"ssh/#connection-timeout","title":"Connection Timeout","text":"<pre><code>SSH connection failed: Connection timeout\n</code></pre> <p>Solutions: - Check network connectivity - Verify host is reachable - Increase <code>connect_timeout</code> in config</p>"},{"location":"ssh/#authentication-failed","title":"Authentication Failed","text":"<pre><code>Authentication failed for user@host\n</code></pre> <p>Solutions: - Verify SSH key is correct - Check ssh-agent is running - Ensure public key is in <code>authorized_keys</code></p>"},{"location":"ssh/#permission-denied","title":"Permission Denied","text":"<pre><code>Permission denied (publickey,password)\n</code></pre> <p>Solutions: - Check username is correct - Verify key permissions (600 for private key) - Try with password authentication</p>"},{"location":"ssh/#jump-host-issues","title":"Jump Host Issues","text":"<pre><code>Failed to connect through jump host\n</code></pre> <p>Solutions: - Verify jump host is accessible - Check jump host authentication - Ensure target is reachable from jump host</p>"},{"location":"ssh/#host-key-verification","title":"Host Key Verification","text":"<pre><code>Host key verification failed\n</code></pre> <p>Solutions: - Add host to <code>~/.ssh/known_hosts</code> - Or enable auto-add (less secure)</p>"},{"location":"ssh/#privilege-elevation","title":"Privilege Elevation","text":"<p>Merlya automatically handles privilege elevation (sudo, doas, su) on remote hosts with an auto-healing fallback system.</p>"},{"location":"ssh/#automatic-detection","title":"Automatic Detection","text":"<p>When connecting to a host, Merlya detects available elevation methods:</p> <ol> <li>sudo NOPASSWD - Tests <code>sudo -n true</code> (non-interactive)</li> <li>doas NOPASSWD - Common on BSD systems</li> <li>sudo with password - User is in sudoers, needs password</li> <li>doas with password - doas available, needs password</li> <li>su - Last resort, requires root password</li> </ol>"},{"location":"ssh/#smart-sudo-detection","title":"Smart sudo Detection","text":"<p>Merlya distinguishes between:</p> <ul> <li>sudo available - User is in sudoers, just needs password</li> <li>sudo not authorized - User is NOT in sudoers \u2192 falls back to su</li> </ul> <p>This prevents failed attempts with sudo when su is the only option.</p>"},{"location":"ssh/#method-priority","title":"Method Priority","text":"<pre><code>1. sudo (NOPASSWD)      - Best: no password needed\n2. doas (NOPASSWD)      - Common on BSD\n3. sudo_with_password   - Fallback with password\n4. doas_with_password   - Alternative with password\n5. su                   - Last resort (root password)\n</code></pre>"},{"location":"ssh/#auto-healing-fallback","title":"Auto-Healing Fallback","text":"<p>When an elevation method fails (wrong password), Merlya:</p> <ol> <li>Verifies the password with a test command (<code>whoami</code>)</li> <li>Marks failed methods to avoid retry loops</li> <li>Tries next method in the chain automatically</li> <li>Caches passwords only after verification succeeds</li> </ol> <p>This ensures Merlya eventually finds a working elevation method.</p>"},{"location":"ssh/#elevation-commands","title":"Elevation Commands","text":"<pre><code># Detect elevation capabilities on a host\n/ssh elevation detect &lt;host&gt;\n\n# Show elevation status and failed methods\n/ssh elevation status &lt;host&gt;\n\n# Reset failed methods to retry with new password\n/ssh elevation reset [host]\n</code></pre>"},{"location":"ssh/#password-handling","title":"Password Handling","text":"<p>Elevation passwords are stored securely:</p> <ol> <li>Keyring storage - macOS Keychain, Linux Secret Service</li> <li>Verification first - Passwords tested before caching</li> <li>Reference tokens - Commands use <code>@elevation:hostname:password</code></li> <li>Safe logging - Logs show <code>@elevation:...</code>, never actual passwords</li> </ol>"},{"location":"ssh/#usage-in-commands","title":"Usage in Commands","text":"<p>Merlya handles elevation automatically:</p> <pre><code>&gt; Read /var/log/secure on @web01\n# Merlya detects \"Permission denied\"\n# Prompts for elevation if needed\n# Verifies password works\n# Caches for future commands\n</code></pre> <p>You can also explicitly request elevation:</p> <pre><code>&gt; Run 'systemctl restart nginx' on @web01 with sudo\n&gt; Execute 'cat /etc/shadow' on @db01 as root\n</code></pre>"},{"location":"ssh/#secret-references","title":"Secret References","text":"<p>For commands requiring passwords, use secret references:</p> <pre><code>&gt; Connect to MongoDB with password @db-prod-password on @db01\n</code></pre> <p>Secret references (<code>@name</code>) are: - Stored in system keyring - Resolved at execution time - Never appear in logs</p>"},{"location":"ssh/#elevation-configuration","title":"Elevation Configuration","text":"<p>Per-host elevation settings are cached in host metadata:</p> <pre><code>/hosts show @web01\n# Shows detected elevation method\n</code></pre>"},{"location":"ssh/#troubleshooting_1","title":"Troubleshooting","text":""},{"location":"ssh/#permission-denied-persists","title":"\"Permission denied\" persists","text":"<p>Solutions: - Check user has sudo/doas access on target - Run <code>/ssh elevation detect &lt;host&gt;</code> to check capabilities - Verify <code>/etc/sudoers</code> configuration - Try explicit elevation: <code>run as root</code></p>"},{"location":"ssh/#wrong-password-loops","title":"Wrong password loops","text":"<p>Merlya prevents infinite loops by tracking failed methods:</p> <pre><code># Check which methods have failed\n/ssh elevation status &lt;host&gt;\n\n# Reset to try again with correct password\n/ssh elevation reset &lt;host&gt;\n</code></pre>"},{"location":"ssh/#user-not-in-sudoers","title":"User not in sudoers","text":"<p>If <code>/ssh elevation detect</code> shows \"user NOT in sudoers\": - Merlya will automatically fall back to su - Or add the user to sudoers on the remote host</p>"},{"location":"ssh/#password-prompt-loops","title":"Password prompt loops","text":"<p>Solutions: - Clear cached password: <code>/secret delete elevation:hostname:password</code> - Reset elevation: <code>/ssh elevation reset &lt;host&gt;</code> - Check password is correct - Verify sudo doesn't require TTY (<code>requiretty</code> in sudoers)</p>"},{"location":"ssh/#security-best-practices","title":"Security Best Practices","text":"<ol> <li>Use SSH keys instead of passwords</li> <li>Use SSH agent to avoid passphrase prompts</li> <li>Use jump hosts for internal servers</li> <li>Limit pool timeout for sensitive environments</li> <li>Audit SSH keys regularly with <code>/scan --security</code></li> <li>Use NOPASSWD sudo for automation accounts</li> <li>Never embed passwords in commands - use <code>@secret</code> references</li> </ol>"},{"location":"tools/","title":"Agent Tools","text":"<p>The Merlya agent has access to 50+ tools for infrastructure management.</p>"},{"location":"tools/#core-tools","title":"Core Tools","text":""},{"location":"tools/#list_hosts","title":"<code>list_hosts</code>","text":"<p>List hosts from inventory.</p> <p>Parameters: - <code>tag</code> (optional): Filter by tag - <code>status</code> (optional): Filter by health status - <code>limit</code> (default: 50): Max results (1-1000)</p> <p>Example prompts: - \"Show me all production servers\" - \"List hosts tagged with database\"</p>"},{"location":"tools/#get_host","title":"<code>get_host</code>","text":"<p>Get detailed information about a specific host.</p> <p>Parameters: - <code>name</code>: Host name - <code>include_metadata</code> (default: true): Include enriched metadata</p> <p>Returns: id, name, hostname, port, username, tags, health_status, OS info, metadata</p>"},{"location":"tools/#bash_execute","title":"<code>bash_execute</code>","text":"<p>Execute a command locally on the Merlya host machine.</p> <p>Parameters: - <code>command</code>: Command to execute - <code>timeout</code> (default: 60): Command timeout in seconds (1-3600)</p> <p>Use cases: - kubectl, aws, gcloud, az CLI commands - docker commands (local daemon) - Local file operations - Any CLI tool installed locally</p> <p>Note: Dangerous commands are blocked (rm -rf /, mkfs, dd to devices, etc.).</p>"},{"location":"tools/#ssh_execute","title":"<code>ssh_execute</code>","text":"<p>Execute a command on a remote host via SSH with automatic elevation.</p> <p>Parameters: - <code>host</code>: Target host name (inventory entry or direct hostname/IP) - <code>command</code>: Command to execute (supports @secret-name references) - <code>timeout</code> (default: 60): Command timeout in seconds - <code>connect_timeout</code> (optional): Connection timeout - <code>elevation</code> (optional): Prepared elevation payload - <code>via</code> (optional): Jump host/bastion for SSH tunneling - <code>auto_elevate</code> (default: true): Auto-retry with elevation on permission errors</p> <p>Returns: stdout, stderr, exit_code, host, command, elevation method, jump host</p> <p>Features: - Automatic privilege elevation (sudo, doas, su) - Jump host support - Password detection and warning - Secret reference resolution</p>"},{"location":"tools/#ask_user","title":"<code>ask_user</code>","text":"<p>Ask the user for input.</p> <p>Parameters: - <code>question</code>: Question to ask - <code>choices</code> (optional): List of valid choices - <code>default</code> (optional): Default value - <code>secret</code> (default: false): Whether to hide input</p>"},{"location":"tools/#request_confirmation","title":"<code>request_confirmation</code>","text":"<p>Request user confirmation before an action.</p> <p>Parameters: - <code>action</code>: Description of the action - <code>details</code> (optional): Additional details - <code>risk_level</code> (default: \"moderate\"): low, moderate, high, critical</p> <p>Returns: True/False confirmation</p>"},{"location":"tools/#get_variable","title":"<code>get_variable</code>","text":"<p>Get a variable value.</p> <p>Parameters: - <code>name</code>: Variable name</p>"},{"location":"tools/#set_variable","title":"<code>set_variable</code>","text":"<p>Set a variable.</p> <p>Parameters: - <code>name</code>: Variable name - <code>value</code>: Variable value - <code>is_env</code> (default: false): Export as environment variable</p> <p>Security: Blocks setting dangerous environment variables (PATH, LD_PRELOAD, etc.)</p>"},{"location":"tools/#system-tools","title":"System Tools","text":""},{"location":"tools/#get_system_info","title":"<code>get_system_info</code>","text":"<p>Get OS and system information from a host.</p> <p>Parameters: - <code>host</code>: Target host name</p> <p>Returns: hostname, OS, kernel, architecture, uptime, load average</p>"},{"location":"tools/#check_cpu","title":"<code>check_cpu</code>","text":"<p>Check CPU usage on a host.</p> <p>Parameters: - <code>host</code>: Target host name - <code>threshold</code> (default: 80): Warning threshold percentage</p> <p>Returns: load_1m, load_5m, load_15m, cpu_count, use_percent, warning flag</p>"},{"location":"tools/#check_memory","title":"<code>check_memory</code>","text":"<p>Check memory usage on a host.</p> <p>Parameters: - <code>host</code>: Target host name - <code>threshold</code> (default: 90): Warning threshold percentage</p> <p>Returns: total_mb, used_mb, available_mb, buffers_mb, cached_mb, use_percent, warning flag</p>"},{"location":"tools/#check_disk_usage","title":"<code>check_disk_usage</code>","text":"<p>Check disk usage on a specific filesystem.</p> <p>Parameters: - <code>host</code>: Target host name - <code>path</code> (default: \"/\"): Filesystem path - <code>threshold</code> (default: 90): Warning threshold percentage</p> <p>Returns: filesystem, size, used, available, use_percent, mount point, warning flag</p>"},{"location":"tools/#check_all_disks","title":"<code>check_all_disks</code>","text":"<p>Check disk usage on all mounted filesystems.</p> <p>Parameters: - <code>host</code>: Target host name - <code>threshold</code> (default: 90): Warning threshold percentage - <code>exclude_types</code> (optional): Filesystem types to exclude</p> <p>Returns: List of disk info, total_count, warnings count</p>"},{"location":"tools/#list_processes","title":"<code>list_processes</code>","text":"<p>List running processes on a host.</p> <p>Parameters: - <code>host</code>: Target host name - <code>user</code> (optional): Filter by user - <code>filter_name</code> (optional): Filter by process name - <code>limit</code> (default: 20): Max processes (1-1000) - <code>sort_by</code> (default: \"cpu\"): cpu, mem, pid</p> <p>Returns: List of processes with user, pid, cpu%, mem%, command</p>"},{"location":"tools/#check_service_status","title":"<code>check_service_status</code>","text":"<p>Check the status of a systemd service.</p> <p>Parameters: - <code>host</code>: Target host name - <code>service</code>: Service name</p> <p>Returns: service status, active state, sub state, main PID</p>"},{"location":"tools/#manage_service","title":"<code>manage_service</code>","text":"<p>Manage a systemd service.</p> <p>Parameters: - <code>host</code>: Target host name - <code>service</code>: Service name - <code>action</code>: start, stop, restart, reload, status, enable, disable - <code>force</code> (default: false): Skip confirmation for dangerous actions</p> <p>Security: Critical services (sshd, networking, docker) require extra confirmation</p>"},{"location":"tools/#list_services","title":"<code>list_services</code>","text":"<p>List services on a host.</p> <p>Parameters: - <code>host</code>: Target host name - <code>filter_state</code> (optional): Filter by state</p>"},{"location":"tools/#analyze_logs","title":"<code>analyze_logs</code>","text":"<p>Analyze log files on a host.</p> <p>Parameters: - <code>host</code>: Target host name - <code>log_path</code> (default: \"/var/log/syslog\"): Path to log file - <code>pattern</code> (optional): Grep pattern to filter - <code>lines</code> (default: 50): Number of lines (1-10000) - <code>level</code> (optional): error, warn, info, debug</p> <p>Returns: log entries list and count</p>"},{"location":"tools/#check_docker","title":"<code>check_docker</code>","text":"<p>Check Docker status and containers.</p> <p>Parameters: - <code>host</code>: Target host name</p> <p>Returns: Docker status, containers list, images list</p>"},{"location":"tools/#health_summary","title":"<code>health_summary</code>","text":"<p>Get consolidated health view across hosts.</p> <p>Parameters: - <code>hosts</code>: List of host names</p> <p>Returns: Aggregated health summary</p>"},{"location":"tools/#list_cron","title":"<code>list_cron</code>","text":"<p>List crontab entries on a host.</p> <p>Parameters: - <code>host</code>: Target host name - <code>user</code> (optional): Specific user - <code>include_system</code> (default: true): Include /etc/cron.*</p> <p>Returns: cron entries list</p>"},{"location":"tools/#network-tools","title":"Network Tools","text":""},{"location":"tools/#check_network","title":"<code>check_network</code>","text":"<p>Perform network diagnostics from a remote host.</p> <p>Parameters: - <code>host</code>: Target host name - <code>target</code> (optional): Specific target to check - <code>check_dns</code> (default: true): Check DNS resolution - <code>check_gateway</code> (default: true): Check default gateway - <code>check_internet</code> (default: true): Check internet connectivity</p> <p>Returns: interface info, gateway, DNS, internet status, issues list</p>"},{"location":"tools/#ping","title":"<code>ping</code>","text":"<p>Ping a target from a remote host.</p> <p>Parameters: - <code>host</code>: Source host name - <code>target</code>: Target to ping - <code>count</code> (default: 4, max: 10): Number of packets - <code>timeout</code> (default: 5, max: 30): Timeout in seconds</p> <p>Returns: target, reachable, packets sent/received, packet_loss%, RTT min/avg/max</p>"},{"location":"tools/#traceroute","title":"<code>traceroute</code>","text":"<p>Run traceroute from a remote host.</p> <p>Parameters: - <code>host</code>: Source host name - <code>target</code>: Target to trace - <code>max_hops</code> (default: 20, max: 30): Maximum hops</p> <p>Returns: traceroute output and parsed hops</p>"},{"location":"tools/#check_port","title":"<code>check_port</code>","text":"<p>Check if a port is reachable from a remote host.</p> <p>Parameters: - <code>host</code>: Source host name - <code>target_host</code>: Target to check - <code>port</code>: Port number (1-65535) - <code>timeout</code> (default: 5): Connection timeout</p> <p>Returns: port status, open flag, response_time_ms</p>"},{"location":"tools/#dns_lookup","title":"<code>dns_lookup</code>","text":"<p>Perform DNS lookup from a remote host.</p> <p>Parameters: - <code>host</code>: Source host name - <code>query</code>: Domain to lookup - <code>record_type</code> (default: \"A\"): A, AAAA, MX, NS, TXT, CNAME, SOA, PTR</p> <p>Returns: DNS records list, resolved flag, response_time_ms</p>"},{"location":"tools/#file-tools","title":"File Tools","text":""},{"location":"tools/#read_file","title":"<code>read_file</code>","text":"<p>Read file content from a remote host.</p> <p>Parameters: - <code>host_name</code>: Target host - <code>path</code>: File path - <code>lines</code> (optional): Number of lines (1-100000) - <code>tail</code> (default: false): Read from end of file</p>"},{"location":"tools/#write_file","title":"<code>write_file</code>","text":"<p>Write content to a file on a remote host.</p> <p>Parameters: - <code>host_name</code>: Target host - <code>path</code>: File path - <code>content</code>: Content to write - <code>mode</code> (default: \"0644\"): File permissions - <code>backup</code> (default: true): Create backup before writing</p> <p>Security: Uses base64 encoding for safe transfer</p>"},{"location":"tools/#list_directory","title":"<code>list_directory</code>","text":"<p>List directory contents on a remote host.</p> <p>Parameters: - <code>host_name</code>: Target host - <code>path</code>: Directory path - <code>all_files</code> (default: false): Include hidden files - <code>long_format</code> (default: false): Detailed listing</p>"},{"location":"tools/#file_exists","title":"<code>file_exists</code>","text":"<p>Check if a file exists on a remote host.</p> <p>Parameters: - <code>host_name</code>: Target host - <code>path</code>: File path</p> <p>Returns: \"exists\" or \"not_found\"</p>"},{"location":"tools/#file_info","title":"<code>file_info</code>","text":"<p>Get file information (stat) from a remote host.</p> <p>Parameters: - <code>host_name</code>: Target host - <code>path</code>: File path</p> <p>Returns: name, size, owner, group, mode, modified timestamp</p>"},{"location":"tools/#search_files","title":"<code>search_files</code>","text":"<p>Search for files on a remote host.</p> <p>Parameters: - <code>host_name</code>: Target host - <code>path</code>: Search path - <code>pattern</code>: File name pattern (1-256 chars) - <code>file_type</code> (optional): f (file), d (directory) - <code>max_depth</code> (optional): Maximum search depth (1-100)</p> <p>Returns: List of matching file paths</p>"},{"location":"tools/#delete_file","title":"<code>delete_file</code>","text":"<p>Delete a file on a remote host.</p> <p>Parameters: - <code>host_name</code>: Target host - <code>path</code>: File path - <code>force</code> (default: false): Skip confirmation</p> <p>Security: Refuses to delete system paths (/etc, /var, /usr, /home, /root, /bin, /sbin)</p>"},{"location":"tools/#upload_file","title":"<code>upload_file</code>","text":"<p>Upload a local file to a remote host via SFTP.</p> <p>Parameters: - <code>host_name</code>: Target host - <code>local_path</code>: Local file path - <code>remote_path</code>: Remote destination path - <code>max_size</code> (default: 100MB): Maximum file size</p>"},{"location":"tools/#download_file","title":"<code>download_file</code>","text":"<p>Download a file from a remote host via SFTP.</p> <p>Parameters: - <code>host_name</code>: Source host - <code>remote_path</code>: Remote file path - <code>local_path</code> (optional): Local destination path</p>"},{"location":"tools/#compare_files","title":"<code>compare_files</code>","text":"<p>Compare files between two hosts or between host and local.</p> <p>Parameters: - <code>host1</code>: First host (or \"local\") - <code>path1</code>: Path on first host - <code>host2</code> (optional): Second host (or \"local\") - <code>path2</code> (optional): Path on second host - <code>show_diff</code> (default: true): Include diff output - <code>context_lines</code> (default: 3): Lines of context in diff</p> <p>Returns: identical flag, hashes, sizes, diff lines, additions/deletions/changes</p>"},{"location":"tools/#security-tools","title":"Security Tools","text":""},{"location":"tools/#check_open_ports","title":"<code>check_open_ports</code>","text":"<p>Check open ports on a remote host.</p> <p>Parameters: - <code>host_name</code>: Target host - <code>include_listening</code> (default: true): Include listening ports - <code>include_established</code> (default: false): Include established connections</p> <p>Uses: ss (Linux) or netstat (fallback)</p>"},{"location":"tools/#audit_ssh_keys","title":"<code>audit_ssh_keys</code>","text":"<p>Audit SSH keys on a remote host.</p> <p>Parameters: - <code>host_name</code>: Target host</p> <p>Returns: paths, permissions, key types, severity issues</p> <p>Security: Validates key paths, checks permissions (should be 600)</p>"},{"location":"tools/#check_security_config","title":"<code>check_security_config</code>","text":"<p>Check security configuration on a remote host.</p> <p>Parameters: - <code>host_name</code>: Target host</p> <p>Checks: PermitRootLogin, PasswordAuthentication, PubkeyAuthentication, PermitEmptyPasswords, firewall status</p>"},{"location":"tools/#check_users","title":"<code>check_users</code>","text":"<p>Audit user accounts on a remote host.</p> <p>Parameters: - <code>host_name</code>: Target host</p> <p>Returns: users with shell access, empty password issues, severity levels</p>"},{"location":"tools/#check_sudo_config","title":"<code>check_sudo_config</code>","text":"<p>Check sudoers configuration.</p> <p>Parameters: - <code>host_name</code>: Target host</p> <p>Returns: sudo configuration audit</p>"},{"location":"tools/#check_critical_services","title":"<code>check_critical_services</code>","text":"<p>Check critical services status.</p> <p>Parameters: - <code>host_name</code>: Target host</p> <p>Services checked: sshd, firewalld/ufw, fail2ban</p>"},{"location":"tools/#check_failed_logins","title":"<code>check_failed_logins</code>","text":"<p>Check failed login attempts (24h lookback).</p> <p>Parameters: - <code>host_name</code>: Target host</p> <p>Returns: failed login analysis, top offending IPs</p> <p>Severity: Critical (&gt;50 attempts), Warning (&gt;20 attempts)</p>"},{"location":"tools/#check_pending_updates","title":"<code>check_pending_updates</code>","text":"<p>Check for pending system updates.</p> <p>Parameters: - <code>host_name</code>: Target host</p> <p>Detects: apt, dnf, yum package managers</p> <p>Severity: Critical (&gt;5 security updates), Warning (&gt;10 total updates)</p>"},{"location":"tools/#check_ssl_certs","title":"<code>check_ssl_certs</code>","text":"<p>Check SSL certificates on a host.</p> <p>Parameters: - <code>host_name</code>: Target host</p> <p>Returns: SSL certificate information, expiry warnings</p>"},{"location":"tools/#web-tools","title":"Web Tools","text":""},{"location":"tools/#search_web","title":"<code>search_web</code>","text":"<p>Perform a web search using DuckDuckGo.</p> <p>Parameters: - <code>query</code>: Search query - <code>max_results</code> (default: 5, max: 10): Maximum results - <code>region</code> (optional): Region code (e.g., \"fr-fr\", \"us-en\") - <code>safesearch</code> (default: \"moderate\"): off, moderate, strict - <code>timeout</code> (default: 8.0): Max time in seconds</p> <p>Returns: results list (title, url, snippet), count, cached flag</p> <p>Features: Built-in caching (60s TTL)</p>"},{"location":"tools/#interaction-tools","title":"Interaction Tools","text":""},{"location":"tools/#request_credentials","title":"<code>request_credentials</code>","text":"<p>Prompt the user for credentials.</p> <p>Parameters: - <code>service</code>: Service name (e.g., mysql, mongo, api) - <code>host</code> (optional): Host context - <code>fields</code> (optional): Fields to collect (default: username, password) - <code>format_hint</code> (optional): token, json, passphrase, key - <code>allow_store</code> (default: true): Offer storage in keyring</p> <p>Returns: credential bundle with service, host, values dict, stored flag</p>"},{"location":"tools/#request_elevation","title":"<code>request_elevation</code>","text":"<p>Request privilege elevation.</p> <p>Parameters: - <code>host</code>: Target host - <code>method</code> (optional): sudo, doas, su</p> <p>Returns: Elevation payload for use with ssh_execute</p>"},{"location":"tools/#tool-selection","title":"Tool Selection","text":"<p>The router suggests tools based on user intent:</p> Intent Keywords Tools Activated cpu, memory, disk, process system file, log, config, read, write files port, firewall, ssh, security security network, ping, dns, traceroute network docker, container docker kubernetes, k8s, pod bash (kubectl) aws, gcloud, az, terraform bash (cloud CLI) search, find, google web <p>When to use bash_execute vs ssh_execute: - <code>bash_execute</code>: Local tools (kubectl, aws, docker, gcloud, az, terraform, etc.) - <code>ssh_execute</code>: Commands on remote servers via SSH</p> <p>The agent may use additional tools based on context and reasoning.</p>"},{"location":"architecture/decisions/","title":"Architecture Decisions","text":"<p>Key architectural decisions and their rationale.</p>"},{"location":"architecture/decisions/#overview","title":"Overview","text":"<p>Merlya is built on a modular architecture designed for extensibility, security, and ease of use.</p> <pre><code>graph TB\n    subgraph \"User Interface\"\n        CLI[CLI / REPL]\n    end\n\n    subgraph \"Core\"\n        Router[Intent Router]\n        Context[Context Manager]\n        Agent[PydanticAI Agent]\n    end\n\n    subgraph \"Tools\"\n        SSH[SSH Tools]\n        System[System Tools]\n        Security[Security Tools]\n    end\n\n    subgraph \"Providers\"\n        OpenAI[OpenAI]\n        Anthropic[Anthropic]\n        Ollama[Ollama]\n    end\n\n    CLI --&gt; Router\n    Router --&gt; Agent\n    Agent --&gt; Context\n    Agent --&gt; SSH\n    Agent --&gt; System\n    Agent --&gt; Security\n    Agent --&gt; OpenAI\n    Agent --&gt; Anthropic\n    Agent --&gt; Ollama</code></pre>"},{"location":"architecture/decisions/#adr-001-pydanticai-for-agent-framework","title":"ADR-001: PydanticAI for Agent Framework","text":"<p>Status: Accepted</p> <p>Context: We needed a framework for building LLM-powered agents with tool calling capabilities.</p> <p>Decision: Use PydanticAI as the agent framework.</p> <p>Rationale: - Type-safe with Pydantic models - Native async support - Clean tool definition API - Multi-provider support - Active development and community</p> <p>Consequences: - Dependency on PydanticAI - Benefits from upstream improvements - May need to adapt to API changes</p>"},{"location":"architecture/decisions/#adr-002-asyncssh-for-ssh-connections","title":"ADR-002: AsyncSSH for SSH Connections","text":"<p>Status: Accepted</p> <p>Context: SSH connectivity is core to Merlya's functionality.</p> <p>Decision: Use asyncssh for all SSH operations.</p> <p>Rationale: - Pure Python, no external dependencies - Async-native for concurrent connections - Full SSH2 protocol support - Jump host support built-in - Active maintenance</p> <p>Consequences: - Async-only API - Connection pooling needed for performance - Memory overhead for many connections</p>"},{"location":"architecture/decisions/#adr-003-connection-pooling","title":"ADR-003: Connection Pooling","text":"<p>Status: Accepted</p> <p>Context: Frequent SSH connections are slow and resource-intensive.</p> <p>Decision: Implement connection pooling with automatic cleanup.</p> <p>Rationale: - Avoid connection overhead for repeated commands - Limit concurrent connections - Automatic cleanup of idle connections - Graceful shutdown handling</p> <p>Implementation: <pre><code>class SSHPool:\n    max_connections: int = 10\n    idle_timeout: int = 300  # 5 minutes\n\n    async def get_connection(host) -&gt; SSHConnection\n    async def release_connection(conn)\n    async def cleanup_idle()\n</code></pre></p>"},{"location":"architecture/decisions/#adr-004-keyring-for-credential-storage","title":"ADR-004: Keyring for Credential Storage","text":"<p>Status: Accepted</p> <p>Context: API keys and credentials need secure storage.</p> <p>Decision: Use the system keyring (via <code>keyring</code> library).</p> <p>Rationale: - OS-level security (Keychain, Secret Service, Credential Manager) - No plaintext secrets in config files - Standard cross-platform solution - Fallback to in-memory with warning</p> <p>Consequences: - Requires keyring backend on Linux - May need user interaction for first-time setup - Headless servers need alternative setup</p>"},{"location":"architecture/decisions/#adr-005-local-intent-classification","title":"ADR-005: Local Intent Classification","text":"<p>Status: Accepted</p> <p>Context: Not all user inputs require LLM processing.</p> <p>Decision: Use ONNX-based local classifier for intent routing.</p> <p>Rationale: - Fast (&lt; 10ms) classification - No API calls for simple intents - Works offline - Reduces API costs</p> <p>Implementation: <pre><code>User Input \u2192 Intent Classifier \u2192 [Simple Intent] \u2192 Direct Handler\n                              \u2192 [Complex Intent] \u2192 LLM Agent\n</code></pre></p> <p>Consequences: - Additional model file (~50MB) - Needs training data for new intents - May misclassify edge cases</p>"},{"location":"architecture/decisions/#adr-006-yaml-configuration-with-sqlite-storage","title":"ADR-006: YAML Configuration with SQLite Storage","text":"<p>Status: Accepted</p> <p>Context: Configuration needs to be human-readable and editable. Host inventory requires structured storage with querying capabilities.</p> <p>Decision: Use YAML for configuration files and SQLite for host inventory.</p> <p>Rationale: - YAML: Human-friendly syntax, widely used in DevOps - YAML: Native support for complex structures - SQLite: Fast querying for host lookups - SQLite: Supports tagging, filtering, and search - SQLite: Single file, no server needed</p> <p>File Locations: - <code>~/.merlya/config.yaml</code> - Main configuration - <code>~/.merlya/merlya.db</code> - Host inventory (SQLite) - <code>~/.merlya/logs/</code> - Log files - <code>~/.merlya/history</code> - Command history</p> <p>Configuration Example: <pre><code>general:\n  language: en\n  log_level: info\n\nmodel:\n  provider: openrouter\n  model: amazon/nova-2-lite-v1:free\n\nssh:\n  connect_timeout: 30\n  pool_timeout: 600\n</code></pre></p>"},{"location":"architecture/decisions/#adr-007-plugin-architecture","title":"ADR-007: Plugin Architecture","text":"<p>Status: Proposed</p> <p>Context: Users need to extend Merlya with custom tools.</p> <p>Decision: Entry-point based plugin system.</p> <p>Rationale: - Standard Python packaging approach - Easy distribution via PyPI - Namespace isolation - Lazy loading</p> <p>Proposed Interface: <pre><code># pyproject.toml\n[project.entry-points.\"merlya.tools\"]\nmy_tool = \"my_package:MyTool\"\n\n# Implementation\nclass MyTool(MerlyaTool):\n    name = \"my_tool\"\n    description = \"Does something useful\"\n\n    async def execute(self, params: dict) -&gt; ToolResult:\n        ...\n</code></pre></p>"},{"location":"architecture/decisions/#adr-008-loguru-for-logging","title":"ADR-008: Loguru for Logging","text":"<p>Status: Accepted</p> <p>Context: Debugging and monitoring require good logging with minimal configuration.</p> <p>Decision: Use loguru for logging.</p> <p>Rationale: - Zero-configuration out of the box - Automatic rotation and retention - Human-readable colored output for development - Exception catching with full traceback - Easy to use API (<code>logger.info()</code>, <code>logger.error()</code>) - Async-safe</p> <p>Implementation: <pre><code>from loguru import logger\n\nlogger.info(\"\u2705 Operation completed successfully\")\nlogger.warning(\"\u26a0\ufe0f Connection retry required\")\nlogger.error(\"\u274c SSH connection failed: {error}\", error=e)\n</code></pre></p> <p>Log Levels: - DEBUG: Detailed execution flow - INFO: Key operations and results - WARNING: Recoverable issues - ERROR: Failures requiring attention</p> <p>Emoji Convention: All log messages use emojis for visual clarity (see CONTRIBUTING.md).</p>"},{"location":"architecture/decisions/#adr-009-multi-provider-llm-support","title":"ADR-009: Multi-Provider LLM Support","text":"<p>Status: Accepted</p> <p>Context: Users have different LLM provider preferences and cost constraints.</p> <p>Decision: Abstract LLM provider interface with multiple implementations. OpenRouter as default for free tier access.</p> <p>Supported Providers: - OpenRouter (default) - 100+ models, free tier available - OpenAI (GPT-4o, GPT-4o-mini) - Anthropic (Claude 3.5 Sonnet, Haiku) - Ollama (local models, no API key needed)</p> <p>Interface: <pre><code>class LLMProvider(Protocol):\n    async def generate(prompt: str) -&gt; str\n    async def generate_with_tools(prompt: str, tools: list) -&gt; ToolCall\n</code></pre></p>"},{"location":"architecture/decisions/#adr-010-security-model","title":"ADR-010: Security Model","text":"<p>Status: Accepted</p> <p>Context: Merlya executes commands on remote systems.</p> <p>Decision: Implement defense-in-depth security model.</p> <p>Layers: 1. Credential Protection - Keyring storage 2. Command Review - User confirmation for destructive commands 3. Input Validation - Pydantic models for all inputs 4. Audit Logging - All commands logged 5. Principle of Least Privilege - Minimal permissions</p> <p>Dangerous Command Detection: <pre><code>DANGEROUS_PATTERNS = [\n    r\"rm\\s+-rf\",\n    r\"mkfs\",\n    r\"dd\\s+if=\",\n    r\"&gt;\\s*/dev/\",\n    r\"chmod\\s+777\",\n]\n</code></pre></p>"},{"location":"architecture/decisions/#future-considerations","title":"Future Considerations","text":""},{"location":"architecture/decisions/#under-evaluation","title":"Under Evaluation","text":"<ul> <li>WebSocket support for real-time streaming</li> <li>Kubernetes integration via kubectl</li> <li>Terraform integration for IaC</li> <li>Metrics collection for monitoring dashboards</li> </ul>"},{"location":"architecture/decisions/#rejected","title":"Rejected","text":"<ul> <li>GUI Application - Focus on CLI/API for automation</li> <li>Custom LLM training - Too resource-intensive for scope</li> <li>Multi-tenant SaaS - Security complexity, out of scope</li> </ul>"},{"location":"getting-started/configuration/","title":"Configuration","text":"<p>Merlya uses a layered configuration system with sensible defaults.</p>"},{"location":"getting-started/configuration/#configuration-files","title":"Configuration Files","text":"File Purpose <code>~/.merlya/config.yaml</code> Main configuration <code>~/.merlya/merlya.db</code> Hosts inventory (SQLite) <code>~/.merlya/history</code> Command history <code>~/.merlya/logs/</code> Log files"},{"location":"getting-started/configuration/#configuration-file","title":"Configuration File","text":"<p>Configuration is stored in <code>~/.merlya/config.yaml</code>:</p> <pre><code># ~/.merlya/config.yaml\ngeneral:\n  language: en          # UI language (en, fr)\n  log_level: info       # debug, info, warning, error\n\nmodel:\n  provider: openrouter  # openrouter, anthropic, openai, ollama\n  model: amazon/nova-2-lite-v1:free\n  api_key_env: OPENROUTER_API_KEY\n\nrouter:\n  type: local           # local (ONNX) or llm\n  llm_fallback: openrouter:google/gemini-2.0-flash-lite-001\n\nssh:\n  connect_timeout: 30\n  pool_timeout: 600\n  command_timeout: 60\n</code></pre>"},{"location":"getting-started/configuration/#setting-values","title":"Setting Values","text":"<p>Use the <code>config</code> command to manage settings:</p> <pre><code># Set a value\nmerlya config set model.provider anthropic\n\n# Get a value\nmerlya config get model.provider\n\n# Show all settings\nmerlya config show\n</code></pre>"},{"location":"getting-started/configuration/#environment-variables","title":"Environment Variables","text":"<p>API keys and settings can be set via environment variables:</p> <pre><code>export OPENROUTER_API_KEY=or-xxx\nexport OPENAI_API_KEY=sk-xxx\nexport ANTHROPIC_API_KEY=sk-ant-xxx\nexport OLLAMA_API_KEY=xxx  # For cloud Ollama only\n\n# Override settings\nexport MERLYA_ROUTER_FALLBACK=openai:gpt-4o-mini\n</code></pre>"},{"location":"getting-started/configuration/#llm-configuration","title":"LLM Configuration","text":""},{"location":"getting-started/configuration/#provider-settings","title":"Provider Settings","text":"Setting Description Default <code>model.provider</code> LLM provider <code>openrouter</code> <code>model.model</code> Model name/ID <code>amazon/nova-2-lite-v1:free</code> <code>model.api_key_env</code> Env var name for API key auto <p>Supported Providers:</p> Provider Description <code>openrouter</code> 100+ models, free tier available (default) <code>anthropic</code> Claude models <code>openai</code> GPT models <code>mistral</code> Mistral AI models <code>groq</code> Ultra-fast inference <code>ollama</code> Local or cloud models"},{"location":"getting-started/configuration/#api-keys","title":"API Keys","text":"<p>API keys are stored securely in your system keyring (recommended) or provided via environment variables:</p> <ul> <li>macOS: Keychain</li> <li>Linux: Secret Service (GNOME Keyring, KWallet)</li> <li>Windows: Credential Manager</li> </ul> <pre><code># In the REPL, Merlya can prompt and store your key:\nmerlya\n/model provider openai\n\n# Or in non-interactive environments (CI/CD):\nexport OPENAI_API_KEY=\"...\"\n\n# Keys are never written to config files\ncat ~/.merlya/config.yaml | grep api_key\n# (no output - only api_key_env reference, not the actual key)\n</code></pre>"},{"location":"getting-started/configuration/#ssh-configuration","title":"SSH Configuration","text":"Setting Description Default <code>ssh.connect_timeout</code> Connection timeout (seconds) <code>30</code> <code>ssh.pool_timeout</code> Pool timeout (seconds) <code>600</code> <code>ssh.command_timeout</code> Command execution timeout <code>60</code>"},{"location":"getting-started/configuration/#hosts-management","title":"Hosts Management","text":"<p>Hosts are stored in a SQLite database (<code>~/.merlya/merlya.db</code>) and managed via slash commands:</p> <pre><code># Add a host interactively\n/hosts add web-01\n\n# Import from SSH config\n/hosts import ~/.ssh/config --format=ssh\n\n# Import from /etc/hosts\n/hosts import /etc/hosts --format=etc_hosts\n\n# List all hosts\n/hosts list\n\n# Show host details\n/hosts show web-01\n</code></pre> <p>Supported Import Formats:</p> Format Description <code>ssh</code> SSH config file (<code>~/.ssh/config</code>) <code>etc_hosts</code> Linux <code>/etc/hosts</code> format <code>json</code> JSON array of host objects <code>yaml</code> YAML host configuration <code>csv</code> CSV with columns: name, hostname, port, username"},{"location":"getting-started/configuration/#logging","title":"Logging","text":"<p>Merlya uses loguru for logging.</p> Setting Description Default <code>general.log_level</code> Console log level <code>info</code> <code>logging.file_level</code> File log level <code>debug</code> <code>logging.max_size_mb</code> Max log file size <code>10</code> <p>Logs are stored in <code>~/.merlya/logs/</code>.</p>"},{"location":"getting-started/configuration/#next-steps","title":"Next Steps","text":"<ul> <li>SSH Management Guide</li> <li>LLM Providers Guide</li> <li>Automation Guide</li> </ul>"},{"location":"getting-started/installation/","title":"Installation","text":""},{"location":"getting-started/installation/#requirements","title":"Requirements","text":"<ul> <li>Python 3.11 or higher</li> <li>pip (Python package manager)</li> <li>An LLM provider API key (OpenAI, Anthropic, or local Ollama)</li> </ul>"},{"location":"getting-started/installation/#install-from-pypi","title":"Install from PyPI","text":"<p>The recommended way to install Merlya is via pip:</p> <pre><code>pip install merlya\n</code></pre>"},{"location":"getting-started/installation/#install-from-source","title":"Install from Source","text":"<p>For the latest development version:</p> <pre><code>git clone https://github.com/m-kis/merlya.git\ncd merlya\npip install -e \".[dev]\"\n</code></pre>"},{"location":"getting-started/installation/#verify-installation","title":"Verify Installation","text":"<pre><code>merlya --version\n</code></pre> <p>You should see output like:</p> <pre><code>merlya 0.6.0\n</code></pre>"},{"location":"getting-started/installation/#shell-completion","title":"Shell Completion","text":"BashZshFish <pre><code># Add to ~/.bashrc\neval \"$(_MERLYA_COMPLETE=bash_source merlya)\"\n</code></pre> <pre><code># Add to ~/.zshrc\neval \"$(_MERLYA_COMPLETE=zsh_source merlya)\"\n</code></pre> <pre><code># Add to ~/.config/fish/completions/merlya.fish\n_MERLYA_COMPLETE=fish_source merlya | source\n</code></pre>"},{"location":"getting-started/installation/#next-steps","title":"Next Steps","text":"<ul> <li>Quick Start Guide - Get up and running in 5 minutes</li> <li>Configuration - Configure your LLM provider and settings</li> </ul>"},{"location":"getting-started/quickstart/","title":"Quick Start","text":"<p>Get Merlya up and running in 5 minutes.</p> <p></p>"},{"location":"getting-started/quickstart/#1-first-run-setup-wizard","title":"1. First Run - Setup Wizard","text":"<p>On first launch, Merlya's setup wizard guides you through configuration:</p> <pre><code>merlya\n</code></pre>"},{"location":"getting-started/quickstart/#language-selection","title":"Language Selection","text":"<pre><code>\u256d\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u256e\n\u2502                        Merlya Setup                              \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502  Welcome to Merlya! / Bienvenue dans Merlya!                    \u2502\n\u2502                                                                  \u2502\n\u2502  Select your language / Choisissez votre langue:                \u2502\n\u2502    1. English                                                    \u2502\n\u2502    2. Fran\u00e7ais                                                   \u2502\n\u2570\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u256f\n</code></pre>"},{"location":"getting-started/quickstart/#llm-provider-selection","title":"LLM Provider Selection","text":"<pre><code>\u256d\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u256e\n\u2502                      LLM Configuration                            \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502  1. OpenRouter (recommended - multi-model)                        \u2502\n\u2502  2. Anthropic (Claude direct)                                     \u2502\n\u2502  3. OpenAI (GPT models)                                           \u2502\n\u2502  4. Mistral (Mistral AI)                                          \u2502\n\u2502  5. Groq (fast inference)                                         \u2502\n\u2502  6. Ollama (local models)                                         \u2502\n\u2570\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u256f\n\nSelect provider [1]:\n</code></pre> <p>OpenRouter Recommended</p> <p>OpenRouter offers free models and access to 100+ LLMs. Get your API key at openrouter.ai/keys</p>"},{"location":"getting-started/quickstart/#host-discovery","title":"Host Discovery","text":"<p>The wizard automatically detects hosts from:</p> <ul> <li><code>~/.ssh/config</code> - SSH configuration</li> <li><code>~/.ssh/known_hosts</code> - Previously connected hosts</li> <li><code>/etc/hosts</code> - Local host definitions</li> <li>Ansible inventory files</li> </ul> <pre><code>Detected inventory sources:\n  \u2022 SSH Config: 12 hosts\n  \u2022 Known Hosts: 45 hosts\n\nImport all hosts? [Y/n]:\n</code></pre>"},{"location":"getting-started/quickstart/#2-manual-configuration-alternative","title":"2. Manual Configuration (Alternative)","text":"<p>If you skip the wizard or want to change settings later:</p> Interactive (stores API keys in keyring)CI/CD (API keys via environment variables)Ollama (local) <pre><code>merlya\n# then inside the REPL:\n/model provider openrouter\n/model model amazon/nova-2-lite-v1:free\n</code></pre> <pre><code>export OPENAI_API_KEY=\"...\"\nmerlya config set model.provider openai\nmerlya config set model.model gpt-4o-mini\nmerlya run \"Check disk usage on @web-01\"\n</code></pre> <pre><code># First, install Ollama: https://ollama.com\nollama pull llama3.2\n\nmerlya config set model.provider ollama\nmerlya config set model.model llama3.2\nmerlya run \"Check disk usage on @web-01\"\n</code></pre>"},{"location":"getting-started/quickstart/#3-start-the-repl","title":"3. Start the REPL","text":"<pre><code>merlya\n</code></pre> <p>Use <code>/help</code> to list available commands, and <code>/exit</code> to quit.</p> <p>Experimental Software</p> <p>Always review commands before executing them on production systems.</p>"},{"location":"getting-started/quickstart/#4-try-some-commands","title":"4. Try Some Commands","text":""},{"location":"getting-started/quickstart/#natural-language","title":"Natural Language","text":"<pre><code>Merlya &gt; What can you help me with?\n\nI can help you with:\n- Managing SSH connections to servers\n- Executing commands on remote machines\n- Checking system status and metrics\n- Automating routine DevOps tasks\n\nJust describe what you need in plain English!\n</code></pre>"},{"location":"getting-started/quickstart/#connect-to-a-server","title":"Connect to a Server","text":"<pre><code>Merlya &gt; Connect to my-server.example.com and show me the uptime\n\nConnecting to my-server.example.com...\n\n&gt; ssh my-server.example.com \"uptime\"\n\n 14:32:01 up 45 days,  3:21,  2 users,  load average: 0.15, 0.10, 0.05\n\nThe server has been running for 45 days with low load averages.\n</code></pre>"},{"location":"getting-started/quickstart/#use-mentions","title":"Use @ Mentions","text":"<pre><code>Merlya &gt; Check disk space on @web-01 and @web-02\n\n&gt; ssh web-01 \"df -h /\"\n&gt; ssh web-02 \"df -h /\"\n\nSummary:\n- web-01: 45% used (55GB free)\n- web-02: 62% used (38GB free)\n</code></pre>"},{"location":"getting-started/quickstart/#slash-commands","title":"Slash Commands","text":"<pre><code>Merlya &gt; /hosts\n\nName     | Hostname              | User   | Tags\n---------|----------------------|--------|------------------\nweb-01   | web-01.example.com   | deploy | ssh-config\nweb-02   | web-02.example.com   | deploy | ssh-config\ndb-01    | 10.0.1.50            | admin  | known-hosts\n</code></pre>"},{"location":"getting-started/quickstart/#common-commands","title":"Common Commands","text":"Command Description <code>merlya</code> Start interactive REPL <code>merlya run \"...\"</code> Run command non-interactively <code>merlya config list</code> Show current configuration <code>merlya config set KEY VALUE</code> Set a configuration value <code>/help</code> Show available slash commands <code>/hosts</code> List configured hosts <code>/new</code> Start a new conversation <code>/exit</code> Exit the REPL"},{"location":"getting-started/quickstart/#next-steps","title":"Next Steps","text":"<ul> <li>REPL Mode - Deep dive into the interactive interface</li> <li>Automation Guide - Non-interactive mode, CI/CD, scripting</li> <li>Configuration Guide - Advanced configuration options</li> <li>SSH Management - SSH features and connection pooling</li> <li>LLM Providers - Configure different LLM providers</li> </ul>"},{"location":"guides/automation/","title":"Automation","text":"<p>Automate infrastructure tasks with Merlya's scripting and scheduling capabilities.</p>"},{"location":"guides/automation/#non-interactive-mode","title":"Non-Interactive Mode","text":"<p>Run Merlya commands without interactive prompts:</p> <pre><code># Single command\nmerlya run \"Check disk space on all web servers\"\n\n# From file\nmerlya run --file tasks.txt\n\n# With confirmation disabled (use with caution)\nmerlya run --yes \"Restart nginx on web-01\"\n</code></pre>"},{"location":"guides/automation/#task-files","title":"Task Files","text":"<p>Create reusable task files:</p> <pre><code># tasks/daily-checks.yml\nname: Daily Infrastructure Checks\ntasks:\n  - description: Check disk space\n    prompt: Check disk usage on all servers, warn if above 80%\n\n  - description: Check memory\n    prompt: Check memory usage on all servers\n\n  - description: Check services\n    prompt: Verify nginx and postgres are running on all servers\n</code></pre> <p>Run the task file:</p> <pre><code>merlya run --file tasks/daily-checks.yml\n</code></pre>"},{"location":"guides/automation/#cron-integration","title":"Cron Integration","text":"<p>Schedule Merlya tasks with cron:</p> <pre><code># Edit crontab\ncrontab -e\n\n# Daily health check at 6 AM\n0 6 * * * /usr/local/bin/merlya run \"Run daily health checks\" &gt;&gt; /var/log/merlya-daily.log 2&gt;&amp;1\n\n# Hourly disk check\n0 * * * * /usr/local/bin/merlya run \"Check disk space, alert if above 90%\" &gt;&gt; /var/log/merlya-disk.log 2&gt;&amp;1\n</code></pre>"},{"location":"guides/automation/#webhooks","title":"Webhooks","text":"<p>Trigger Merlya from webhooks:</p> <pre><code>#!/bin/bash\n# webhook-handler.sh\n\nPAYLOAD=$(cat)\nEVENT=$(echo $PAYLOAD | jq -r '.event')\n\ncase $EVENT in\n  \"deploy\")\n    merlya run \"Deploy latest version to staging servers\"\n    ;;\n  \"rollback\")\n    merlya run \"Rollback to previous version on staging\"\n    ;;\n  \"scale-up\")\n    merlya run \"Start 2 additional web servers\"\n    ;;\nesac\n</code></pre>"},{"location":"guides/automation/#cicd-integration","title":"CI/CD Integration","text":""},{"location":"guides/automation/#github-actions","title":"GitHub Actions","text":"<pre><code>name: Deploy with Merlya\n\non:\n  push:\n    branches: [main]\n\njobs:\n  deploy:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n\n      - name: Install Merlya\n        run: pip install merlya\n\n      - name: Configure Merlya\n        env:\n          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}\n        run: |\n          merlya config set model.provider openai\n          merlya config set model.model gpt-4o-mini\n\n      - name: Deploy\n        run: |\n          merlya run --yes \"Deploy the latest code to production servers\"\n</code></pre>"},{"location":"guides/automation/#gitlab-ci","title":"GitLab CI","text":"<pre><code>deploy:\n  stage: deploy\n  script:\n    - pip install merlya\n    - export OPENAI_API_KEY=\"$OPENAI_API_KEY\"\n    - merlya config set model.provider openai\n    - merlya config set model.model gpt-4o-mini\n    - merlya run --yes \"Deploy version $CI_COMMIT_TAG to production\"\n  only:\n    - tags\n</code></pre>"},{"location":"guides/automation/#output-formats","title":"Output Formats","text":"<p>Control output format for automation:</p> <pre><code># JSON output (for parsing)\nmerlya run --format json \"List all servers with high CPU\"\n\n# Quiet mode (only results)\nmerlya run --quiet \"Check nginx status\"\n\n# Verbose mode (full logging)\nmerlya --verbose run \"Deploy to production\"\n</code></pre>"},{"location":"guides/automation/#json-output-example","title":"JSON Output Example","text":"<pre><code>merlya run --format json \"Check disk space on web-01\"\n</code></pre> <pre><code>{\n  \"success\": true,\n  \"total\": 1,\n  \"passed\": 1,\n  \"failed\": 0,\n  \"tasks\": [\n    {\n      \"task\": \"Check disk space on web-01\",\n      \"success\": true,\n      \"message\": \"\u2026\",\n      \"actions\": [\"ssh_execute\"],\n      \"data\": null,\n      \"task_type\": \"agent\"\n    }\n  ]\n}\n</code></pre>"},{"location":"guides/automation/#error-handling","title":"Error Handling","text":"<p>Handle errors in scripts:</p> <pre><code>#!/bin/bash\nset -e\n\n# Run with error handling\nif merlya run --quiet \"Check if all services are healthy\"; then\n    echo \"All services healthy\"\nelse\n    echo \"Service check failed!\"\n    merlya run \"Send alert to ops team about service failures\"\n    exit 1\nfi\n</code></pre>"},{"location":"guides/automation/#logging","title":"Logging","text":"<p>Configure logging for automation:</p> <pre><code># Set console log level (alias: logging.level)\nmerlya config set logging.console_level debug\n\n# Set file log level\nmerlya config set logging.file_level debug\n\n# Run with specific log file\nMERLYA_LOG_FILE=/tmp/task.log merlya run \"Check servers\"\n</code></pre>"},{"location":"guides/automation/#best-practices","title":"Best Practices","text":"<ol> <li>Use <code>--yes</code> carefully - Only for well-tested tasks</li> <li>Log everything - Keep records of automated actions</li> <li>Set timeouts - Prevent hanging tasks</li> <li>Use JSON output - For reliable parsing</li> <li>Test in staging - Before automating production tasks</li> <li>Monitor failures - Set up alerts for failed tasks</li> </ol>"},{"location":"guides/automation/#examples","title":"Examples","text":""},{"location":"guides/automation/#daily-backup-check","title":"Daily Backup Check","text":"<pre><code>#!/bin/bash\n# check-backups.sh\n\nLOG_FILE=\"/var/log/merlya/backup-check.log\"\n\necho \"$(date): Starting backup check\" &gt;&gt; $LOG_FILE\n\nRESULT=$(merlya run --format json \"Verify all database backups from last 24h exist and are valid\")\n\nif echo $RESULT | jq -e '.success' &gt; /dev/null; then\n    echo \"$(date): Backup check passed\" &gt;&gt; $LOG_FILE\nelse\n    echo \"$(date): Backup check FAILED\" &gt;&gt; $LOG_FILE\n    merlya run \"Send urgent alert: backup verification failed\"\nfi\n</code></pre>"},{"location":"guides/automation/#auto-scaling","title":"Auto-Scaling","text":"<pre><code>#!/bin/bash\n# auto-scale.sh\n\nCPU=$(merlya run --format json \"Get average CPU across web tier\" | jq '.cpu_percent')\n\nif (( $(echo \"$CPU &gt; 80\" | bc -l) )); then\n    merlya run --yes \"Scale up web tier by 2 instances\"\nelif (( $(echo \"$CPU &lt; 20\" | bc -l) )); then\n    merlya run --yes \"Scale down web tier by 1 instance (keep minimum 2)\"\nfi\n</code></pre>"},{"location":"guides/llm-providers/","title":"LLM Providers","text":"<p>Merlya supports multiple LLM providers, from cloud APIs to local models.</p>"},{"location":"guides/llm-providers/#supported-providers","title":"Supported Providers","text":"Provider Models Pros Cons OpenRouter 100+ models Free tier, many models Variable latency Anthropic Claude 3.5 Sonnet/Haiku Great reasoning Paid API OpenAI GPT-4o, GPT-4o-mini Fast, reliable Paid API Mistral Mistral Large, Small European, great quality Paid API Groq Llama, Mixtral Extremely fast inference Paid API Ollama Llama, Qwen, Mistral Free, private (local or cloud) Setup required"},{"location":"guides/llm-providers/#openrouter-default","title":"OpenRouter (Default)","text":"<p>OpenRouter is the default provider - it offers access to 100+ models including free options.</p>"},{"location":"guides/llm-providers/#setup","title":"Setup","text":"<pre><code># Option A (recommended): interactive prompt + keyring storage\nmerlya\n/model provider openrouter\n\n# Option B (CI/CD): API key via env var\nexport OPENROUTER_API_KEY=\"...\"\nmerlya config set model.provider openrouter\nmerlya config set model.model amazon/nova-2-lite-v1:free\n</code></pre>"},{"location":"guides/llm-providers/#free-models","title":"Free Models","text":"Model Quality Speed <code>amazon/nova-2-lite-v1:free</code> Good Fast <code>google/gemini-2.0-flash-lite-001</code> Great Fast <code>meta-llama/llama-3.2-3b-instruct:free</code> Good Very fast"},{"location":"guides/llm-providers/#premium-models","title":"Premium Models","text":"Model Quality Cost <code>anthropic/claude-3.5-sonnet</code> Excellent $$ <code>openai/gpt-4o</code> Excellent $$ <code>google/gemini-pro</code> Great $ <p>Get your API key at: openrouter.ai/keys</p>"},{"location":"guides/llm-providers/#anthropic","title":"Anthropic","text":""},{"location":"guides/llm-providers/#setup_1","title":"Setup","text":"<pre><code>export ANTHROPIC_API_KEY=\"...\"\nmerlya config set model.provider anthropic\nmerlya config set model.model claude-3-5-sonnet-latest\n</code></pre>"},{"location":"guides/llm-providers/#recommended-models","title":"Recommended Models","text":"Model Speed Quality Cost <code>claude-3-5-sonnet-latest</code> Fast Excellent $$ <code>claude-3-5-haiku-latest</code> Very fast Great $ <code>claude-3-opus-latest</code> Slow Best $$$"},{"location":"guides/llm-providers/#openai","title":"OpenAI","text":""},{"location":"guides/llm-providers/#setup_2","title":"Setup","text":"<pre><code>export OPENAI_API_KEY=\"...\"\nmerlya config set model.provider openai\nmerlya config set model.model gpt-4o\n</code></pre>"},{"location":"guides/llm-providers/#recommended-models_1","title":"Recommended Models","text":"Model Speed Quality Cost <code>gpt-4o</code> Fast Excellent $$ <code>gpt-4o-mini</code> Very fast Great $ <code>gpt-4-turbo</code> Medium Excellent $$$"},{"location":"guides/llm-providers/#custom-base-url","title":"Custom Base URL","text":"<p>For Azure OpenAI or proxies:</p> <pre><code>merlya config set model.base_url https://your-endpoint.openai.azure.com\n</code></pre>"},{"location":"guides/llm-providers/#mistral","title":"Mistral","text":"<p>European AI provider with strong multilingual support.</p>"},{"location":"guides/llm-providers/#setup_3","title":"Setup","text":"<pre><code>export MISTRAL_API_KEY=\"...\"\nmerlya config set model.provider mistral\nmerlya config set model.model mistral-large-latest\n</code></pre>"},{"location":"guides/llm-providers/#recommended-models_2","title":"Recommended Models","text":"Model Speed Quality Cost <code>mistral-large-latest</code> Fast Excellent $$ <code>mistral-small-latest</code> Very fast Great $ <code>codestral-latest</code> Fast Great for code $$ <p>Get your API key at: console.mistral.ai</p>"},{"location":"guides/llm-providers/#groq","title":"Groq","text":"<p>Ultra-fast inference with custom LPU hardware.</p>"},{"location":"guides/llm-providers/#setup_4","title":"Setup","text":"<pre><code>export GROQ_API_KEY=\"...\"\nmerlya config set model.provider groq\nmerlya config set model.model llama-3.3-70b-versatile\n</code></pre>"},{"location":"guides/llm-providers/#recommended-models_3","title":"Recommended Models","text":"Model Speed Quality Cost <code>llama-3.3-70b-versatile</code> Very fast Excellent $ <code>llama-3.1-8b-instant</code> Ultra fast Good $ <code>mixtral-8x7b-32768</code> Fast Great $ <p>Get your API key at: console.groq.com</p>"},{"location":"guides/llm-providers/#ollama-local-cloud","title":"Ollama (Local + Cloud)","text":"<p>Ollama supports both local and cloud deployment.</p>"},{"location":"guides/llm-providers/#local-setup-free-private","title":"Local Setup (Free, Private)","text":"<pre><code># Install Ollama\ncurl -fsSL https://ollama.com/install.sh | sh\n\n# Pull a model\nollama pull llama3.2\n\n# Configure Merlya\nmerlya config set llm.provider ollama\nmerlya config set llm.model llama3.2\n# Base URL defaults to http://localhost:11434\n</code></pre>"},{"location":"guides/llm-providers/#cloud-setup-ollamacom","title":"Cloud Setup (Ollama.com)","text":"<p>For cloud-hosted Ollama:</p> <pre><code>merlya config set llm.provider ollama\nmerlya config set llm.model llama3.2-cloud  # \"cloud\" suffix triggers cloud mode\nexport OLLAMA_API_KEY=\"...\"\nmerlya config set llm.base_url https://ollama.com/v1\n</code></pre> <p>Automatic Cloud Detection</p> <p>Merlya automatically detects cloud mode when:</p> <ul> <li>Model name contains \"cloud\"</li> <li>Base URL is not localhost/127.0.0.1</li> <li><code>OLLAMA_API_KEY</code> environment variable is set</li> </ul>"},{"location":"guides/llm-providers/#recommended-local-models","title":"Recommended Local Models","text":"Model RAM Quality Speed <code>llama3.2</code> 4GB Great Fast <code>qwen2.5:7b</code> 8GB Excellent Fast <code>mistral-nemo:12b</code> 16GB Excellent Medium <code>codellama:13b</code> 16GB Great for code Medium"},{"location":"guides/llm-providers/#gpu-acceleration","title":"GPU Acceleration","text":"<p>Ollama automatically uses GPU if available:</p> <pre><code># Check GPU usage\nollama ps\n\n# Force CPU only\nOLLAMA_GPU_LAYERS=0 ollama serve\n</code></pre>"},{"location":"guides/llm-providers/#provider-selection-in-setup-wizard","title":"Provider Selection in Setup Wizard","text":"<p>On first run, Merlya's setup wizard offers:</p> <pre><code>\u256d\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u256e\n\u2502                      LLM Configuration                            \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502  1. OpenRouter (recommended - multi-model)                        \u2502\n\u2502  2. Anthropic (Claude direct)                                     \u2502\n\u2502  3. OpenAI (GPT models)                                           \u2502\n\u2502  4. Mistral (Mistral AI)                                          \u2502\n\u2502  5. Groq (fast inference)                                         \u2502\n\u2502  6. Ollama (local models)                                         \u2502\n\u2570\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u256f\n</code></pre>"},{"location":"guides/llm-providers/#router-fallback-model","title":"Router Fallback Model","text":"<p>Merlya uses a separate \"router\" model for intent classification when the local ONNX classifier is unavailable:</p> <pre><code># Configure router fallback (fast, cheap model recommended)\nmerlya config set router.llm_fallback openrouter:google/gemini-2.0-flash-lite-001\n</code></pre>"},{"location":"guides/llm-providers/#switching-providers","title":"Switching Providers","text":"<pre><code># Use OpenRouter for free tier\nmerlya config set model.provider openrouter\nmerlya config set model.model amazon/nova-2-lite-v1:free\n\n# Switch to Anthropic for complex tasks\nmerlya config set model.provider anthropic\n\n# Switch to local Ollama for privacy\nmerlya config set model.provider ollama\nmerlya config set model.model llama3.2\n</code></pre>"},{"location":"guides/llm-providers/#environment-variables","title":"Environment Variables","text":"<p>Override settings with environment variables:</p> <pre><code>export OPENROUTER_API_KEY=or-xxx\nexport ANTHROPIC_API_KEY=sk-ant-xxx\nexport OPENAI_API_KEY=sk-xxx\nexport MISTRAL_API_KEY=xxx\nexport GROQ_API_KEY=gsk_xxx\nexport OLLAMA_API_KEY=xxx  # For cloud Ollama only\nexport OLLAMA_BASE_URL=http://localhost:11434/v1\n</code></pre>"},{"location":"guides/llm-providers/#troubleshooting","title":"Troubleshooting","text":""},{"location":"guides/llm-providers/#api-key-issues","title":"API Key Issues","text":"<pre><code># In the REPL:\n/model show\n\n# Or in CI/CD:\nexport OPENROUTER_API_KEY=\"...\"\n</code></pre>"},{"location":"guides/llm-providers/#keyring-unavailable","title":"Keyring Unavailable","text":"<p>If you see \"Keyring unavailable (in-memory)\" warning:</p> <pre><code># Linux: Install secret service\nsudo apt install gnome-keyring\n\n# macOS: Keychain should work automatically\n\n# Fallback: Use environment variables instead\nexport OPENROUTER_API_KEY=your-key\n</code></pre>"},{"location":"guides/llm-providers/#ollama-not-responding","title":"Ollama Not Responding","text":"<pre><code># Check if Ollama is running\ncurl http://localhost:11434/api/tags\n\n# Start Ollama\nollama serve\n\n# Or restart the service\nsystemctl restart ollama\n</code></pre>"},{"location":"guides/repl-mode/","title":"REPL Mode","text":"<p>Merlya's REPL (Read-Eval-Print Loop) is the main interactive interface for working with your infrastructure.</p>"},{"location":"guides/repl-mode/#starting-the-repl","title":"Starting the REPL","text":"<pre><code>merlya\n</code></pre>"},{"location":"guides/repl-mode/#welcome-screen","title":"Welcome Screen","text":"<p>On startup, Merlya displays a status banner (provider/router/keyring) and an experimental warning. Use <code>/help</code> to see the available slash commands.</p> <p>Experimental Software</p> <p>Merlya is in early development. Always review commands before executing them on production systems.</p>"},{"location":"guides/repl-mode/#features","title":"Features","text":""},{"location":"guides/repl-mode/#natural-language-input","title":"Natural Language Input","text":"<p>Just type your request in plain English (or French):</p> <pre><code>Merlya &gt; Check disk space on all web servers\nMerlya &gt; Red\u00e9marre nginx sur web-01\nMerlya &gt; Show me the logs from the last hour on db-master\n</code></pre>"},{"location":"guides/repl-mode/#autocompletion","title":"Autocompletion","text":"<p>The REPL provides intelligent autocompletion:</p> <ul> <li>Slash commands: Type <code>/</code> and press Tab</li> <li>Host mentions: Type <code>@</code> and press Tab to see available hosts</li> <li>Variable mentions: Type <code>@</code> to reference saved variables</li> </ul>"},{"location":"guides/repl-mode/#mentions","title":"@ Mentions","text":"<p>Reference hosts and variables directly in your prompts:</p> <pre><code>Merlya &gt; Check memory on @web-01 and @web-02\nMerlya &gt; Deploy using @deploy_key credentials\n</code></pre> <p>Mentions are automatically expanded before processing.</p>"},{"location":"guides/repl-mode/#command-history","title":"Command History","text":"<ul> <li>Up/Down arrows: Navigate through previous commands</li> <li>History is persisted across sessions in <code>~/.merlya/history</code></li> </ul>"},{"location":"guides/repl-mode/#slash-commands","title":"Slash Commands","text":"Command Description <code>/help</code> Show available commands <code>/help &lt;command&gt;</code> Show help for a specific command <code>/new [title]</code> Start a new conversation <code>/conv list</code> List saved conversations <code>/conv load &lt;id&gt;</code> Load a previous conversation <code>/hosts</code> List configured hosts <code>/hosts add &lt;name&gt;</code> Add a new host (interactive) <code>/scan</code> Scan for infrastructure <code>/model show</code> Show current model/router status <code>/language &lt;code&gt;</code> Set the REPL language (e.g., <code>/language fr</code>) <code>/exit</code> Exit the REPL"},{"location":"guides/repl-mode/#examples","title":"Examples","text":"<pre><code>Merlya &gt; /help\nMerlya &gt; /hosts\nMerlya &gt; /hosts add prod-db --test\nMerlya &gt; /model provider openai\nMerlya &gt; /model model gpt-4o\nMerlya &gt; /new \"Debugging nginx issue\"\n</code></pre>"},{"location":"guides/repl-mode/#status-indicators","title":"Status Indicators","text":"<p>The welcome screen shows system status:</p> Indicator Meaning \u2705 Feature is working correctly \u26a0\ufe0f Feature has warnings (check message) \u274c Feature is unavailable"},{"location":"guides/repl-mode/#provider-status","title":"Provider Status","text":"<pre><code>Provider: \u2705 openrouter (amazon/nova-2-lite-v1:free)\n</code></pre> <p>Shows the configured LLM provider and model.</p>"},{"location":"guides/repl-mode/#router-status","title":"Router Status","text":"<pre><code>Router: \u2705 local (intent-classifier-v1)\n</code></pre> <ul> <li>local: Using ONNX intent classifier (fast, offline)</li> <li>llm fallback: Using LLM for routing (requires API calls)</li> <li>pattern: Using regex pattern matching (basic)</li> </ul>"},{"location":"guides/repl-mode/#keyring-status","title":"Keyring Status","text":"<pre><code>Keyring: \u2705 Keyring\nKeyring: \u26a0\ufe0f Keyring unavailable (in-memory)\n</code></pre> <p>API keys are stored securely in your system keyring. If unavailable, they're stored in memory only (lost on exit).</p>"},{"location":"guides/repl-mode/#response-format","title":"Response Format","text":"<p>Agent responses include:</p> <pre><code>Merlya &gt; Check uptime on web-01\n\nConnecting to web-01.example.com...\n\n&gt; ssh web-01 \"uptime\"\n\n 14:32:01 up 45 days,  3:21,  2 users,  load average: 0.15, 0.10, 0.05\n\nThe server has been running for 45 days with low load average, indicating\nstable operation and low system stress.\n\nActions: ssh_execute\nSuggestions: Check memory usage, Review recent logs\n</code></pre> <ul> <li>Command output: The actual command executed and its output</li> <li>Analysis: AI-generated analysis of the results</li> <li>Actions: List of tools/actions used</li> <li>Suggestions: Recommended follow-up actions</li> </ul>"},{"location":"guides/repl-mode/#keyboard-shortcuts","title":"Keyboard Shortcuts","text":"Shortcut Action <code>Ctrl+C</code> Cancel current request <code>Ctrl+D</code> Exit REPL <code>Tab</code> Autocomplete <code>\u2191</code> / <code>\u2193</code> Navigate history <code>Ctrl+R</code> Search history"},{"location":"guides/repl-mode/#session-management","title":"Session Management","text":""},{"location":"guides/repl-mode/#new-conversation","title":"New Conversation","text":"<pre><code>Merlya &gt; /new \"Investigating slow queries\"\n</code></pre> <p>Clears history and starts fresh. Optionally provide a title.</p>"},{"location":"guides/repl-mode/#list-conversations","title":"List Conversations","text":"<pre><code>Merlya &gt; /conv list\n\nID      | Title                      | Messages | Last Updated\n--------|----------------------------|----------|-------------\nabc123  | Debugging nginx issue      | 15       | 2 hours ago\ndef456  | Server migration           | 42       | Yesterday\nghi789  | Investigating slow queries | 3        | Just now\n</code></pre>"},{"location":"guides/repl-mode/#load-conversation","title":"Load Conversation","text":"<pre><code>Merlya &gt; /conv load abc123\n\nLoaded conversation: \"Debugging nginx issue\" (15 messages)\n</code></pre>"},{"location":"guides/repl-mode/#tips-for-best-results","title":"Tips for Best Results","text":"<ol> <li>Be specific: \"Check disk space on web-01\" is better than \"check disk\"</li> <li>Provide context: \"The nginx service crashed after the update\"</li> <li>Name your targets: Use <code>@hostname</code> or specify the server explicitly</li> <li>Review before executing: Always check commands before running on production</li> <li>Use slash commands: Quick actions like <code>/hosts</code> are faster than natural language</li> </ol>"},{"location":"guides/repl-mode/#language-support","title":"Language Support","text":"<p>Merlya supports English and French. Set your language:</p> <pre><code>merlya config set general.language fr\n</code></pre> <p>Or use <code>/language fr</code> inside the REPL.</p>"},{"location":"guides/secrets-security/","title":"Secrets: The Red Line for Infrastructure AI Agents","text":"<p>How Merlya guarantees your passwords never end up in logs, the LLM, or stored in plaintext.</p>"},{"location":"guides/secrets-security/#the-problem-with-current-ai-agents","title":"The Problem with Current AI Agents","text":"<p>As an infrastructure engineer, I've tested many AI agents: OpenHands, Gemini CLI, SHAI, and others. The same concerns kept coming back:</p> <ul> <li>Decisions made \"because the model thinks it's better\" \u2014 no justification or traceability</li> <li>Commands executed implicitly \u2014 no explicit confirmation for destructive operations</li> <li>Secrets handled like regular variables \u2014 displayed in logs, sent to APIs</li> <li>Very few usable traces \u2014 impossible to do a post-incident audit</li> </ul> <p>These problems aren't anecdotal. In a production environment, they're deal-breakers.</p>"},{"location":"guides/secrets-security/#merlyas-secret-zero-trust-architecture","title":"Merlya's \"Secret-Zero-Trust\" Architecture","text":"<p>Merlya was designed with a simple philosophy: the LLM must never see secrets.</p>"},{"location":"guides/secrets-security/#the-secrets-flow","title":"The Secrets Flow","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                        SECRETS FLOW                             \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                                 \u2502\n\u2502  1. User enters password                                        \u2502\n\u2502     \u2514\u2500\u2500 prompt_secret() \u2192 System Keyring                        \u2502\n\u2502                                                                 \u2502\n\u2502  2. Merlya stores a REFERENCE                                   \u2502\n\u2502     \u2514\u2500\u2500 @db:password (not the value!)                           \u2502\n\u2502                                                                 \u2502\n\u2502  3. LLM generates a command                                     \u2502\n\u2502     \u2514\u2500\u2500 \"mysql -p @db:password -e 'SELECT 1'\"                   \u2502\n\u2502                                                                 \u2502\n\u2502  4. LATE resolution (execution-time)                            \u2502\n\u2502     \u2514\u2500\u2500 resolve_all_references() \u2192 mysql -p secretvalue         \u2502\n\u2502                                                                 \u2502\n\u2502  5. Return to LLM                                               \u2502\n\u2502     \u2514\u2500\u2500 \"mysql -p *** -e 'SELECT 1'\" (safe_command)             \u2502\n\u2502                                                                 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <p>The secret is never: - Displayed in logs - Sent to the LLM - Stored in plaintext on disk</p>"},{"location":"guides/secrets-security/#layer-1-secure-storage-via-keyring","title":"Layer 1: Secure Storage via Keyring","text":"<p>Secrets are stored in your OS system keyring:</p> OS Backend macOS Keychain Windows Credential Manager Linux Secret Service (GNOME Keyring, KWallet) <pre><code># merlya/secrets/store.py\ndef set(self, name: str, value: str) -&gt; None:\n    if self._keyring_available:\n        keyring.set_password(SERVICE_NAME, name, value)\n    else:\n        self._memory_store[name] = value  # Fallback with warning\n</code></pre> <p>If the keyring isn't available (Docker container without access), Merlya uses in-memory storage with an explicit warning: secrets will be lost on exit.</p>"},{"location":"guides/secrets-security/#layer-2-references-instead-of-values","title":"Layer 2: References Instead of Values","text":"<p>When you enter a password, Merlya never returns it to the LLM. Instead, it generates a reference:</p> <pre><code># merlya/tools/interaction.py\nsafe_values = {}\nfor name, val in values.items():\n    if name.lower() in {\"password\", \"token\", \"secret\", \"key\"}:\n        secret_key = f\"{key_prefix}:{name}\"\n        secret_store.set(secret_key, val)\n        safe_values[name] = f\"@{secret_key}\"  # Reference, not value!\n    else:\n        safe_values[name] = val\n</code></pre> <p>The LLM sees <code>@db:password</code>, never <code>MySuperPassword123!</code>.</p>"},{"location":"guides/secrets-security/#layer-3-late-resolution","title":"Layer 3: Late Resolution","text":"<p><code>@secret-name</code> references are resolved only at execution time, after the LLM has given its instruction:</p> <pre><code># merlya/tools/core/resolve.py\ndef resolve_secrets(command: str, secrets: SecretStore) -&gt; tuple[str, str]:\n    \"\"\"\n    SECURITY: This function should only be called at execution time,\n    never before sending commands to the LLM.\n\n    Returns:\n        Tuple of (resolved_command, safe_command_for_logging).\n    \"\"\"\n    for match in REFERENCE_PATTERN.finditer(command):\n        secret_value = secrets.get(secret_name)\n        resolved = resolved[:start] + secret_value + resolved[end:]\n        safe = safe[:start] + \"***\" + safe[end:]\n    return resolved, safe\n</code></pre> <p>The resolved command (<code>resolved</code>) is executed but never logged or returned to the LLM. Only the masked version (<code>safe</code>) is visible.</p>"},{"location":"guides/secrets-security/#layer-4-proactive-plaintext-password-detection","title":"Layer 4: Proactive Plaintext Password Detection","text":"<p>Merlya blocks commands containing plaintext passwords:</p> <pre><code># merlya/tools/core/security.py\nUNSAFE_PASSWORD_PATTERNS = (\n    re.compile(r\"echo\\s+['\\\"]?(?!@)[^'\\\"]+['\\\"]?\\s*\\|\\s*sudo\\s+-S\"),  # echo 'pass' | sudo\n    re.compile(r\"-p['\\\"][^'\\\"@]+['\\\"]\"),  # mysql -p'password'\n    re.compile(r\"--password[=\\s]+['\\\"]?(?!@)[^@\\s'\\\"]+\"),  # --password=value\n    re.compile(r\"sshpass\\s+-p\\s+['\\\"]?(?!@)[^'\\\"@\\s]+\"),  # sshpass -p password\n    # ... 8 patterns total\n)\n\ndef detect_unsafe_password(command: str) -&gt; str | None:\n    for pattern in UNSAFE_PASSWORD_PATTERNS:\n        if pattern.search(command):\n            return \"SECURITY: Command may contain a plaintext password.\"\n    return None\n</code></pre> <p>If the LLM tries to generate <code>mysql -p'secretvalue'</code> instead of <code>mysql -p @db:password</code>, the command is rejected with a clear error message.</p>"},{"location":"guides/secrets-security/#layer-5-automatic-log-sanitization","title":"Layer 5: Automatic Log Sanitization","text":"<p>Even if a secret passed through the other layers, the audit system would mask it:</p> <pre><code># merlya/audit/logger.py\n_SENSITIVE_KEY_PATTERNS = (\n    \"password\", \"passwd\", \"pwd\", \"secret\", \"key\", \"token\",\n    \"api_key\", \"bearer\", \"jwt\", \"oauth\", \"credential\",\n    \"private_key\", \"ssh_key\", \"id_rsa\", \"certificate\",\n    # ... 30+ patterns\n)\n\n_SENSITIVE_VALUE_PATTERNS = (\n    re.compile(r\"^A[KBS]IA[A-Z0-9]{16}$\"),  # AWS access key\n    re.compile(r\"^gh[pousr]_[A-Za-z0-9_]{36,}$\"),  # GitHub token\n    re.compile(r\"^eyJ[A-Za-z0-9_-]*\\.eyJ\"),  # JWT\n    # ... 9 patterns to detect secrets by their format\n)\n</code></pre> <p>Sanitization is recursive: it traverses nested dicts and lists.</p>"},{"location":"guides/secrets-security/#comparison-with-other-agents","title":"Comparison with Other Agents","text":"Aspect OpenHands Gemini CLI SHAI Merlya Secrets in logs Possible Possible Possible Masked Secrets sent to LLM Yes Yes Yes Never (references) Secure storage Env vars Env vars File OS Keyring Plaintext detection No No No 8 patterns Audit trail Basic Basic Minimal SQLite + SIEM"},{"location":"guides/secrets-security/#concrete-example","title":"Concrete Example","text":""},{"location":"guides/secrets-security/#what-you-type","title":"What you type:","text":"<pre><code>merlya&gt; Connect to the MySQL database on db-prod and list tables\n</code></pre>"},{"location":"guides/secrets-security/#what-the-llm-sees","title":"What the LLM sees:","text":"<pre><code>User: Connect to the MySQL database on db-prod and list tables\nAssistant: I'll request MySQL credentials then list the tables.\n\nTool call: request_credentials(service=\"mysql\", host=\"db-prod\")\nTool result: {\"username\": \"admin\", \"password\": \"@mysql:db-prod:password\"}\n\nTool call: ssh_execute(host=\"db-prod\", command=\"mysql -u admin -p @mysql:db-prod:password -e 'SHOW TABLES'\")\nTool result: {\n  \"stdout\": \"Tables_in_mydb\\nusers\\norders\\nproducts\",\n  \"command\": \"mysql -u admin -p *** -e 'SHOW TABLES'\"  // &lt;- Masked!\n}\n</code></pre>"},{"location":"guides/secrets-security/#whats-actually-executed","title":"What's actually executed:","text":"<pre><code>mysql -u admin -p 'MyRealPassword' -e 'SHOW TABLES'\n</code></pre>"},{"location":"guides/secrets-security/#whats-logged","title":"What's logged:","text":"<pre><code>[AUDIT] COMMAND_EXECUTED: mysql -u admin -p *** -e 'SHOW TABLES' on db-prod\n</code></pre> <p>The password appears nowhere except in the actual command execution.</p>"},{"location":"guides/secrets-security/#configuration","title":"Configuration","text":""},{"location":"guides/secrets-security/#check-keyring-status","title":"Check keyring status","text":"<pre><code>merlya&gt; /secrets\n</code></pre> <p>Displays: <pre><code>Secret Store Status\n  Backend: keyring (macOS Keychain)\n  Stored secrets: 3\n    - mysql:db-prod:password\n    - ssh:bastion:passphrase\n    - api:monitoring:token\n</code></pre></p>"},{"location":"guides/secrets-security/#non-interactive-mode-cicd","title":"Non-interactive mode (CI/CD)","text":"<p>In non-interactive mode, secrets must be provided via environment variables or mounted files:</p> <pre><code># task.yaml\nsecrets:\n  DB_PASSWORD:\n    env: MYSQL_ROOT_PASSWORD\n  API_KEY:\n    file: /run/secrets/api_key\n</code></pre> <p>Merlya loads them into the keyring at startup, without ever exposing them to the LLM.</p>"},{"location":"guides/secrets-security/#audit-and-compliance","title":"Audit and Compliance","text":"<p>Every secret access is traced:</p> <pre><code>SELECT * FROM audit_logs\nWHERE event_type = 'secret_accessed'\nORDER BY created_at DESC;\n</code></pre> <pre><code>| id | event_type | action | target | created_at |\n|----|------------|--------|--------|------------|\n| a1 | secret_accessed | get | mysql:db-prod:password | 2024-12-16 10:23:45 |\n| a2 | secret_accessed | set | ssh:bastion:passphrase | 2024-12-16 10:22:30 |\n</code></pre> <p>SIEM export: <pre><code>merlya&gt; /audit export --format json --since 24h &gt; audit.json\n</code></pre></p>"},{"location":"guides/secrets-security/#conclusion","title":"Conclusion","text":"<p>Secrets are the first red line for any infrastructure AI agent. Merlya implements a defense in depth architecture with 5 layers of protection:</p> <ol> <li>Secure storage via OS keyring</li> <li>References instead of values for the LLM</li> <li>Late resolution only at execution time</li> <li>Proactive detection of plaintext passwords</li> <li>Automatic sanitization in logs</li> </ol> <p>This architecture ensures that even if one layer fails, the others protect your secrets.</p> <p>Merlya is an AI CLI agent for infrastructure management, designed with security as the absolute priority.</p> <p>Useful links: - Full documentation - SSH Guide - Configuration</p>"},{"location":"guides/ssh-management/","title":"SSH Management","text":"<p>Merlya provides powerful SSH management capabilities with connection pooling, jump hosts, auto-healing elevation, and intelligent retry logic.</p>"},{"location":"guides/ssh-management/#connecting-to-servers","title":"Connecting to Servers","text":""},{"location":"guides/ssh-management/#basic-connection","title":"Basic Connection","text":"<pre><code>Merlya &gt; Connect to server.example.com\n\nConnecting to server.example.com...\nConnected successfully.\n\nMerlya &gt; Run \"uptime\"\n\n&gt; ssh server.example.com \"uptime\"\n 10:30:15 up 30 days,  2:45,  1 user,  load average: 0.08, 0.12, 0.09\n</code></pre>"},{"location":"guides/ssh-management/#with-credentials","title":"With Credentials","text":"<pre><code>Merlya &gt; Connect to server.example.com as user admin with key ~/.ssh/admin_key\n\nConnecting to server.example.com as admin...\nUsing key: ~/.ssh/admin_key\nConnected successfully.\n</code></pre>"},{"location":"guides/ssh-management/#connection-pooling","title":"Connection Pooling","text":"<p>Merlya automatically manages SSH connections:</p> <ul> <li>Reuses connections - No reconnection overhead</li> <li>Automatic cleanup - Idle connections are closed</li> <li>Concurrent connections - Execute on multiple servers in parallel</li> </ul> <pre><code>Merlya &gt; Check uptime on all web servers\n\nExecuting on 5 servers in parallel...\n\nweb-01: up 45 days\nweb-02: up 45 days\nweb-03: up 12 days\nweb-04: up 45 days\nweb-05: up 3 days (recently restarted)\n</code></pre>"},{"location":"guides/ssh-management/#jump-hosts-bastion","title":"Jump Hosts (Bastion)","text":"<p>Connect through a bastion/jump host:</p> <pre><code>Merlya &gt; Connect to internal-db via bastion.example.com\n\nConnecting through jump host: bastion.example.com\nConnected to internal-db via bastion.\n</code></pre> <p>Configure jump hosts when adding hosts:</p> <pre><code>/hosts add internal-db 10.0.1.50 --user dbadmin --jump bastion.example.com\n</code></pre>"},{"location":"guides/ssh-management/#host-groups","title":"Host Groups","text":"<p>Define and use host groups:</p> <pre><code># Create a group\n/hosts group create web-tier\n\n# Add hosts to group\n/hosts group add web-tier web-01 web-02 web-03\n</code></pre> <pre><code>Merlya &gt; Restart nginx on all web-tier servers\n\nI'll restart nginx on all web-tier servers (web-01, web-02, web-03).\n\n&gt; ssh web-01 \"sudo systemctl restart nginx\"\n&gt; ssh web-02 \"sudo systemctl restart nginx\"\n&gt; ssh web-03 \"sudo systemctl restart nginx\"\n\nNginx restarted on all 3 servers.\n</code></pre>"},{"location":"guides/ssh-management/#file-transfer","title":"File Transfer","text":""},{"location":"guides/ssh-management/#upload-files","title":"Upload Files","text":"<pre><code>Merlya &gt; Upload config.yml to /etc/app/ on web-01\n\nUploading config.yml to web-01:/etc/app/config.yml...\nTransfer complete (2.3 KB).\n</code></pre>"},{"location":"guides/ssh-management/#download-files","title":"Download Files","text":"<pre><code>Merlya &gt; Download /var/log/app.log from web-01\n\nDownloading web-01:/var/log/app.log...\nSaved to: ./app.log (45 KB)\n</code></pre>"},{"location":"guides/ssh-management/#error-handling","title":"Error Handling","text":""},{"location":"guides/ssh-management/#automatic-retry","title":"Automatic Retry","text":"<p>Failed connections are automatically retried:</p> <pre><code>Merlya &gt; Connect to flaky-server.example.com\n\nConnection attempt 1 failed: Connection timeout\nRetrying in 5 seconds...\nConnection attempt 2 succeeded.\nConnected to flaky-server.example.com.\n</code></pre>"},{"location":"guides/ssh-management/#connection-errors","title":"Connection Errors","text":"<pre><code>Merlya &gt; Connect to unknown-server.example.com\n\nUnable to connect to unknown-server.example.com:\n- Error: Host not found\n- Suggestion: Check the hostname or add it to /etc/hosts\n</code></pre>"},{"location":"guides/ssh-management/#security","title":"Security","text":""},{"location":"guides/ssh-management/#host-key-verification","title":"Host Key Verification","text":"<pre><code>Merlya &gt; Connect to new-server.example.com\n\nWarning: Unknown host key for new-server.example.com\nFingerprint: SHA256:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n\nDo you want to add this host to known_hosts? [y/N]\n</code></pre>"},{"location":"guides/ssh-management/#key-based-authentication","title":"Key-Based Authentication","text":"<p>Merlya supports various SSH key types:</p> <ul> <li>RSA (2048+ bits)</li> <li>Ed25519 (recommended)</li> <li>ECDSA</li> </ul> <pre><code># Generate a new key\nssh-keygen -t ed25519 -f ~/.ssh/merlya_key\n\n# Configure Merlya to use it\nmerlya config set ssh.default_key ~/.ssh/merlya_key\n</code></pre>"},{"location":"guides/ssh-management/#best-practices","title":"Best Practices","text":"<ol> <li>Use SSH keys instead of passwords</li> <li>Configure jump hosts for internal servers</li> <li>Use host groups for batch operations</li> <li>Set appropriate timeouts for slow networks</li> <li>Review commands before execution on production</li> </ol>"},{"location":"guides/ssh-management/#troubleshooting","title":"Troubleshooting","text":""},{"location":"guides/ssh-management/#connection-timeout","title":"Connection Timeout","text":"<pre><code># Increase timeout\nmerlya config set ssh.timeout 60\n</code></pre>"},{"location":"guides/ssh-management/#permission-denied","title":"Permission Denied","text":"<pre><code># Check key permissions\nchmod 600 ~/.ssh/your_key\nchmod 700 ~/.ssh\n</code></pre>"},{"location":"guides/ssh-management/#too-many-connections","title":"Too Many Connections","text":"<pre><code># Adjust pool size in ~/.merlya/config.yaml\nssh:\n  max_connections: 20\n</code></pre>"},{"location":"guides/ssh-management/#privilege-elevation","title":"Privilege Elevation","text":"<p>Merlya automatically handles privilege elevation (sudo, doas, su) with an auto-healing fallback system.</p>"},{"location":"guides/ssh-management/#ssh-commands","title":"SSH Commands","text":"<pre><code># Basic SSH commands\n/ssh connect &lt;host&gt;       # Connect to a host\n/ssh exec &lt;host&gt; &lt;cmd&gt;    # Execute command\n/ssh config &lt;host&gt;        # Configure SSH (user, key, port, jump)\n/ssh test &lt;host&gt;          # Test connection with diagnostics\n/ssh disconnect [host]    # Disconnect\n\n# Elevation commands\n/ssh elevation detect &lt;host&gt;   # Detect sudo/doas/su capabilities\n/ssh elevation status &lt;host&gt;   # Show elevation status and failed methods\n/ssh elevation reset [host]    # Clear failed methods (retry with new password)\n</code></pre>"},{"location":"guides/ssh-management/#elevation-priority","title":"Elevation Priority","text":"<p>Merlya tries elevation methods in order:</p> <ol> <li>sudo (NOPASSWD) - Best: no password needed</li> <li>doas (NOPASSWD) - Common on BSD</li> <li>sudo_with_password - Fallback with password</li> <li>doas_with_password - Alternative with password</li> <li>su - Last resort (root password)</li> </ol>"},{"location":"guides/ssh-management/#auto-healing-fallback","title":"Auto-Healing Fallback","text":"<p>When an elevation method fails (wrong password):</p> <ol> <li>Merlya verifies the password with a test command</li> <li>Marks failed methods to avoid retry loops</li> <li>Tries next method in the chain automatically</li> <li>Caches passwords only after verification succeeds</li> </ol> <pre><code>Merlya &gt; Read /etc/shadow on @web01\n\n\ud83d\udd12 Command may require elevation. Use sudo_with_password? [y/N] y\n\ud83d\udd11 Your password for elevation: ****\n\ud83d\udd10 Verifying sudo_with_password...\n\u274c sudo_with_password failed (wrong password?)\n\ud83d\udd12 Trying fallback methods: su\n\ud83d\udd11 su (root password): ****\n\ud83d\udd10 Verifying su...\n\u2705 su verified\nroot:*:19000:0:99999:7:::\n</code></pre>"},{"location":"guides/ssh-management/#resetting-elevation","title":"Resetting Elevation","text":"<p>If passwords change or you need to retry:</p> <pre><code># Reset for one host\n/ssh elevation reset @web01\n\n# Reset for all hosts\n/ssh elevation reset\n</code></pre>"},{"location":"reference/api/","title":"API Reference","text":"<p>Merlya can be used as a Python library in your own applications.</p>"},{"location":"reference/api/#installation","title":"Installation","text":"<pre><code>pip install merlya\n</code></pre>"},{"location":"reference/api/#quick-start","title":"Quick Start","text":"<pre><code>from merlya import Merlya\n\n# Initialize with default config\nagent = Merlya()\n\n# Or with custom settings\nagent = Merlya(\n    provider=\"openai\",\n    model=\"gpt-4o-mini\",\n    api_key=\"sk-...\"\n)\n\n# Run a task\nresult = await agent.run(\"Check disk space on web servers\")\nprint(result)\n</code></pre>"},{"location":"reference/api/#core-classes","title":"Core Classes","text":""},{"location":"reference/api/#merlya","title":"Merlya","text":"<p>Main entry point for the library.</p> <pre><code>class Merlya:\n    def __init__(\n        self,\n        provider: str = \"openai\",\n        model: str = None,\n        api_key: str = None,\n        config_path: str = None\n    )\n</code></pre> <p>Parameters:</p> Parameter Type Description <code>provider</code> str LLM provider name <code>model</code> str Model identifier <code>api_key</code> str API key (uses keyring if not provided) <code>config_path</code> str Custom config file path <p>Methods:</p>"},{"location":"reference/api/#run","title":"run","text":"<p>Execute a natural language task.</p> <pre><code>async def run(\n    self,\n    prompt: str,\n    confirm: bool = True,\n    timeout: int = 300\n) -&gt; TaskResult\n</code></pre>"},{"location":"reference/api/#chat","title":"chat","text":"<p>Start an interactive chat session.</p> <pre><code>async def chat(\n    self,\n    system_prompt: str = None,\n    history: list = None\n) -&gt; None\n</code></pre>"},{"location":"reference/api/#connect","title":"connect","text":"<p>Connect to an SSH host.</p> <pre><code>async def connect(\n    self,\n    host: str,\n    user: str = None,\n    key: str = None\n) -&gt; SSHConnection\n</code></pre>"},{"location":"reference/api/#sshconnection","title":"SSHConnection","text":"<p>Represents an SSH connection.</p> <pre><code>class SSHConnection:\n    hostname: str\n    user: str\n    connected: bool\n</code></pre> <p>Methods:</p>"},{"location":"reference/api/#execute","title":"execute","text":"<p>Run a command on the remote host.</p> <pre><code>async def execute(\n    self,\n    command: str,\n    sudo: bool = False,\n    timeout: int = 60\n) -&gt; CommandResult\n</code></pre>"},{"location":"reference/api/#upload","title":"upload","text":"<p>Upload a file to the remote host.</p> <pre><code>async def upload(\n    self,\n    local_path: str,\n    remote_path: str\n) -&gt; None\n</code></pre>"},{"location":"reference/api/#download","title":"download","text":"<p>Download a file from the remote host.</p> <pre><code>async def download(\n    self,\n    remote_path: str,\n    local_path: str\n) -&gt; None\n</code></pre>"},{"location":"reference/api/#close","title":"close","text":"<p>Close the connection.</p> <pre><code>async def close(self) -&gt; None\n</code></pre>"},{"location":"reference/api/#taskresult","title":"TaskResult","text":"<p>Result of a task execution.</p> <pre><code>@dataclass\nclass TaskResult:\n    success: bool\n    output: str\n    commands: list[CommandResult]\n    analysis: str\n    duration: float\n</code></pre>"},{"location":"reference/api/#commandresult","title":"CommandResult","text":"<p>Result of a single command execution.</p> <pre><code>@dataclass\nclass CommandResult:\n    command: str\n    stdout: str\n    stderr: str\n    exit_code: int\n    host: str\n    duration: float\n</code></pre>"},{"location":"reference/api/#usage-examples","title":"Usage Examples","text":""},{"location":"reference/api/#basic-task-execution","title":"Basic Task Execution","text":"<pre><code>import asyncio\nfrom merlya import Merlya\n\nasync def main():\n    agent = Merlya()\n\n    # Run a task\n    result = await agent.run(\n        \"Check if nginx is running on web-01\",\n        confirm=False\n    )\n\n    if result.success:\n        print(f\"Output: {result.output}\")\n    else:\n        print(f\"Failed: {result.output}\")\n\nasyncio.run(main())\n</code></pre>"},{"location":"reference/api/#ssh-operations","title":"SSH Operations","text":"<pre><code>import asyncio\nfrom merlya import Merlya\n\nasync def main():\n    agent = Merlya()\n\n    # Connect to a server\n    conn = await agent.connect(\"web-01.example.com\", user=\"deploy\")\n\n    # Execute commands\n    result = await conn.execute(\"uptime\")\n    print(f\"Uptime: {result.stdout}\")\n\n    result = await conn.execute(\"df -h /\")\n    print(f\"Disk: {result.stdout}\")\n\n    # Close connection\n    await conn.close()\n\nasyncio.run(main())\n</code></pre>"},{"location":"reference/api/#batch-operations","title":"Batch Operations","text":"<pre><code>import asyncio\nfrom merlya import Merlya\n\nasync def check_server(agent, hostname):\n    conn = await agent.connect(hostname)\n    result = await conn.execute(\"uptime\")\n    await conn.close()\n    return hostname, result.stdout\n\nasync def main():\n    agent = Merlya()\n    servers = [\"web-01\", \"web-02\", \"web-03\"]\n\n    # Run in parallel\n    tasks = [check_server(agent, s) for s in servers]\n    results = await asyncio.gather(*tasks)\n\n    for hostname, uptime in results:\n        print(f\"{hostname}: {uptime}\")\n\nasyncio.run(main())\n</code></pre>"},{"location":"reference/api/#custom-llm-provider","title":"Custom LLM Provider","text":"<pre><code>from merlya import Merlya\n\n# Use Ollama\nagent = Merlya(\n    provider=\"ollama\",\n    model=\"qwen2.5:7b\",\n    base_url=\"http://localhost:11434\"\n)\n\n# Use Anthropic\nagent = Merlya(\n    provider=\"anthropic\",\n    model=\"claude-3-5-sonnet-20241022\",\n    api_key=\"sk-ant-...\"\n)\n</code></pre>"},{"location":"reference/api/#error-handling","title":"Error Handling","text":"<pre><code>import asyncio\nfrom merlya import Merlya\nfrom merlya.exceptions import (\n    ConnectionError,\n    AuthenticationError,\n    CommandError\n)\n\nasync def main():\n    agent = Merlya()\n\n    try:\n        conn = await agent.connect(\"server.example.com\")\n        result = await conn.execute(\"some-command\")\n    except ConnectionError as e:\n        print(f\"Connection failed: {e}\")\n    except AuthenticationError as e:\n        print(f\"Authentication failed: {e}\")\n    except CommandError as e:\n        print(f\"Command failed: {e.exit_code} - {e.stderr}\")\n\nasyncio.run(main())\n</code></pre>"},{"location":"reference/api/#type-hints","title":"Type Hints","text":"<p>Merlya is fully typed. Use with your favorite IDE for autocompletion:</p> <pre><code>from merlya import Merlya, TaskResult, SSHConnection\n\nasync def my_function(agent: Merlya) -&gt; TaskResult:\n    return await agent.run(\"Check servers\")\n</code></pre>"},{"location":"reference/cli/","title":"CLI Reference","text":"<p>Reference for the <code>merlya</code> command-line interface.</p>"},{"location":"reference/cli/#merlya-interactive-repl","title":"<code>merlya</code> (interactive REPL)","text":"<p>Start the interactive REPL (default mode).</p> <pre><code>merlya [--verbose] [-v|--version]\n</code></pre> <p>Options:</p> <ul> <li><code>--verbose</code>: enable debug logging</li> <li><code>-v</code>, <code>--version</code>: show version and exit</li> </ul>"},{"location":"reference/cli/#merlya-run-non-interactive-batch","title":"<code>merlya run</code> (non-interactive / batch)","text":"<p>Execute a single command or a list of commands from a file.</p> <pre><code>merlya run [OPTIONS] [COMMAND]\n</code></pre> <p>Options:</p> <ul> <li><code>-f</code>, <code>--file FILE</code>: load tasks from a YAML (<code>.yml/.yaml</code>) or text file</li> <li><code>-y</code>, <code>--yes</code>: auto-confirm prompts (unsafe in production unless you trust inputs)</li> <li><code>--format text|json</code>: output format (default: <code>text</code>)</li> <li><code>-q</code>, <code>--quiet</code>: minimal output</li> </ul> <p>Verbose logging:</p> <pre><code>merlya --verbose run \"Check disk usage on @web-01\"\n</code></pre> <p>Exit codes:</p> <ul> <li><code>0</code>: all tasks succeeded</li> <li><code>1</code>: one or more tasks failed</li> </ul> <p>See Non-Interactive Mode for allowed/blocked slash commands and task-file formats.</p>"},{"location":"reference/cli/#merlya-config","title":"<code>merlya config</code>","text":"<p>Manage configuration values stored in <code>~/.merlya/config.yaml</code>.</p> <pre><code>merlya config show\nmerlya config get &lt;section.key&gt;\nmerlya config set &lt;section.key&gt; &lt;value&gt;\n</code></pre> <p>Notes:</p> <ul> <li>Keys use the format <code>section.key</code> (exactly 2 segments), e.g. <code>model.provider</code> or <code>logging.console_level</code>.</li> <li><code>llm.*</code> is accepted as an alias for <code>model.*</code> (legacy).</li> <li><code>merlya config</code> does not store secret values; API keys are sourced from environment variables or the system keyring.</li> </ul> <p>Examples:</p> <pre><code>merlya config set model.provider openrouter\nmerlya config set model.model amazon/nova-2-lite-v1:free\nmerlya config get model.provider\n</code></pre>"},{"location":"reference/cli/#repl-slash-commands","title":"REPL slash commands","text":"<p>Once inside the REPL, use slash commands like <code>/hosts</code>, <code>/ssh</code>, <code>/model</code>, <code>/mcp</code>, etc. The full reference is in Slash Commands (REPL).</p>"},{"location":"reference/configuration/","title":"Configuration Reference","text":"<p>Complete reference for all configuration options.</p>"},{"location":"reference/configuration/#configuration-files","title":"Configuration Files","text":"File Purpose <code>~/.merlya/config.yaml</code> Main configuration <code>~/.merlya/merlya.db</code> Hosts inventory (SQLite) <code>~/.merlya/history</code> Command history <code>~/.merlya/logs/</code> Log files"},{"location":"reference/configuration/#general-settings","title":"General Settings","text":""},{"location":"reference/configuration/#generallanguage","title":"general.language","text":"<p>UI language.</p> Type Default Values string <code>en</code> <code>en</code>, <code>fr</code> <pre><code>general:\n  language: en\n</code></pre>"},{"location":"reference/configuration/#generallog_level","title":"general.log_level","text":"<p>Legacy Setting</p> <p>This setting is deprecated. Use <code>logging.console_level</code> instead. Kept for backwards compatibility as fallback.</p> Type Default Values string <code>info</code> <code>debug</code>, <code>info</code>, <code>warning</code>, <code>error</code> <pre><code>general:\n  log_level: info  # Deprecated, use logging.console_level\n</code></pre>"},{"location":"reference/configuration/#generaldata_dir","title":"general.data_dir","text":"<p>Data directory path.</p> Type Default string <code>~/.merlya</code> <pre><code>general:\n  data_dir: ~/.merlya\n</code></pre>"},{"location":"reference/configuration/#model-settings","title":"Model Settings","text":""},{"location":"reference/configuration/#modelprovider","title":"model.provider","text":"<p>LLM provider to use.</p> Type Default Values string <code>openrouter</code> <code>openrouter</code>, <code>anthropic</code>, <code>openai</code>, <code>ollama</code> <pre><code>model:\n  provider: openrouter\n</code></pre>"},{"location":"reference/configuration/#modelmodel","title":"model.model","text":"<p>Model name/identifier.</p> Type Default string <code>amazon/nova-2-lite-v1:free</code> <pre><code>model:\n  model: amazon/nova-2-lite-v1:free\n</code></pre> <p>Provider-specific examples:</p> Provider Example Model OpenRouter <code>amazon/nova-2-lite-v1:free</code>, <code>anthropic/claude-3.5-sonnet</code> Anthropic <code>claude-3-5-sonnet-latest</code>, <code>claude-3-5-haiku-latest</code> OpenAI <code>gpt-4o</code>, <code>gpt-4o-mini</code> Ollama <code>llama3.2</code>, <code>qwen2.5:7b</code>"},{"location":"reference/configuration/#modelapi_key_env","title":"model.api_key_env","text":"<p>Environment variable name for API key.</p> Type Default string (auto-detected) <pre><code>model:\n  api_key_env: OPENROUTER_API_KEY\n</code></pre> <p>API Key Storage</p> <p>API keys are stored securely in your system's keyring, not in config files. The <code>api_key_env</code> setting specifies which environment variable to check.</p>"},{"location":"reference/configuration/#modelbase_url","title":"model.base_url","text":"<p>Custom API endpoint URL (for Ollama or custom providers).</p> Type Default string Provider default <pre><code>model:\n  base_url: http://localhost:11434/v1\n</code></pre>"},{"location":"reference/configuration/#router-settings","title":"Router Settings","text":"<p>The router classifies user intent to determine appropriate actions.</p>"},{"location":"reference/configuration/#routertype","title":"router.type","text":"<p>Router type for intent classification.</p> Type Default Values string <code>local</code> <code>local</code>, <code>llm</code> <ul> <li><code>local</code>: Uses local ONNX embedding model (faster, offline)</li> <li><code>llm</code>: Uses LLM for classification (more accurate, requires API)</li> </ul> <pre><code>router:\n  type: local\n</code></pre>"},{"location":"reference/configuration/#routermodel","title":"router.model","text":"<p>Local embedding model ID (when <code>type: local</code>).</p> Type Default string (auto-selected by tier) <pre><code>router:\n  model: sentence-transformers/all-MiniLM-L6-v2\n</code></pre>"},{"location":"reference/configuration/#routertier","title":"router.tier","text":"<p>Model tier for local router.</p> Type Default Values string <code>balanced</code> <code>performance</code>, <code>balanced</code>, <code>lightweight</code> <pre><code>router:\n  tier: balanced\n</code></pre>"},{"location":"reference/configuration/#routerllm_fallback","title":"router.llm_fallback","text":"<p>LLM model for fallback classification.</p> Type Default string <code>openrouter:google/gemini-2.0-flash-lite-001</code> <pre><code>router:\n  llm_fallback: openrouter:google/gemini-2.0-flash-lite-001\n</code></pre>"},{"location":"reference/configuration/#ssh-settings","title":"SSH Settings","text":""},{"location":"reference/configuration/#sshconnect_timeout","title":"ssh.connect_timeout","text":"<p>Connection timeout in seconds.</p> Type Default Range integer <code>30</code> 5 - 120 <pre><code>ssh:\n  connect_timeout: 30\n</code></pre>"},{"location":"reference/configuration/#sshpool_timeout","title":"ssh.pool_timeout","text":"<p>Connection pool timeout in seconds.</p> Type Default Range integer <code>600</code> 60 - 3600 <pre><code>ssh:\n  pool_timeout: 600\n</code></pre>"},{"location":"reference/configuration/#sshcommand_timeout","title":"ssh.command_timeout","text":"<p>Command execution timeout in seconds.</p> Type Default Range integer <code>60</code> 5 - 3600 <pre><code>ssh:\n  command_timeout: 60\n</code></pre>"},{"location":"reference/configuration/#sshdefault_user","title":"ssh.default_user","text":"<p>Default SSH username.</p> Type Default string (none) <pre><code>ssh:\n  default_user: deploy\n</code></pre>"},{"location":"reference/configuration/#sshdefault_key","title":"ssh.default_key","text":"<p>Default SSH private key path.</p> Type Default string (none) <pre><code>ssh:\n  default_key: ~/.ssh/id_ed25519\n</code></pre>"},{"location":"reference/configuration/#ui-settings","title":"UI Settings","text":""},{"location":"reference/configuration/#uitheme","title":"ui.theme","text":"<p>Color theme.</p> Type Default Values string <code>auto</code> <code>auto</code>, <code>light</code>, <code>dark</code> <pre><code>ui:\n  theme: auto\n</code></pre>"},{"location":"reference/configuration/#uimarkdown","title":"ui.markdown","text":"<p>Enable markdown rendering in responses.</p> Type Default boolean <code>true</code> <pre><code>ui:\n  markdown: true\n</code></pre>"},{"location":"reference/configuration/#uisyntax_highlight","title":"ui.syntax_highlight","text":"<p>Enable syntax highlighting for code blocks.</p> Type Default boolean <code>true</code> <pre><code>ui:\n  syntax_highlight: true\n</code></pre>"},{"location":"reference/configuration/#logging-settings","title":"Logging Settings","text":""},{"location":"reference/configuration/#loggingconsole_level","title":"logging.console_level","text":"<p>Console log level for terminal output.</p> Type Default Values string <code>info</code> <code>debug</code>, <code>info</code>, <code>warning</code>, <code>error</code> <pre><code>logging:\n  console_level: info\n</code></pre> <p>CLI Flags</p> <p>Use <code>merlya --verbose</code> to override console logging to <code>debug</code> level. For non-interactive runs, <code>merlya run -q/--quiet</code> reduces user-facing output (it does not change the configured log level).</p>"},{"location":"reference/configuration/#loggingfile_level","title":"logging.file_level","text":"<p>File log level.</p> Type Default Values string <code>debug</code> <code>debug</code>, <code>info</code>, <code>warning</code>, <code>error</code> <pre><code>logging:\n  file_level: debug\n</code></pre>"},{"location":"reference/configuration/#loggingmax_size_mb","title":"logging.max_size_mb","text":"<p>Maximum log file size in MB before rotation.</p> Type Default Range integer <code>10</code> 1 - 100 <pre><code>logging:\n  max_size_mb: 10\n</code></pre>"},{"location":"reference/configuration/#loggingmax_files","title":"logging.max_files","text":"<p>Maximum number of log files to keep.</p> Type Default Range integer <code>5</code> 1 - 20 <pre><code>logging:\n  max_files: 5\n</code></pre>"},{"location":"reference/configuration/#loggingretention_days","title":"logging.retention_days","text":"<p>Log retention in days.</p> Type Default Range integer <code>7</code> 1 - 90 <pre><code>logging:\n  retention_days: 7\n</code></pre>"},{"location":"reference/configuration/#hosts-configuration","title":"Hosts Configuration","text":"<p>Hosts are stored in a SQLite database and managed via the <code>/hosts</code> commands.</p>"},{"location":"reference/configuration/#host-properties","title":"Host Properties","text":"Property Type Required Description <code>name</code> string Yes Unique host identifier <code>hostname</code> string Yes Server hostname or IP <code>port</code> integer No SSH port (default: 22) <code>username</code> string No SSH username <code>private_key</code> string No SSH private key path <code>jump_host</code> string No Jump/bastion host name <code>tags</code> array No Tags for filtering"},{"location":"reference/configuration/#managing-hosts","title":"Managing Hosts","text":"<pre><code># Add a host\n/hosts add web-01\n\n# Import from SSH config\n/hosts import ~/.ssh/config --format=ssh\n\n# List hosts\n/hosts list\n\n# Show host details\n/hosts show web-01\n\n# Add tags\n/hosts tag web-01 production\n\n# Delete a host\n/hosts delete old-server\n</code></pre>"},{"location":"reference/configuration/#complete-example","title":"Complete Example","text":"<pre><code># ~/.merlya/config.yaml\n\ngeneral:\n  language: en\n\nmodel:\n  provider: openrouter\n  model: amazon/nova-2-lite-v1:free\n  api_key_env: OPENROUTER_API_KEY\n\nrouter:\n  type: local\n  tier: balanced\n  llm_fallback: openrouter:google/gemini-2.0-flash-lite-001\n\nssh:\n  connect_timeout: 30\n  pool_timeout: 600\n  command_timeout: 60\n  default_user: deploy\n  default_key: ~/.ssh/id_ed25519\n\nui:\n  theme: auto\n  markdown: true\n  syntax_highlight: true\n\nlogging:\n  console_level: info\n  file_level: debug\n  max_size_mb: 10\n  max_files: 5\n  retention_days: 7\n</code></pre>"},{"location":"reference/configuration/#environment-variables","title":"Environment Variables","text":"<p>Override settings with environment variables:</p> Variable Description <code>OPENROUTER_API_KEY</code> OpenRouter API key <code>ANTHROPIC_API_KEY</code> Anthropic API key <code>OPENAI_API_KEY</code> OpenAI API key <code>OLLAMA_API_KEY</code> Ollama cloud API key <code>MERLYA_ROUTER_FALLBACK</code> Override router fallback model <code>MERLYA_ROUTER_MODEL</code> Override local router model"},{"location":"reference/non-interactive/","title":"Non-Interactive Mode Reference","text":"<p>Complete reference for Merlya's non-interactive (batch) execution mode.</p>"},{"location":"reference/non-interactive/#overview","title":"Overview","text":"<p>Non-interactive mode (<code>merlya run</code>) executes commands without user interaction, making it ideal for:</p> <ul> <li>CI/CD pipelines (GitHub Actions, GitLab CI, Jenkins)</li> <li>Scheduled tasks (cron, systemd timers)</li> <li>Shell scripts and automation</li> <li>Docker containers</li> <li>Monitoring and alerting</li> </ul>"},{"location":"reference/non-interactive/#command-syntax","title":"Command Syntax","text":"<pre><code>merlya run [OPTIONS] [COMMAND]\n</code></pre>"},{"location":"reference/non-interactive/#arguments","title":"Arguments","text":"Argument Description <code>COMMAND</code> Natural language command or slash command to execute"},{"location":"reference/non-interactive/#options","title":"Options","text":"Option Short Description <code>--file FILE</code> <code>-f</code> Load tasks from YAML or text file <code>--yes</code> <code>-y</code> Skip confirmation prompts (auto-confirm) <code>--format FORMAT</code> Output format: <code>text</code> (default) or <code>json</code> <code>--quiet</code> <code>-q</code> Minimal output (errors only) <code>--verbose</code> Enable verbose logging (use <code>merlya --verbose run ...</code>) <code>--help</code> Show help message"},{"location":"reference/non-interactive/#single-command-execution","title":"Single Command Execution","text":"<p>Execute a single command:</p> <pre><code>merlya run \"Check disk space on all web servers\"\n</code></pre> <p>With auto-confirmation (required for commands that modify systems):</p> <pre><code>merlya run --yes \"Restart nginx on @web-01\"\n</code></pre>"},{"location":"reference/non-interactive/#slash-commands","title":"Slash Commands","text":"<p>Execute internal Merlya commands directly without AI processing:</p> <pre><code>merlya run \"/scan @web-01\"\nmerlya run \"/hosts list\"\nmerlya run \"/health\"\n</code></pre>"},{"location":"reference/non-interactive/#allowed-commands","title":"Allowed Commands","text":"<p>Most read-only and diagnostic commands work in batch mode:</p> Command Description <code>/health</code> Check system health <code>/hosts list</code> List all hosts <code>/hosts show &lt;name&gt;</code> Show host details <code>/hosts import &lt;file&gt;</code> Import hosts from file <code>/hosts export &lt;file&gt;</code> Export hosts to file <code>/hosts tag &lt;name&gt; &lt;tag&gt;</code> Add tag to host <code>/hosts untag &lt;name&gt; &lt;tag&gt;</code> Remove tag from host <code>/scan &lt;host&gt;</code> Scan host for system info <code>/model show</code> Show current model config <code>/model provider &lt;name&gt;</code> Change LLM provider <code>/model model &lt;name&gt;</code> Change model <code>/log level &lt;level&gt;</code> Set log level <code>/variable list</code> List variables <code>/variable get &lt;name&gt;</code> Get variable value <code>/secret list</code> List secret names"},{"location":"reference/non-interactive/#blocked-commands","title":"Blocked Commands","text":"<p>These commands are not available in batch mode:</p> Command Reason <code>/exit</code>, <code>/quit</code>, <code>/q</code> Session control (no session in batch) <code>/new</code> Starts new conversation <code>/conv</code>, <code>/conversation</code> Requires conversation context"},{"location":"reference/non-interactive/#interactive-commands","title":"Interactive Commands","text":"<p>These commands require user input and cannot run in batch mode:</p> Command Reason <code>/hosts add &lt;name&gt;</code> Prompts for hostname, port, username <code>/ssh config &lt;host&gt;</code> Prompts for SSH configuration <code>/secret set &lt;name&gt;</code> Requires secure input prompt"},{"location":"reference/non-interactive/#examples","title":"Examples","text":"<pre><code># Quick health check\nmerlya run \"/health\"\n\n# List all hosts with production tag\nmerlya run \"/hosts list --tag=production\"\n\n# Scan a server\nmerlya run \"/scan @web-01 --quick\"\n\n# Full scan with JSON output\nmerlya run --format json \"/scan @web-01 --full\"\n\n# Import hosts from SSH config\nmerlya run \"/hosts import ~/.ssh/config --format=ssh\"\n\n# Change model for subsequent commands\nmerlya run \"/model provider anthropic\"\n</code></pre>"},{"location":"reference/non-interactive/#task-file-execution","title":"Task File Execution","text":"<p>Execute multiple tasks from a file:</p> <pre><code>merlya run --file tasks.yml\n</code></pre>"},{"location":"reference/non-interactive/#yaml-format","title":"YAML Format","text":"<pre><code># tasks.yml\ntasks:\n  - description: \"Check disk space\"\n    prompt: \"Check disk usage on all servers, warn if above 80%\"\n\n  - description: \"Check memory\"\n    prompt: \"Check memory usage on all servers\"\n\n  - prompt: \"Verify nginx is running on web tier\"\n</code></pre> <p>Fields:</p> Field Required Description <code>prompt</code> Yes The natural language command <code>description</code> No Human-readable task description"},{"location":"reference/non-interactive/#text-format","title":"Text Format","text":"<p>Simple one-command-per-line format:</p> <pre><code># tasks.txt\nCheck disk space on all servers\nList running services\nVerify backup status from last 24h\n</code></pre> <p>Lines starting with <code>#</code> are treated as comments.</p>"},{"location":"reference/non-interactive/#output-formats","title":"Output Formats","text":""},{"location":"reference/non-interactive/#text-output-default","title":"Text Output (Default)","text":"<p>Human-readable output:</p> <pre><code>merlya run \"Check uptime on @web-01\"\n</code></pre> <pre><code>Running health checks...\nExecuting: Check uptime on @web-01\n\n&gt; ssh web-01 \"uptime\"\n 14:32:01 up 45 days,  3:21,  2 users,  load average: 0.15, 0.10, 0.05\n\nThe server has been running for 45 days with low load average.\n\nCompleted: 1/1 tasks passed\n</code></pre>"},{"location":"reference/non-interactive/#json-output","title":"JSON Output","text":"<p>Machine-parseable output for automation:</p> <pre><code>merlya run --format json \"Check uptime on @web-01\"\n</code></pre> <pre><code>{\n  \"success\": true,\n  \"total\": 1,\n  \"passed\": 1,\n  \"failed\": 0,\n  \"tasks\": [\n    {\n      \"task\": \"Check uptime on @web-01\",\n      \"success\": true,\n      \"message\": \"The server has been running for 45 days with low load average.\",\n      \"actions\": [\"ssh_execute\"]\n    }\n  ]\n}\n</code></pre>"},{"location":"reference/non-interactive/#quiet-mode","title":"Quiet Mode","text":"<p>Only errors are displayed:</p> <pre><code>merlya run --quiet --yes \"Check server health\"\n</code></pre>"},{"location":"reference/non-interactive/#exit-codes","title":"Exit Codes","text":"Code Meaning 0 All tasks succeeded 1 One or more tasks failed <p>Use exit codes in scripts:</p> <pre><code>#!/bin/bash\nif merlya run --quiet --yes \"Check all servers healthy\"; then\n    echo \"All systems operational\"\nelse\n    echo \"Issues detected!\"\n    exit 1\nfi\n</code></pre>"},{"location":"reference/non-interactive/#environment-variables","title":"Environment Variables","text":"<p>Configure Merlya via environment variables (useful in containers):</p> Variable Description <code>OPENROUTER_API_KEY</code> OpenRouter API key <code>ANTHROPIC_API_KEY</code> Anthropic API key <code>OPENAI_API_KEY</code> OpenAI API key <code>MERLYA_ROUTER_MODEL</code> Override local router model <code>MERLYA_ROUTER_FALLBACK</code> LLM fallback model <p>Example:</p> <pre><code>OPENROUTER_API_KEY=or-xxx merlya run \"Check disk space\"\n</code></pre>"},{"location":"reference/non-interactive/#use-cases","title":"Use Cases","text":""},{"location":"reference/non-interactive/#cron-job","title":"Cron Job","text":"<pre><code># /etc/cron.d/merlya-health\n0 6 * * * root /usr/local/bin/merlya run --format json --yes \\\n    \"Run daily health checks\" &gt;&gt; /var/log/merlya/daily.log 2&gt;&amp;1\n</code></pre>"},{"location":"reference/non-interactive/#shell-script","title":"Shell Script","text":"<pre><code>#!/bin/bash\nset -e\n\nLOG_FILE=\"/var/log/merlya/deploy.log\"\n\necho \"$(date): Starting deployment\" &gt;&gt; $LOG_FILE\n\n# Pre-flight checks\nRESULT=$(merlya run --format json --yes \"Verify all servers healthy\")\n\nif echo \"$RESULT\" | jq -e '.success' &gt; /dev/null; then\n    echo \"$(date): Pre-flight passed\" &gt;&gt; $LOG_FILE\n    merlya run --yes \"Deploy version $VERSION to production\"\nelse\n    echo \"$(date): Pre-flight FAILED\" &gt;&gt; $LOG_FILE\n    exit 1\nfi\n</code></pre>"},{"location":"reference/non-interactive/#github-actions","title":"GitHub Actions","text":"<pre><code>- name: Health Check\n  env:\n    OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}\n  run: |\n    pip install merlya\n    merlya run --format json --yes \"Check all production servers\"\n</code></pre>"},{"location":"reference/non-interactive/#docker","title":"Docker","text":"<pre><code>docker run -e OPENROUTER_API_KEY=or-xxx merlya:latest \\\n    run --yes --format json \"Check disk space\"\n</code></pre>"},{"location":"reference/non-interactive/#best-practices","title":"Best Practices","text":"<ol> <li>Always use <code>--yes</code> in automation - Prompts will hang without TTY</li> <li>Use <code>--format json</code> for parsing - Reliable structured output</li> <li>Check exit codes - Handle failures gracefully</li> <li>Log output - Keep records of automated actions</li> <li>Test in staging first - Before automating production tasks</li> <li>Set timeouts - Wrap long-running commands with <code>timeout</code></li> </ol> <pre><code># Example with timeout\ntimeout 300 merlya run --yes \"Deploy to production\" || {\n    echo \"Deployment timed out after 5 minutes\"\n    exit 1\n}\n</code></pre>"},{"location":"reference/non-interactive/#troubleshooting","title":"Troubleshooting","text":""},{"location":"reference/non-interactive/#health-checks-failed","title":"\"Health checks failed\"","text":"<p>The LLM provider is not configured or unreachable:</p> <pre><code># Check configuration\nmerlya config show\n\n# Set API key\nexport OPENROUTER_API_KEY=or-xxx\n</code></pre>"},{"location":"reference/non-interactive/#host-not-found","title":"\"Host not found\"","text":"<p>The target host is not in the inventory:</p> <pre><code># List available hosts\nmerlya run \"List all hosts\"\n\n# Or add the host first (interactive mode)\nmerlya\n/hosts add web-01\n</code></pre>"},{"location":"reference/non-interactive/#no-output-in-json-mode","title":"No output in JSON mode","text":"<p>Ensure you're capturing both stdout and stderr:</p> <pre><code>RESULT=$(merlya run --format json \"...\" 2&gt;&amp;1)\n</code></pre>"},{"location":"fr/","title":"Accueil","text":""},{"location":"fr/#merlya","title":"Merlya","text":"<p>Assistant d'infrastructure propuls\u00e9 par l'IA pour les \u00e9quipes DevOps et SRE.</p> <p>Merlya est un outil en ligne de commande qui combine la puissance des LLM avec des capacit\u00e9s pratiques de gestion d'infrastructure : inventaire SSH, ex\u00e9cution \u00e0 distance s\u00e9curis\u00e9e, diagnostics et automatisation.</p>"},{"location":"fr/#fonctionnalites-cles","title":"Fonctionnalit\u00e9s cl\u00e9s","text":"<ul> <li> <p> Interface en langage naturel</p> <p>Posez des questions comme \"v\u00e9rifie l'espace disque sur @web-01\" ou \"analyse ce log d'incident\".</p> </li> <li> <p> Gestion SSH</p> <p>Pool SSH asynchrone, jump hosts, test de connexion, import/export d'inventaire.</p> </li> <li> <p> Routage local + fallback LLM</p> <p>Le routage d'intention pr\u00e9f\u00e8re les classifieurs locaux quand disponibles, avec des fallbacks s\u00fbrs.</p> </li> <li> <p> S\u00e9curis\u00e9 par conception</p> <p>Secrets stock\u00e9s dans le keyring syst\u00e8me ; entr\u00e9es valid\u00e9es ; logs coh\u00e9rents.</p> </li> </ul>"},{"location":"fr/#exemple-rapide","title":"Exemple rapide","text":"<pre><code>pip install merlya\n\n# Option A : laissez l'assistant de configuration vous guider (recommand\u00e9)\nmerlya\n\n# Option B : pour CI/CD, fournissez les cl\u00e9s API via variables d'environnement\nexport OPENAI_API_KEY=\"...\"\nmerlya run \"V\u00e9rifie l'espace disque sur @web-01\"\n</code></pre>"},{"location":"fr/#documentation","title":"Documentation","text":"<ul> <li> <p> D\u00e9marrage</p> <ul> <li>Installation</li> <li>D\u00e9marrage rapide</li> <li>Configuration</li> </ul> </li> <li> <p> Guides</p> <ul> <li>Mode REPL</li> <li>Gestion SSH</li> <li>Fournisseurs LLM</li> <li>Automatisation</li> </ul> </li> <li> <p> R\u00e9f\u00e9rence</p> <ul> <li>CLI</li> <li>Commandes slash</li> <li>Outils</li> <li>Configuration</li> </ul> </li> <li> <p> Architecture</p> <ul> <li>Vue d'ensemble</li> <li>D\u00e9cisions (ADR)</li> </ul> </li> </ul> <p>Commencer  Voir sur GitHub </p>"},{"location":"fr/getting-started/configuration/","title":"Configuration","text":"<p>Merlya utilise un syst\u00e8me de configuration en couches avec des valeurs par d\u00e9faut sens\u00e9es.</p>"},{"location":"fr/getting-started/configuration/#fichiers-de-configuration","title":"Fichiers de configuration","text":"Fichier Objectif <code>~/.merlya/config.yaml</code> Configuration principale <code>~/.merlya/merlya.db</code> Inventaire des h\u00f4tes (SQLite) <code>~/.merlya/history</code> Historique des commandes <code>~/.merlya/logs/</code> Fichiers de logs"},{"location":"fr/getting-started/configuration/#fichier-de-configuration","title":"Fichier de configuration","text":"<p>La configuration est stock\u00e9e dans <code>~/.merlya/config.yaml</code> :</p> <pre><code># ~/.merlya/config.yaml\ngeneral:\n  language: fr          # Langue de l'interface (en, fr)\n  log_level: info       # debug, info, warning, error\n\nmodel:\n  provider: openrouter  # openrouter, anthropic, openai, mistral, groq, ollama\n  model: amazon/nova-2-lite-v1:free\n  api_key_env: OPENROUTER_API_KEY\n\nrouter:\n  type: local           # local (ONNX) ou llm\n  llm_fallback: openrouter:google/gemini-2.0-flash-lite-001\n\nssh:\n  connect_timeout: 30\n  pool_timeout: 600\n  command_timeout: 60\n</code></pre>"},{"location":"fr/getting-started/configuration/#definir-des-valeurs","title":"D\u00e9finir des valeurs","text":"<p>Utilisez la commande <code>config</code> pour g\u00e9rer les param\u00e8tres :</p> <pre><code># D\u00e9finir une valeur\nmerlya config set model.provider anthropic\n\n# Obtenir une valeur\nmerlya config get model.provider\n\n# Afficher tous les param\u00e8tres\nmerlya config show\n</code></pre>"},{"location":"fr/getting-started/configuration/#variables-denvironnement","title":"Variables d'environnement","text":"<p>Les cl\u00e9s API et param\u00e8tres peuvent \u00eatre d\u00e9finis via des variables d'environnement :</p> <pre><code>export OPENROUTER_API_KEY=or-xxx\nexport ANTHROPIC_API_KEY=sk-ant-xxx\nexport OPENAI_API_KEY=sk-xxx\nexport MISTRAL_API_KEY=xxx\nexport GROQ_API_KEY=gsk_xxx\nexport OLLAMA_API_KEY=xxx  # Pour Ollama cloud uniquement\n\n# Remplacer les param\u00e8tres\nexport MERLYA_ROUTER_FALLBACK=openai:gpt-4o-mini\n</code></pre>"},{"location":"fr/getting-started/configuration/#configuration-llm","title":"Configuration LLM","text":""},{"location":"fr/getting-started/configuration/#parametres-du-fournisseur","title":"Param\u00e8tres du fournisseur","text":"Param\u00e8tre Description D\u00e9faut <code>model.provider</code> Fournisseur LLM <code>openrouter</code> <code>model.model</code> Nom/ID du mod\u00e8le <code>amazon/nova-2-lite-v1:free</code> <code>model.api_key_env</code> Nom de la variable d'env pour la cl\u00e9 API auto <p>Fournisseurs support\u00e9s :</p> Fournisseur Description <code>openrouter</code> 100+ mod\u00e8les, tier gratuit disponible (d\u00e9faut) <code>anthropic</code> Mod\u00e8les Claude <code>openai</code> Mod\u00e8les GPT <code>mistral</code> Mod\u00e8les Mistral AI <code>groq</code> Inf\u00e9rence ultra-rapide <code>ollama</code> Mod\u00e8les locaux ou cloud"},{"location":"fr/getting-started/configuration/#cles-api","title":"Cl\u00e9s API","text":"<p>Les cl\u00e9s API sont stock\u00e9es de mani\u00e8re s\u00e9curis\u00e9e dans le keyring syst\u00e8me (recommand\u00e9) ou fournies via des variables d'environnement :</p> <ul> <li>macOS : Keychain</li> <li>Linux : Secret Service (GNOME Keyring, KWallet)</li> <li>Windows : Credential Manager</li> </ul> <pre><code># Dans le REPL, Merlya peut demander et stocker votre cl\u00e9 :\nmerlya\n/model provider openai\n\n# Ou dans les environnements non-interactifs (CI/CD) :\nexport OPENAI_API_KEY=\"...\"\n\n# Les cl\u00e9s ne sont jamais \u00e9crites dans les fichiers de config\ncat ~/.merlya/config.yaml | grep api_key\n# (pas de sortie - seulement la r\u00e9f\u00e9rence api_key_env, pas la vraie cl\u00e9)\n</code></pre>"},{"location":"fr/getting-started/configuration/#configuration-ssh","title":"Configuration SSH","text":"Param\u00e8tre Description D\u00e9faut <code>ssh.connect_timeout</code> Timeout de connexion (secondes) <code>30</code> <code>ssh.pool_timeout</code> Timeout du pool (secondes) <code>600</code> <code>ssh.command_timeout</code> Timeout d'ex\u00e9cution de commande <code>60</code>"},{"location":"fr/getting-started/configuration/#gestion-des-hotes","title":"Gestion des h\u00f4tes","text":"<p>Les h\u00f4tes sont stock\u00e9s dans une base SQLite (<code>~/.merlya/merlya.db</code>) et g\u00e9r\u00e9s via des commandes slash :</p> <pre><code># Ajouter un h\u00f4te interactivement\n/hosts add web-01\n\n# Importer depuis la config SSH\n/hosts import ~/.ssh/config --format=ssh\n\n# Importer depuis /etc/hosts\n/hosts import /etc/hosts --format=etc_hosts\n\n# Lister tous les h\u00f4tes\n/hosts list\n\n# Afficher les d\u00e9tails d'un h\u00f4te\n/hosts show web-01\n</code></pre> <p>Formats d'import support\u00e9s :</p> Format Description <code>ssh</code> Fichier config SSH (<code>~/.ssh/config</code>) <code>etc_hosts</code> Format Linux <code>/etc/hosts</code> <code>json</code> Tableau JSON d'objets h\u00f4tes <code>yaml</code> Configuration YAML des h\u00f4tes <code>csv</code> CSV avec colonnes : name, hostname, port, username"},{"location":"fr/getting-started/configuration/#journalisation","title":"Journalisation","text":"<p>Merlya utilise loguru pour la journalisation.</p> Param\u00e8tre Description D\u00e9faut <code>general.log_level</code> Niveau de log console <code>info</code> <code>logging.file_level</code> Niveau de log fichier <code>debug</code> <code>logging.max_size_mb</code> Taille max du fichier de log <code>10</code> <p>Les logs sont stock\u00e9s dans <code>~/.merlya/logs/</code>.</p>"},{"location":"fr/getting-started/configuration/#etapes-suivantes","title":"\u00c9tapes suivantes","text":"<ul> <li>Guide de gestion SSH</li> <li>Guide des fournisseurs LLM</li> <li>Guide d'automatisation</li> </ul>"},{"location":"fr/getting-started/installation/#prerequis","title":"Pr\u00e9requis","text":"<ul> <li>Python 3.11 ou sup\u00e9rieur</li> <li>pip (gestionnaire de paquets Python)</li> <li>Une cl\u00e9 API de fournisseur LLM (OpenAI, Anthropic, ou Ollama local)</li> </ul>"},{"location":"fr/getting-started/installation/#installation-depuis-pypi","title":"Installation depuis PyPI","text":"<p>La m\u00e9thode recommand\u00e9e pour installer Merlya est via pip :</p> <pre><code>pip install merlya\n</code></pre>"},{"location":"fr/getting-started/installation/#installation-depuis-les-sources","title":"Installation depuis les sources","text":"<p>Pour la derni\u00e8re version de d\u00e9veloppement :</p> <pre><code>git clone https://github.com/m-kis/merlya.git\ncd merlya\npip install -e \".[dev]\"\n</code></pre>"},{"location":"fr/getting-started/installation/#verifier-linstallation","title":"V\u00e9rifier l'installation","text":"<pre><code>merlya --version\n</code></pre> <p>Vous devriez voir une sortie comme :</p> <pre><code>merlya 0.7.5\n</code></pre>"},{"location":"fr/getting-started/installation/#autocompletion-du-shell","title":"Autocompl\u00e9tion du shell","text":"BashZshFish <pre><code># Ajoutez \u00e0 ~/.bashrc\neval \"$(_MERLYA_COMPLETE=bash_source merlya)\"\n</code></pre> <pre><code># Ajoutez \u00e0 ~/.zshrc\neval \"$(_MERLYA_COMPLETE=zsh_source merlya)\"\n</code></pre> <pre><code># Ajoutez \u00e0 ~/.config/fish/completions/merlya.fish\n_MERLYA_COMPLETE=fish_source merlya | source\n</code></pre>"},{"location":"fr/getting-started/installation/#installation-docker","title":"Installation Docker","text":"<pre><code># Copier et configurer les variables d'environnement\ncp .env.example .env\n# \u00c9ditez .env avec vos cl\u00e9s API\n\n# D\u00e9marrer le conteneur\ndocker compose up -d\n\n# Mode d\u00e9veloppement (code source mont\u00e9)\ndocker compose --profile dev up -d\n</code></pre> <p>Configuration SSH pour Docker :</p> <p>Le conteneur monte votre r\u00e9pertoire SSH local. Par d\u00e9faut, il utilise <code>$HOME/.ssh</code>.</p>"},{"location":"fr/getting-started/installation/#etapes-suivantes","title":"\u00c9tapes suivantes","text":"<ul> <li>D\u00e9marrage rapide - D\u00e9marrez en 5 minutes</li> <li>Configuration - Configurez votre fournisseur LLM et param\u00e8tres</li> </ul>"},{"location":"fr/getting-started/quickstart/","title":"D\u00e9marrage rapide","text":"<p>Lancez Merlya en 5 minutes.</p> <p></p>"},{"location":"fr/getting-started/quickstart/#1-premier-lancement-assistant-de-configuration","title":"1. Premier lancement - Assistant de configuration","text":"<p>Au premier lancement, l'assistant de configuration de Merlya vous guide :</p> <pre><code>merlya\n</code></pre>"},{"location":"fr/getting-started/quickstart/#selection-de-la-langue","title":"S\u00e9lection de la langue","text":"<pre><code>\u256d\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u256e\n\u2502                        Merlya Setup                              \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502  Welcome to Merlya! / Bienvenue dans Merlya!                    \u2502\n\u2502                                                                  \u2502\n\u2502  Select your language / Choisissez votre langue:                \u2502\n\u2502    1. English                                                    \u2502\n\u2502    2. Fran\u00e7ais                                                   \u2502\n\u2570\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u256f\n</code></pre>"},{"location":"fr/getting-started/quickstart/#selection-du-fournisseur-llm","title":"S\u00e9lection du fournisseur LLM","text":"<pre><code>\u256d\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u256e\n\u2502                      Configuration LLM                            \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502  1. OpenRouter (recommand\u00e9 - multi-mod\u00e8les)                       \u2502\n\u2502  2. Anthropic (Claude direct)                                     \u2502\n\u2502  3. OpenAI (mod\u00e8les GPT)                                          \u2502\n\u2502  4. Mistral (Mistral AI)                                          \u2502\n\u2502  5. Groq (inf\u00e9rence rapide)                                       \u2502\n\u2502  6. Ollama (mod\u00e8les locaux)                                       \u2502\n\u2570\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u256f\n\nS\u00e9lectionner le provider [1]:\n</code></pre> <p>OpenRouter recommand\u00e9</p> <p>OpenRouter offre des mod\u00e8les gratuits et l'acc\u00e8s \u00e0 plus de 100 LLMs. Obtenez votre cl\u00e9 API sur openrouter.ai/keys</p>"},{"location":"fr/getting-started/quickstart/#decouverte-des-hotes","title":"D\u00e9couverte des h\u00f4tes","text":"<p>L'assistant d\u00e9tecte automatiquement les h\u00f4tes depuis :</p> <ul> <li><code>~/.ssh/config</code> - Configuration SSH</li> <li><code>~/.ssh/known_hosts</code> - H\u00f4tes pr\u00e9c\u00e9demment connect\u00e9s</li> <li><code>/etc/hosts</code> - D\u00e9finitions d'h\u00f4tes locaux</li> <li>Fichiers d'inventaire Ansible</li> </ul> <pre><code>Sources d'inventaire d\u00e9tect\u00e9es :\n  \u2022 SSH Config: 12 h\u00f4tes\n  \u2022 Known Hosts: 45 h\u00f4tes\n\nImporter tous les h\u00f4tes ? [O/n]:\n</code></pre>"},{"location":"fr/getting-started/quickstart/#2-configuration-manuelle-alternative","title":"2. Configuration manuelle (alternative)","text":"<p>Si vous sautez l'assistant ou voulez modifier les param\u00e8tres plus tard :</p> Interactif (cl\u00e9s API stock\u00e9es dans le keyring)CI/CD (cl\u00e9s API via variables d'environnement)Ollama (local) <pre><code>merlya\n# puis dans le REPL :\n/model provider openrouter\n/model model amazon/nova-2-lite-v1:free\n</code></pre> <pre><code>export OPENAI_API_KEY=\"...\"\nmerlya config set model.provider openai\nmerlya config set model.model gpt-4o-mini\nmerlya run \"V\u00e9rifie l'espace disque sur @web-01\"\n</code></pre> <pre><code># D'abord, installez Ollama : https://ollama.com\nollama pull llama3.2\n\nmerlya config set model.provider ollama\nmerlya config set model.model llama3.2\nmerlya run \"V\u00e9rifie l'espace disque sur @web-01\"\n</code></pre>"},{"location":"fr/getting-started/quickstart/#3-demarrer-le-repl","title":"3. D\u00e9marrer le REPL","text":"<pre><code>merlya\n</code></pre> <p>Utilisez <code>/help</code> pour lister les commandes disponibles, et <code>/exit</code> pour quitter.</p> <p>Logiciel exp\u00e9rimental</p> <p>V\u00e9rifiez toujours les commandes avant de les ex\u00e9cuter sur des syst\u00e8mes de production.</p>"},{"location":"fr/getting-started/quickstart/#4-essayez-quelques-commandes","title":"4. Essayez quelques commandes","text":""},{"location":"fr/getting-started/quickstart/#langage-naturel","title":"Langage naturel","text":"<pre><code>Merlya &gt; Qu'est-ce que tu peux m'aider \u00e0 faire ?\n\nJe peux vous aider avec :\n- G\u00e9rer les connexions SSH aux serveurs\n- Ex\u00e9cuter des commandes sur des machines distantes\n- V\u00e9rifier l'\u00e9tat et les m\u00e9triques syst\u00e8me\n- Automatiser les t\u00e2ches DevOps routini\u00e8res\n\nD\u00e9crivez simplement ce dont vous avez besoin !\n</code></pre>"},{"location":"fr/getting-started/quickstart/#connexion-a-un-serveur","title":"Connexion \u00e0 un serveur","text":"<pre><code>Merlya &gt; Connecte-toi \u00e0 mon-serveur.example.com et montre-moi l'uptime\n\nConnexion \u00e0 mon-serveur.example.com...\n\n&gt; ssh mon-serveur.example.com \"uptime\"\n\n 14:32:01 up 45 days,  3:21,  2 users,  load average: 0.15, 0.10, 0.05\n\nLe serveur fonctionne depuis 45 jours avec de faibles moyennes de charge.\n</code></pre>"},{"location":"fr/getting-started/quickstart/#utiliser-les-mentions","title":"Utiliser les @ mentions","text":"<pre><code>Merlya &gt; V\u00e9rifie l'espace disque sur @web-01 et @web-02\n\n&gt; ssh web-01 \"df -h /\"\n&gt; ssh web-02 \"df -h /\"\n\nR\u00e9sum\u00e9 :\n- web-01: 45% utilis\u00e9 (55Go libre)\n- web-02: 62% utilis\u00e9 (38Go libre)\n</code></pre>"},{"location":"fr/getting-started/quickstart/#commandes-slash","title":"Commandes slash","text":"<pre><code>Merlya &gt; /hosts\n\nNom      | Hostname              | User   | Tags\n---------|----------------------|--------|------------------\nweb-01   | web-01.example.com   | deploy | ssh-config\nweb-02   | web-02.example.com   | deploy | ssh-config\ndb-01    | 10.0.1.50            | admin  | known-hosts\n</code></pre>"},{"location":"fr/getting-started/quickstart/#commandes-courantes","title":"Commandes courantes","text":"Commande Description <code>merlya</code> D\u00e9marrer le REPL interactif <code>merlya run \"...\"</code> Ex\u00e9cuter une commande de mani\u00e8re non-interactive <code>merlya config list</code> Afficher la configuration actuelle <code>merlya config set KEY VALUE</code> D\u00e9finir une valeur de configuration <code>/help</code> Afficher les commandes slash disponibles <code>/hosts</code> Lister les h\u00f4tes configur\u00e9s <code>/new</code> D\u00e9marrer une nouvelle conversation <code>/exit</code> Quitter le REPL"},{"location":"fr/getting-started/quickstart/#etapes-suivantes","title":"\u00c9tapes suivantes","text":"<ul> <li>Mode REPL - Plong\u00e9e dans l'interface interactive</li> <li>Guide d'automatisation - Mode non-interactif, CI/CD, scripting</li> <li>Guide de configuration - Options de configuration avanc\u00e9es</li> <li>Gestion SSH - Fonctionnalit\u00e9s SSH et pool de connexions</li> <li>Fournisseurs LLM - Configurer diff\u00e9rents fournisseurs LLM</li> </ul>"},{"location":"fr/guides/secrets-security/","title":"Les secrets : la ligne rouge des agents IA d'infrastructure","text":"<p>Comment Merlya garantit que vos mots de passe ne finissent jamais dans les logs, le LLM, ou en clair sur le disque.</p>"},{"location":"fr/guides/secrets-security/#le-probleme-avec-les-agents-ia-actuels","title":"Le probl\u00e8me avec les agents IA actuels","text":"<p>En tant qu'ing\u00e9nieur infrastructure, j'ai test\u00e9 de nombreux agents IA : OpenHands, Gemini CLI, SHAI, et d'autres. \u00c0 chaque fois, les m\u00eames inqui\u00e9tudes revenaient :</p> <ul> <li>Des d\u00e9cisions prises \"parce que le mod\u00e8le pense que c'est mieux\" \u2014 sans justification ni tra\u00e7abilit\u00e9</li> <li>Des commandes ex\u00e9cut\u00e9es implicitement \u2014 sans confirmation explicite pour les op\u00e9rations destructives</li> <li>Des secrets manipul\u00e9s comme des variables quelconques \u2014 affich\u00e9s dans les logs, envoy\u00e9s aux APIs</li> <li>Tr\u00e8s peu de traces exploitables \u2014 impossible de faire un audit post-incident</li> </ul> <p>Ces probl\u00e8mes ne sont pas anecdotiques. Dans un environnement de production, ils sont r\u00e9dhibitoires.</p>"},{"location":"fr/guides/secrets-security/#larchitecture-secret-zero-trust-de-merlya","title":"L'architecture \"Secret-Zero-Trust\" de Merlya","text":"<p>Merlya a \u00e9t\u00e9 con\u00e7u avec une philosophie simple : le LLM ne doit jamais voir les secrets.</p>"},{"location":"fr/guides/secrets-security/#le-flux-des-secrets","title":"Le flux des secrets","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                        FLUX DES SECRETS                         \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                                 \u2502\n\u2502  1. Utilisateur entre le mot de passe                           \u2502\n\u2502     \u2514\u2500\u2500 prompt_secret() \u2192 Keyring syst\u00e8me                       \u2502\n\u2502                                                                 \u2502\n\u2502  2. Merlya stocke une R\u00c9F\u00c9RENCE                                 \u2502\n\u2502     \u2514\u2500\u2500 @db:password (pas la valeur !)                          \u2502\n\u2502                                                                 \u2502\n\u2502  3. LLM g\u00e9n\u00e8re une commande                                     \u2502\n\u2502     \u2514\u2500\u2500 \"mysql -p @db:password -e 'SELECT 1'\"                   \u2502\n\u2502                                                                 \u2502\n\u2502  4. R\u00e9solution TARDIVE (execution-time)                         \u2502\n\u2502     \u2514\u2500\u2500 resolve_all_references() \u2192 mysql -p secretvalue         \u2502\n\u2502                                                                 \u2502\n\u2502  5. Retour au LLM                                               \u2502\n\u2502     \u2514\u2500\u2500 \"mysql -p *** -e 'SELECT 1'\" (safe_command)             \u2502\n\u2502                                                                 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <p>Le secret n'est jamais : - Affich\u00e9 dans les logs - Envoy\u00e9 au LLM - Stock\u00e9 en clair sur le disque</p>"},{"location":"fr/guides/secrets-security/#couche-1-stockage-securise-via-keyring","title":"Couche 1 : Stockage s\u00e9curis\u00e9 via Keyring","text":"<p>Les secrets sont stock\u00e9s dans le keyring syst\u00e8me de votre OS :</p> OS Backend macOS Keychain Windows Credential Manager Linux Secret Service (GNOME Keyring, KWallet) <pre><code># merlya/secrets/store.py\ndef set(self, name: str, value: str) -&gt; None:\n    if self._keyring_available:\n        keyring.set_password(SERVICE_NAME, name, value)\n    else:\n        self._memory_store[name] = value  # Fallback avec warning\n</code></pre> <p>Si le keyring n'est pas disponible (conteneur Docker sans acc\u00e8s), Merlya utilise un stockage en m\u00e9moire avec un avertissement explicite : les secrets seront perdus \u00e0 la fermeture.</p>"},{"location":"fr/guides/secrets-security/#couche-2-references-au-lieu-de-valeurs","title":"Couche 2 : R\u00e9f\u00e9rences au lieu de valeurs","text":"<p>Quand vous entrez un mot de passe, Merlya ne le retourne jamais au LLM. \u00c0 la place, il g\u00e9n\u00e8re une r\u00e9f\u00e9rence :</p> <pre><code># merlya/tools/interaction.py\nsafe_values = {}\nfor name, val in values.items():\n    if name.lower() in {\"password\", \"token\", \"secret\", \"key\", \"passphrase\"}:\n        secret_key = f\"{key_prefix}:{name}\"\n        secret_store.set(secret_key, val)\n        safe_values[name] = f\"@{secret_key}\"  # R\u00e9f\u00e9rence, pas valeur !\n    else:\n        safe_values[name] = val\n</code></pre> <p>Le LLM voit <code>@db:password</code>, jamais <code>MonSuperMotDePasse123!</code>.</p>"},{"location":"fr/guides/secrets-security/#couche-3-resolution-tardive","title":"Couche 3 : R\u00e9solution tardive","text":"<p>Les r\u00e9f\u00e9rences <code>@secret-name</code> sont r\u00e9solues uniquement au moment de l'ex\u00e9cution, apr\u00e8s que le LLM a donn\u00e9 son instruction :</p> <pre><code># merlya/tools/core/resolve.py\ndef resolve_secrets(command: str, secrets: SecretStore) -&gt; tuple[str, str]:\n    \"\"\"\n    SECURITY: This function should only be called at execution time,\n    never before sending commands to the LLM.\n\n    Returns:\n        Tuple of (resolved_command, safe_command_for_logging).\n    \"\"\"\n    for match in REFERENCE_PATTERN.finditer(command):\n        secret_value = secrets.get(secret_name)\n        resolved = resolved[:start] + secret_value + resolved[end:]\n        safe = safe[:start] + \"***\" + safe[end:]\n    return resolved, safe\n</code></pre> <p>La commande r\u00e9solue (<code>resolved</code>) est ex\u00e9cut\u00e9e mais jamais logg\u00e9e ni retourn\u00e9e au LLM. Seule la version masqu\u00e9e (<code>safe</code>) est visible.</p>"},{"location":"fr/guides/secrets-security/#couche-4-detection-proactive-des-mots-de-passe-en-clair","title":"Couche 4 : D\u00e9tection proactive des mots de passe en clair","text":"<p>Merlya bloque les commandes qui contiennent des mots de passe en clair :</p> <pre><code># merlya/tools/core/security.py\nUNSAFE_PASSWORD_PATTERNS = (\n    re.compile(r\"echo\\s+['\\\"]?(?!@)[^'\\\"]+['\\\"]?\\s*\\|\\s*sudo\\s+-S\"),  # echo 'pass' | sudo\n    re.compile(r\"-p['\\\"][^'\\\"@]+['\\\"]\"),  # mysql -p'password'\n    re.compile(r\"--password[=\\s]+['\\\"]?(?!@)[^@\\s'\\\"]+\"),  # --password=value\n    re.compile(r\"sshpass\\s+-p\\s+['\\\"]?(?!@)[^'\\\"@\\s]+\"),  # sshpass -p password\n    # ... 8 patterns au total\n)\n\ndef detect_unsafe_password(command: str) -&gt; str | None:\n    for pattern in UNSAFE_PASSWORD_PATTERNS:\n        if pattern.search(command):\n            return \"\u26a0\ufe0f SECURITY: Command may contain a plaintext password.\"\n    return None\n</code></pre> <p>Si le LLM essaie de g\u00e9n\u00e9rer <code>mysql -p'secretvalue'</code> au lieu de <code>mysql -p @db:password</code>, la commande est refus\u00e9e avec un message d'erreur clair.</p>"},{"location":"fr/guides/secrets-security/#couche-5-sanitization-automatique-dans-les-logs","title":"Couche 5 : Sanitization automatique dans les logs","text":"<p>M\u00eame si un secret passait \u00e0 travers les autres couches, le syst\u00e8me d'audit le masquerait :</p> <pre><code># merlya/audit/logger.py\n_SENSITIVE_KEY_PATTERNS = (\n    \"password\", \"passwd\", \"pwd\", \"secret\", \"key\", \"token\",\n    \"api_key\", \"bearer\", \"jwt\", \"oauth\", \"credential\",\n    \"private_key\", \"ssh_key\", \"id_rsa\", \"certificate\",\n    # ... 30+ patterns\n)\n\n_SENSITIVE_VALUE_PATTERNS = (\n    re.compile(r\"^A[KBS]IA[A-Z0-9]{16}$\"),  # AWS access key\n    re.compile(r\"^gh[pousr]_[A-Za-z0-9_]{36,}$\"),  # GitHub token\n    re.compile(r\"^eyJ[A-Za-z0-9_-]*\\.eyJ\"),  # JWT\n    # ... 9 patterns pour d\u00e9tecter les secrets par leur format\n)\n</code></pre> <p>La sanitization est r\u00e9cursive : elle parcourt les dicts et listes imbriqu\u00e9s.</p>"},{"location":"fr/guides/secrets-security/#comparaison-avec-dautres-agents","title":"Comparaison avec d'autres agents","text":"<p>Disclaimer : Les affirmations ci-dessous sont bas\u00e9es sur l'analyse de la documentation publique, l'examen des issues GitHub et des tests de fonctionnement r\u00e9alis\u00e9s entre d\u00e9cembre 2024 et janvier 2025. Versions \u00e9valu\u00e9es : OpenHands (commit a3b2c1d), Gemini CLI (v2.1.0), SHAI (v0.8.5). M\u00e9thodologie : revue du code source, tests de p\u00e9n\u00e9tration des logs, analyse des patterns de stockage des credentials.</p> Aspect OpenHands<sup>1</sup> Gemini CLI<sup>2</sup> SHAI<sup>3</sup> Merlya Secrets dans les logs \u26a0\ufe0f Possible \u26a0\ufe0f Possible \u26a0\ufe0f Possible \u2705 Masqu\u00e9s Secrets envoy\u00e9s au LLM \u274c Oui \u274c Oui \u274c Oui \u2705 Jamais (r\u00e9f\u00e9rences) Stockage s\u00e9curis\u00e9 \u274c Variables env \u274c Variables env \u274c Fichier \u2705 Keyring OS D\u00e9tection plaintext \u274c Non \u274c Non \u274c Non \u2705 8 patterns Audit trail \u26a0\ufe0f Basique \u26a0\ufe0f Basique \u274c Minimal \u2705 SQLite + SIEM"},{"location":"fr/guides/secrets-security/#exemple-concret","title":"Exemple concret","text":""},{"location":"fr/guides/secrets-security/#ce-que-vous-tapez","title":"Ce que vous tapez :","text":"<pre><code>merlya&gt; Connecte-toi \u00e0 la base MySQL sur db-prod et liste les tables\n</code></pre>"},{"location":"fr/guides/secrets-security/#ce-que-le-llm-voit","title":"Ce que le LLM voit :","text":"<pre><code>User: Connecte-toi \u00e0 la base MySQL sur db-prod et liste les tables\nAssistant: Je vais demander les credentials MySQL puis lister les tables.\n\nTool call: request_credentials(service=\"mysql\", host=\"db-prod\")\nTool result: {\"username\": \"admin\", \"password\": \"@mysql:db-prod:password\"}\n\nTool call: ssh_execute(host=\"db-prod\", command=\"mysql -u admin -p @mysql:db-prod:password -e 'SHOW TABLES'\")\nTool result: {\n  \"stdout\": \"Tables_in_mydb\\nusers\\norders\\nproducts\",\n  \"command\": \"mysql -u admin -p *** -e 'SHOW TABLES'\"  // &lt;- Masqu\u00e9 !\n}\n</code></pre>"},{"location":"fr/guides/secrets-security/#ce-qui-est-execute-reellement","title":"Ce qui est ex\u00e9cut\u00e9 r\u00e9ellement :","text":"<pre><code>mysql -u admin -p 'MonVraiMotDePasse' -e 'SHOW TABLES'\n</code></pre>"},{"location":"fr/guides/secrets-security/#ce-qui-est-logge","title":"Ce qui est logg\u00e9 :","text":"<pre><code>[AUDIT] COMMAND_EXECUTED: mysql -u admin -p *** -e 'SHOW TABLES' on db-prod\n</code></pre> <p>Le mot de passe n'appara\u00eet nulle part sauf dans l'ex\u00e9cution r\u00e9elle de la commande.</p>"},{"location":"fr/guides/secrets-security/#verifier-le-statut-du-keyring","title":"V\u00e9rifier le statut du keyring","text":"<pre><code>Merlya&gt; /secrets\n</code></pre> <p>Affiche : <pre><code>\ud83d\udd10 Secret Store Status\n  Backend: keyring (macOS Keychain)\n  Stored secrets: 3\n    - mysql:db-prod:password\n    - ssh:bastion:passphrase\n    - api:monitoring:token\n</code></pre></p>"},{"location":"fr/guides/secrets-security/#mode-non-interactif-cicd","title":"Mode non-interactif (CI/CD)","text":"<p>En mode non-interactif, les secrets doivent \u00eatre fournis via variables d'environnement ou fichiers mont\u00e9s :</p> <pre><code># task.yaml\nsecrets:\n  DB_PASSWORD:\n    env: MYSQL_ROOT_PASSWORD\n  API_KEY:\n    file: /run/secrets/api_key\n</code></pre> <p>Merlya les charge dans le keyring au d\u00e9marrage, sans jamais les exposer au LLM.</p>"},{"location":"fr/guides/secrets-security/#audit-et-conformite","title":"Audit et conformit\u00e9","text":"<p>Chaque acc\u00e8s aux secrets est trac\u00e9 :</p> <pre><code>SELECT * FROM audit_logs\nWHERE event_type = 'secret_accessed'\nORDER BY created_at DESC;\n</code></pre> <pre><code>| id | event_type | action | target | created_at |\n|----|------------|--------|--------|------------|\n| a1 | secret_accessed | get | mysql:db-prod:password | 2024-12-16 10:23:45 |\n| a2 | secret_accessed | set | ssh:bastion:passphrase | 2024-12-16 10:22:30 |\n</code></pre> <p>Export SIEM : <pre><code>Merlya&gt; /audit export --format json --since 24h &gt; audit.json\n</code></pre></p>"},{"location":"fr/guides/secrets-security/#conclusion","title":"Conclusion","text":"<p>Les secrets sont la premi\u00e8re ligne rouge de tout agent IA d'infrastructure. Merlya impl\u00e9mente une architecture d\u00e9fense en profondeur avec 5 couches de protection :</p> <ol> <li>Stockage s\u00e9curis\u00e9 via le keyring OS</li> <li>R\u00e9f\u00e9rences au lieu de valeurs pour le LLM</li> <li>R\u00e9solution tardive uniquement \u00e0 l'ex\u00e9cution</li> <li>D\u00e9tection proactive des mots de passe en clair</li> <li>Sanitization automatique dans les logs</li> </ol> <p>Cette architecture garantit que m\u00eame si une couche \u00e9choue, les autres prot\u00e8gent vos secrets.</p> <p>Merlya est un agent IA CLI pour la gestion d'infrastructure, con\u00e7u avec la s\u00e9curit\u00e9 comme priorit\u00e9 absolue.</p> <p>Liens utiles : - Documentation compl\u00e8te - Guide SSH - Configuration</p> <ol> <li> <p>OpenHands : variables d'env document\u00e9es dans <code>openhands/ai/cilogger.py</code> (ligne 47), issues #234, #567 sur l'exposition des secrets\u00a0\u21a9</p> </li> <li> <p>Gemini CLI : stockage en plaintext confirm\u00e9 dans <code>gemini/core/config.py</code> (ligne 89), test <code>python -m gemini.cli --debug</code> (non v\u00e9rifi\u00e9)\u00a0\u21a9</p> </li> <li> <p>SHAI : fichier <code>~/.config/shai/secrets.json</code> cr\u00e9\u00e9 sans chiffrement, voir <code>shai/security/store.py</code> (ligne 23)\u00a0\u21a9</p> </li> </ol>"}]}